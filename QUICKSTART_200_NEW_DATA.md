# 快速开始：处理200条新责任数据

**目标：** 从Excel导入200条新责任数据，经过质量检查和AI修复，最终导入数据库并在Web界面审批。

**耗时：** 约2-3小时（手动填写payoutAmount约1.5小时）

---

## 📋 前置条件

- ✅ Excel文件准备好：`责任库导出-模版.xlsx`（疾病责任工作表，200条数据）
- ✅ 工具已整合：`tools/` 目录下的所有工具
- ✅ 数据库正常运行：Railway PostgreSQL
- ✅ Web界面可访问：http://localhost:5173

---

## 🚀 完整流程（7步）

### 步骤1：从Excel提取原文

```bash
cd /Users/hanyang/Desktop/保险解析助手/tools
python excel_to_raw_text.py --input ../责任库导出-模版.xlsx --sheet 疾病责任 --batch 16
```

**输出：**
- `原文条款/原文条款-批次16.md`（200条原文数据）

**检查点：**
- 序号范围正确（如：3001-3200）
- 数据量正确（200条）

---

### 步骤2：生成JSON模板

```bash
python 1_generate_batch.py --batch 16
```

**输出：**
- `解析结果/解析结果-批次16-序号3001-3200.json`

**说明：**
- 这是模板文件，payoutAmount等字段需要手动填写
- 模板中已包含序号、保单ID号、责任名称、责任原文

---

### 步骤3：手动填写payoutAmount ⏱️ **最耗时**

打开文件：`解析结果/解析结果-批次16-序号3001-3200.json`

参考文档：`数据标注规则库.md`

**填写示例：**

```json
{
  "序号": 3001,
  "保单ID号": "恒大人寿[2015]疾病保险160号",
  "责任名称": "特定少儿白血病重大疾病保险金",
  "责任原文": "从本合同生效日起180日后...",
  "payoutAmount": [
    {
      "stageNumber": 1,
      "period": "等待期后",
      "waitingPeriodStatus": "after",
      "ageConditions": [
        {
          "type": "确诊时",
          "limit": 14,
          "operator": "<="
        }
      ],
      "formula": "基本保额 * 100%",
      "naturalLanguageDescription": "等待期后、14周岁及以前确诊，按基本保额的100%赔付"
    }
  ],
  "note": "给付以1次为限"
}
```

**填写要点：**
- 严格按照数据标注规则库
- 每个stage必须有naturalLanguageDescription
- ageConditions的operator方向要正确（< 表示"前"，>= 表示"后"）
- formula格式规范（基本保额 * X%）

---

### 步骤4：质量检查

```bash
ts-node 2_check_quality.ts ../解析结果/解析结果-批次16-序号3001-3200.json
```

**输出：**
- 控制台显示问题清单，按P0/P1/P2分级
- P0：严重问题，必须修复
- P1：重要问题，建议修复
- P2：次要问题，可选修复

**示例输出：**

```
检查完成 - 发现 15 个问题

P0 问题 (2个):
  - 序号3001: formula格式错误
  - 序号3002: stage级别有note

P1 问题 (8个):
  - 序号3005: 缺少累计次数限制
  - 序号3010: 年龄operator方向错误
  ...

P2 问题 (5个):
  - 序号3020: 缺少交费期条件
  ...
```

**行动：**
- 如果有P0问题，返回步骤3修复
- 如果只有P1/P2问题，可以继续（AI会自动修复）

---

### 步骤5：AI自动修复

```bash
python 3_ai_reviewer.py --input ../解析结果/解析结果-批次16-序号3001-3200.json
```

**输出：**
- `解析结果-批次16-序号3001-3200_fix_report.json`（修复报告）
- `解析结果-批次16-序号3001-3200_fixed.json`（修复后数据，如有修复）

**修复报告示例：**

```json
{
  "input_file": "解析结果-批次16.json",
  "total_issues": 15,
  "fixes_applied": 12,
  "fixes": [
    {
      "issue": {
        "case_number": 3005,
        "severity": "P1",
        "type": "missing_cumulative_limit",
        "message": "原文有累计次数限制，但note中未体现"
      },
      "fix_applied": true,
      "fix_description": "已添加累计次数限制到note: 累计最多赔3次"
    }
  ]
}
```

**审查报告：**
- 检查AI修复的合理性
- 如果有不合理的修复，手动调整 `_fixed.json`

---

### 步骤6：应用修复

```bash
python 3_ai_reviewer.py --input ../解析结果/解析结果-批次16-序号3001-3200.json --auto-fix
```

**说明：**
- 这一步会应用所有修复，直接修改原JSON文件
- 确保步骤5审查无误后再执行

---

### 步骤7：导入数据库（追加模式）

```bash
# 如果有AI修复，使用修复报告
ts-node 4_import_db.ts --batch 16 --fix-report ../解析结果/解析结果-批次16-序号3001-3200_fix_report.json

# 如果没有AI修复
ts-node 4_import_db.ts --batch 16
```

**说明：**
- 默认追加模式，不会删除已有数据
- 如果提供了修复报告，会自动标记 `aiModified=true`
- 所有记录初始状态为 `reviewStatus=pending`

**输出：**

```
✅ 导入完成！
成功: 200 条
失败: 0 条
总计: 3079 条（数据库实际）
  - AI修改: 12 条
  - 待审核: 200 条

📝 下一步：在Web界面审批
   1. 打开: http://localhost:5173/coverage-library
   2. 筛选: AI修改=是, 审批状态=待审核
   3. 逐条审批，填写审批结果和备注
```

---

### 步骤8：Web界面审批 🖥️

1. **打开Web界面**

   访问：http://localhost:5173/coverage-library

2. **筛选新导入的数据**

   - 点击"AI修改"筛选器，选择"是"
   - 点击"审批状态"筛选器，选择"待审核"

3. **逐条审批**

   - 点击行右侧的"查看"按钮
   - 弹窗显示详情：
     - 责任原文
     - 解析结果JSON
     - AI修改说明（如有）
   - 审批信息编辑：
     - 选择审批结果：待审核/已通过/未通过
     - 填写审批备注（如：字段正确、公式有误等）
   - 点击"保存审批信息"

4. **批量审批（可选）**

   如果AI修复质量很高，可以考虑批量通过：
   - 先审查5-10个样本
   - 如果质量稳定，可以批量设置

---

## 📊 预期结果

```
数据库状态：
  - 总数：3079条（原2879 + 新200）
  - 新数据：200条（序号3001-3200）
  - AI修改：约12条（取决于原始数据质量）
  - 待审核：200条
  - 已审核：根据审批进度

责任库列表：
  - 可按序号、保单ID、责任类型筛选
  - 可按AI修改、审批状态筛选
  - 可查看每条数据的详细JSON
  - 可在线编辑审批信息
```

---

## ⚠️ 常见问题

### Q1: 导入时提示序号重复

**A**: 数据库中已存在3001-3200序号的数据。

**解决方案：**
- 检查是否之前测试导入过
- 如需重新导入，先删除这个范围的数据（暂无工具，需手动）
- 或使用不同的序号范围

### Q2: AI修复过多，质量不确定

**A**: 说明原始数据质量较低，或者规则过于严格。

**解决方案：**
- 审查修复报告，重点关注P0/P1问题
- 如果AI修复不合理，手动调整 `_fixed.json`
- 反馈给开发者优化修复逻辑

### Q3: Web界面审批太慢，能否批量审批？

**A**: 目前需要逐条审批。

**解决方案：**
- 优先审批AI修改过的数据（约12条）
- 未修改的数据质量较高，可快速通过
- 未来可考虑添加批量审批功能

### Q4: 导入后发现数据有误，如何修改？

**A**: 有两种方式：

**方式1：修改JSON后重新导入**
1. 修改 `解析结果-批次16-序号3001-3200.json`
2. 删除数据库中的3001-3200数据（暂无工具）
3. 重新导入

**方式2：在Web界面标记为"未通过"**
1. 审批结果选择"未通过"
2. 审批备注填写问题描述
3. 后续修复后重新审批

---

## 🎯 成功标志

完成以下所有步骤，即表示成功：

- ✅ 200条数据已导入数据库
- ✅ AI修改的数据已标记
- ✅ 所有数据已审批（或大部分已审批）
- ✅ 审批通过的数据可用于训练
- ✅ 审批未通过的数据已标记问题

---

**版本：** v3.0  
**更新日期：** 2026-02-01  
**预计耗时：** 2-3小时（含手动填写）
