# 保单年度识别模式库维护指南

## 📋 目的

建立一个**持续积累、不断完善**的保单年度表述识别模式库，确保随着数据处理的进行，识别率越来越高。

## 🎯 核心原则

1. **只增不减**：每次遇到新的表述方式，添加新模式，**不要删除或替换**旧模式
2. **从具体到宽泛**：模式顺序很重要，具体的模式放在前面，宽泛的放在后面
3. **记录示例**：每个模式都要记录实际遇到的示例文本
4. **测试驱动**：添加新模式后，必须运行测试确保不影响现有模式

## 📁 文件说明

- `policy_year_patterns_complete.ts` - 完整的模式库（核心文件）
- `POLICY_YEAR_PATTERNS_README.md` - 本文档
- `fix_missing_policy_year.ts` - 使用模式库的修复脚本

## 🔧 当前已有模式（10个）

### 1. 第X个保单周年日零时之前（明确标注"不含"）
- **正则**: `/第\s*([一二三四五六七八九十百0-9]+)\s*个?\s*(保单周年日|保险单周年日)\s*零时?\s*(之前|前)\s*[（(]\s*(不含|不包含)/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: false}`
- **示例**: 
  - "第30个保险单周年日零时之前（不含）"
  - "第10个保单周年日前（不含）"

### 2. 第X个保单周年日零时之前（无"不含"标注，按惯例为不含）
- **正则**: `/第\s*([一二三四五六七八九十百0-9]+)\s*个?\s*(保单周年日|保险单周年日)\s*零时\s*(之前|前)/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: false}`
- **示例**:
  - "第30个保险单周年日零时之前"
  - "第10个保单周年日零时前"

### 3. 第X个保单周年日零时以前（含）
- **正则**: `/第\s*([一二三四五六七八九十百0-9]+)\s*个?\s*(保单周年日|保险单周年日)\s*零时\s*以前/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: true}`
- **示例**:
  - "第30个保单周年日零时以前"

### 4. 第X个保障年度末（含）
- **正则**: `/第\s*([一二三四五六七八九十百0-9]+)\s*个?\s*保障年度\s*末/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: true}`
- **示例**:
  - "第15个保障年度末"

### 5. 至第X个保障年度末（含）
- **正则**: `/至\s*第\s*([一二三四五六七八九十百0-9]+)\s*个?\s*保障年度\s*[（(]?[^）)]*[）)]?\s*末/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: true}`
- **示例**:
  - "至第15个保障年度（释义9）末"

### 6. 第X个保单周年日前（含释义编号）
- **正则**: `/第\s*([一二三四五六七八九十百0-9]+)\s*个?\s*(保单周年日|保险单周年日)\s*\d+\s*零时?\s*(之前|前)/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: false}`
- **示例**:
  - "第三十个保单周年日7零时之前"
  - "第十个保险单周年日11零时之前"

### 7. 自第X个保单年度开始/起
- **正则**: `/自\s*第\s*([一二三四五六七八九十百0-9]+)\s*个?\s*保单年度\s*(开始|起)/`
- **结果**: `{start: X, startInclusive: true}`
- **示例**:
  - "自第二个保单年度开始"
  - "自第11个保单年度起"

### 8. 前X年
- **正则**: `/前\s*([一二三四五六七八九十百0-9]+)\s*年/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: true}`
- **示例**:
  - "前十年"
  - "前30年"

### 9. X个保单年度内
- **正则**: `/([一二三四五六七八九十百0-9]+)\s*个?\s*保单年度\s*内/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: true}`
- **示例**:
  - "三十个保单年度内"
  - "10个保单年度内"

### 10. 第X个保单周年日以前（纯中文数字）
- **正则**: `/第\s*(十|二十|三十|四十|五十)\s*个?\s*(保单周年日|保险单周年日)\s*(以前|之前|前)/`
- **结果**: `{start: 1, end: X, startInclusive: true, endInclusive: true}`
- **示例**:
  - "第十个保险单周年日以前"
  - "第二十个保单周年日前"

## ➕ 如何添加新模式

### 步骤1: 识别新的表述方式

当发现无法识别的保单年度表述时：

1. 记录完整的原文片段
2. 分析其语法结构
3. 确定应该提取的年度范围

### 步骤2: 添加新模式

在 `policy_year_patterns_complete.ts` 中，**在合适的位置**插入新模式：

```typescript
{
  name: '新模式的描述性名称',
  regex: /你的正则表达式/,
  extract: (match) => {
    const yearNum = chineseToNumber(match[1]);
    if (yearNum) {
      return { /* 返回合适的结构 */ };
    }
    return null;
  },
  examples: [
    '实际遇到的示例1',
    '实际遇到的示例2'
  ]
}
```

**注意顺序**：
- 更具体的模式放在前面
- 更宽泛的模式放在后面
- 避免宽泛的模式"吃掉"具体模式的匹配

### 步骤3: 添加测试用例

在 `testPatterns()` 函数中添加测试：

```typescript
const testCases = [
  // ... 现有测试用例
  { seq: XXX, text: '你的新示例文本' }
];
```

### 步骤4: 运行测试

```bash
npx ts-node policy_year_patterns_complete.ts
```

确保：
1. ✅ 新模式能正确识别新的表述
2. ✅ 现有模式的测试仍然通过
3. ✅ 没有意外的模式冲突

### 步骤5: 更新文档

在本文档的"当前已有模式"部分添加新模式的说明。

## 🧪 测试方法

### 方法1: 单元测试
```bash
npx ts-node policy_year_patterns_complete.ts
```

### 方法2: 实际数据测试
```typescript
import { extractPolicyYearRange } from './policy_year_patterns_complete';

const text = '你的原文';
const result = extractPolicyYearRange(text);
console.log(result);
```

## ⚠️ 常见陷阱

1. **模式顺序错误**: 宽泛的模式放在前面会导致具体模式无法匹配
2. **正则表达式贪婪匹配**: 注意使用非贪婪匹配 `*?` 或 `+?`
3. **忘记负向前瞻**: 如"之前"和"之前（不含）"需要用负向前瞻区分
4. **中文数字转换**: 确保 `chineseToNumber` 函数能处理新的数字表达

## 📊 当前识别率

- **已知表述方式**: 10种
- **测试覆盖率**: 8/8 ✅
- **实际应用**: 16/22条自动修复成功（72.7%）

## 🎯 下一步优化方向

1. **分段赔付识别**: 自动识别需要多阶段的情况（如"第1-10年X%，第11年起Y%"）
2. **条件嵌套识别**: 处理有前置条件的保单年度（如"投保年龄40岁以下时，第1-10年..."）
3. **复杂措辞**: 继续添加新的表述方式

## 📝 维护日志

| 日期 | 新增模式 | 说明 |
|------|---------|------|
| 2026-01-29 | 10个基础模式 | 初始版本，基于已处理的22条数据 |
| ... | ... | 持续更新 |

---

**记住**：每次遇到无法识别的保单年度表述，都是完善模式库的机会！
