# 数据质量工具维护指南

> **核心理念**：持续积累，不断完善，避免重复造轮子

---

## 📁 文件组织结构

### 【主力工具】（持续维护）

```
backend/
├── MASTER_QUALITY_CHECKER.ts    ← 主力检查工具（唯一的、持续维护的）
├── MASTER_FIX_TOOL.ts           ← 主力修复工具（待创建）
└── policy_year_patterns_complete.ts  ← 保单年度模式库（已建立）
```

**使用原则**：
- ✅ 每次发现新问题模式，必须添加到主力工具中
- ✅ 不要创建新的临时检查/修复脚本
- ✅ 如果某个问题无法自动修复，在工具中标记为"需人工处理"

### 【模式库】（只增不减）

```
backend/
├── policy_year_patterns_complete.ts      ← 保单年度识别模式库
├── POLICY_YEAR_PATTERNS_README.md       ← 保单年度模式库维护文档
└── [将来可添加]
    ├── age_condition_patterns.ts         ← 年龄条件识别模式库
    ├── waiting_period_patterns.ts        ← 等待期识别模式库
    └── formula_patterns.ts               ← 赔付公式识别模式库
```

**维护原则**：
- ✅ 只增不减（除非模式被明确废弃）
- ✅ 从具体到宽泛排序
- ✅ 每个模式必须有示例
- ✅ 测试驱动添加

### 【临时脚本】（执行后可归档）

```
backend/
├── archive/                              ← 归档目录（可选）
│   ├── fix_seq835_xxx.ts                ← 一次性修复脚本
│   └── check_specific_issue.ts          ← 临时调试脚本
```

**何时可以写临时脚本**：
- ✅ 特殊的、不具备通用性的修复（如修复某个序号的特定问题）
- ✅ 调试/验证脚本
- ❌ 通用的错误检查（应添加到主力工具）
- ❌ 批量修复相同类型问题（应添加到主力工具）

---

## 🔧 主力工具使用流程

### 1. 日常检查流程（推荐）

```bash
# 每次导入新数据后，或每日定期检查
cd coverage-parser/backend

# 1. 运行主力检查工具
npx ts-node MASTER_QUALITY_CHECKER.ts

# 2. 根据报告决定修复方案：
#    - P0问题：必须修复
#    - P1问题：应该修复
#    - P2问题：建议修复

# 3. 运行主力修复工具（自动修复能修的）
npx ts-node MASTER_FIX_TOOL.ts --severity P0,P1

# 4. 再次检查，确认问题已解决
npx ts-node MASTER_QUALITY_CHECKER.ts
```

### 2. 发现新问题时的处理流程

**场景A：发现新的错误模式**

```
1. 用户反馈："序号XXX的年龄限制识别错误"
2. AI分析：这是一个"年龄数值从中文数字转换错误"的问题
3. AI操作：
   ✅ 打开 MASTER_QUALITY_CHECKER.ts
   ✅ 在"类别2：年龄条件问题"下添加新的检查函数
   ✅ 更新文件顶部的"检查项清单"
   ✅ 测试新检查规则
   ✅ 更新 数据质量检查与修复工作日志.md
```

**场景B：发现新的识别模式（如保单年度新表述）**

```
1. 用户反馈："序号XXX的保单年度未识别"
2. AI分析：原文使用了新的表述"第X个保单年度末"
3. AI操作：
   ✅ 打开 policy_year_patterns_complete.ts
   ✅ 添加新模式到 POLICY_YEAR_PATTERNS 数组
   ✅ 添加示例
   ✅ 测试
   ✅ 更新 POLICY_YEAR_PATTERNS_README.md
```

**❌ 错误做法**：
```
1. 用户反馈问题
2. AI直接写一个 fix_new_issue.ts
3. 修复完成
4. 文件留在backend目录，不再使用
```

---

## 📊 主力检查工具架构

### MASTER_QUALITY_CHECKER.ts 结构

```typescript
/**
 * 主力质量检查工具
 * 
 * 【重要】这是唯一的、持续维护的综合检查工具
 */

// ============ 检查项清单（持续更新） ============
// 类别1：赔付公式问题
// 类别2：年龄条件问题
// 类别3：保单年度问题
// ... 更多类别

// ============ 检查函数（每个类别一个） ============
function checkFormulaIssues(record, issues) { ... }
function checkAgeConditionIssues(record, issues) { ... }
function checkPolicyYearIssues(record, issues) { ... }
// ... 更多检查函数

// ============ 主函数 ============
async function masterQualityCheck() {
  // 1. 获取所有待审核记录
  // 2. 遍历每条记录
  // 3. 调用所有检查函数
  // 4. 生成报告
}
```

### 添加新检查规则的步骤

1. **更新检查项清单**（文件顶部）
   ```typescript
   // 【类别X：新问题类别】
   // ✅ X.1 具体问题描述
   // ✅ X.2 另一个问题描述
   ```

2. **创建检查函数**
   ```typescript
   function checkNewIssueCategory(record: any, issues: QualityIssue[]) {
     // 检查逻辑
     if (发现问题) {
       issues.push({
         category: '新问题类别',
         type: '具体问题类型',
         sequenceNumber: record.sequenceNumber,
         details: '问题详情',
         suggestedFix: '修复建议',
         severity: 'P0' | 'P1' | 'P2'
       });
     }
   }
   ```

3. **在主函数中调用**
   ```typescript
   async function masterQualityCheck() {
     // ... 其他代码
     checkNewIssueCategory(record, issues);
   }
   ```

---

## 🛠️ 主力修复工具架构（待创建）

### MASTER_FIX_TOOL.ts 结构（规划）

```typescript
/**
 * 主力修复工具
 * 
 * 【重要】这是唯一的、持续维护的综合修复工具
 */

// ============ 修复函数（每个类别一个） ============
function fixFormulaIssues(record, issue) { ... }
function fixAgeConditionIssues(record, issue) { ... }
// ... 更多修复函数

// ============ 修复策略注册表 ============
const FIX_STRATEGIES = {
  'formula为0或空': {
    canAutoFix: true,
    fix: fixFormulaZero
  },
  '年龄条件互斥': {
    canAutoFix: true,  // 需要原文辅助判断
    fix: fixAgeConflict
  },
  '保单年度缺失': {
    canAutoFix: true,
    fix: fixMissingPolicyYear
  }
  // ... 更多策略
};

// ============ 主函数 ============
async function masterFixTool(options) {
  // 1. 运行MASTER_QUALITY_CHECKER获取问题清单
  // 2. 根据options.severity筛选问题
  // 3. 对每个问题，查找修复策略
  // 4. 执行修复
  // 5. 记录修复日志
}
```

---

## 📝 日志文档维护

### 数据质量检查与修复工作日志.md

**结构**：
```markdown
# 数据质量检查与修复工作日志

## 2026-01-29 - 初始修复
- 修复XX问题，涉及XX条记录
- 创建XX工具

## 2026-01-30 - 追加修复
- 修复XX问题，涉及XX条记录
- 扩展XX工具，新增XX检查规则

## [持续追加...]
```

**更新原则**：
- ✅ 每次修复工作结束后追加一个日期章节
- ✅ 记录修复了哪些问题、涉及多少记录
- ✅ 记录工具的改进和新增规则
- ✅ 记录新发现的模式和经验
- ❌ 不要创建新的总结文档

---

## 🎯 质量标准

### 主力工具必须满足

- ✅ **覆盖所有已知问题模式**
- ✅ **检查规则清晰可维护**
- ✅ **提供修复建议**
- ✅ **按严重程度分类**
- ✅ **输出清晰的报告**

### 代码质量要求

- ✅ **每个检查函数独立**（便于单独测试和维护）
- ✅ **清晰的注释和文档**
- ✅ **合理的函数命名**（check{Category}Issues）
- ✅ **统一的数据结构**（QualityIssue接口）

---

## 🔄 持续改进流程

```
发现新问题
    ↓
分析问题根因
    ↓
判断是否通用
    ↓
    ├─→ 通用问题 → 添加到主力工具
    ├─→ 识别模式 → 添加到模式库
    └─→ 特殊问题 → 写临时脚本（归档）
    ↓
测试验证
    ↓
更新日志文档
    ↓
下次遇到相同问题 → 工具自动发现 ✅
```

---

## 🚫 反模式（不要这样做）

### ❌ 反模式1：每次写新脚本

```bash
# 不好的做法
fix_seq123_age_issue.ts
fix_seq456_policy_year.ts
fix_seq789_formula.ts
... 174个脚本 ...
```

**正确做法**：把共性问题抽象成检查规则，添加到主力工具

### ❌ 反模式2：依赖用户提问题

```
用户："序号123有问题"
AI："好的，我检查一下"
AI："发现问题，已修复"
（其他99个相同问题没发现）
```

**正确做法**：主动运行主力检查工具，覆盖所有记录

### ❌ 反模式3：不更新日志

```
修复完成 → 继续下一个任务
（过了一周）
用户："上次修复了什么来着？"
AI："额...我找找..."
```

**正确做法**：每次修复后立即更新工作日志

---

## 📅 定期维护任务

### 每周

- [ ] 清理backend目录，归档临时脚本
- [ ] 检查主力工具是否需要优化
- [ ] 更新README文档

### 每月

- [ ] 回顾工作日志，总结常见问题模式
- [ ] 评估哪些P2问题可以升级为P1
- [ ] 考虑是否需要新的模式库

---

## 🎓 最佳实践

1. **Think before you code**: 发现问题先想是否已有工具可用
2. **Don't Repeat Yourself**: 相似的检查逻辑应该复用
3. **Document as you go**: 边做边记录，不要事后补
4. **Test with real data**: 每个新规则都要用实际数据测试
5. **Communicate clearly**: 修复建议要清晰，便于手工修复

---

**记住**：我们的目标是建立一个**越来越聪明**的工具体系，而不是写越来越多的临时脚本。

---

## 🔄 工具升级记录

### v1.6 (2026-01-30) ⭐⭐⭐⭐ 多阶段检查全面收严
**目标**：减少“需要拆分阶段”“多阶段赔付少识别”误判，工具可在大批责任上自动识别，无需每次人工告知。

**类别4 阶段拆分**：
- (1)(2)排除：多次赔付、条件列举（满足以下/在下列情况下）、疾病/责任列举（为：/如下：/下列：+（1））、等待期场景（（1）如果（2）如果+等待期且无年龄/保单年度）；
- 整条责任为“第二次/再次”类时，不再报需要拆分（避免328等误判）；
- 年龄分段：必须“前给付+后给付”且无“不承担/不再承担”；保单年度：排除持续给付语境。

**类别7.3 / 7.4**：同上；7.4 不承担→增加“不再承担”。

**单阶段名称排除**：责任名称即「X周岁前首次…给付保险金」时，就一个阶段（文中多次出现X岁来自名称/列举），不报拆分（579、739误判修复）。

**结果**：阶段拆分 49→9，多阶段少识别 11→7；561 保留（可分多阶段）。与您判断不一致的仅 561/579/739，已按您结论修正。

### 年龄条件问题（2026-01-30）
**年龄数值可能错误**：
- 真实错误（保留报出）：139, 386, 394, 398, 401。
- 误判排除：180, 276, 493, 546, 574, 592（用户确认年龄正确，原文表述未被当前提取规则覆盖）。
- 其它问题类型排除：618/547（少性别限制）、653/655（应赔付基本保额却写成已交保费）、622/637/638（两个一样年龄限制重复）。
- 年龄提取扩展：支持「X岁」「中文+岁」，减少漏提。

**用户确认均为真实问题**：赔付限额未识别(279,488,747)、保单年度缺失(105)、交费期未在描述中体现(104)、持续给付未结构化(106,268,280,337,403,404,405)。

### 批量修复记录 (2026-01-30)
**修复总结**：33个问题全部修复完成（50个问题→0个问题）

**Level 1 自动修复（10个）**：
- 年龄条件重复：622, 637, 638（第一次运行时已修复）
- 交费期描述：104（第一次运行时已添加）
- 赔付类型错误：653, 655（阶段顺序交换，阶段1改为基本保额）
- 年龄数值错误：139（删除错误的年龄条件）、386（18→22）、398（70→75）、401（70→65）、394（18→22）
- 赔付限额：279, 488, 747（自动添加cumulativeLimit: 100000元）
- 性别限制：547（添加性别条件note）
- 持续给付改结构：106, 268, 280, 337, 403, 404, 405（改用payoutStructure）

**Level 2 多阶段拆分（10个）**：
- 保单年度拆分：202（第2年、第3年+），105（第1-10年、第11年+）
- 年龄分段拆分：568（60岁前后）、435（18岁前后）、500（18岁前后）、522（25岁前后）、159（18岁前后+附表不同）
- 复杂拆分：559（等待期内、65岁前、65岁后）、561（等待期内疾病、85岁前、85岁后）、120（第1年非意外、第2年起）

**核心原则落实**：每次修改字段后，自动调用 regenerateDescription() 更新自然语言描述，确保描述与结构一致。

**年龄条件重复**：新增检查 2.8——同一阶段内 type、limit、operator 完全相同的两条年龄条件报「年龄条件重复」（如 622、637、638）。修复建议：删除重复条件，或若为不同对象（男性/女性/孩子）且赔付标准相同可合并在一个阶段内描述。

**同一赔付标准可放一阶段**：若多个条件（如男性X岁前、孩子Y岁前、女性Z岁前）赔付标准相同（如均为基本保额×20%），可放在一个阶段内，不必拆成多阶段。

### v1.5 (2026-01-30) ⭐⭐⭐ 多阶段赔付精准识别
**核心成果**：
- ✅ 多阶段赔付：从8个误报降到2个真实问题（202✅, 559✅）
- ✅ 持续给付识别：546正确识别为持续给付（分三次给付）
- ✅ 年龄分段检查：新增真实年龄分段识别（每段都有赔付）
- ✅ 总问题数：94个（P0=0, P1=90, P2=4）

**多阶段判断优化**：
1. **保单年度检查**：排除"第X次确诊"（多次赔付）、"第X项"（条款编号）、持续给付案例
2. **年龄分段检查**：识别真实的年龄分段赔付（如65周岁前后不同赔付）
3. **关键判断**：每个年龄段都有赔付 vs 一个段有赔付、另一个段"不承担责任/不赔付"

**排除规则**：
- ❌ 年龄限制（不赔付）："X周岁之前...不承担责任/不赔付/则责任终止"
- ❌ 多次赔付："第一次确诊...第二次确诊"
- ❌ 持续给付："分三次给付...每次XX%"
- ✅ 真实分段：每个年龄段/年度都有明确的赔付金额

**用户校准案例**：
- 109, 219, 229, 328等：年龄限制，不需要拆分 ❌
- 202：保单年度分段（第2年2倍，第3年5倍）✅
- 546：持续给付（分三次给付）✅
- 559：年龄分段（65周岁前后不同赔付）✅

### v1.4 (2026-01-30) ⭐⭐ 持续给付精准识别
**核心成果**：
- ✅ 持续给付识别率：100%（用户8个标准案例全部正确）
- ✅ 持续给付误判率：从98.4%降到0%
- ✅ 总问题数：从146降到91

**持续给付定义澄清**：
- ✅ **持续给付**：一次确诊后，基于同一次确诊持续给付（如每年对应日）
- ❌ **非持续给付**：多次确诊、每种疾病给付一次、相邻两次确诊

**优化规则**：
1. 排除"相邻两次确诊"（如序号247）
2. 排除"每种疾病给付"（如序号488）
3. 排除"同一种给付一次为限"（多次赔付）
4. 移除continuousPayment字段判断（只检查payoutStructure）
5. 移除"多次赔付次数检查"（不属于赔付金额结构范围）

**用户明确**：
- 多次确诊多次赔付 ≠ 持续给付
- 持续给付必须用payoutStructure结构

### v1.3 (2026-01-30) ⭐ 重大优化版本
**误判修复成果**：
- ✅ 总问题从384降到146（减少62.5%）
- ✅ P0问题从1降到0（100%解决）
- ✅ 修复7个误判规则类型

**修复清单**：
1. **中文数字转换bug**："十八"→18，"二十"→20（特殊处理常见数字）
2. **年龄类型检查**：必须检查年龄限制的具体对象，不能简单看是否出现"确诊时"
3. **交费期检查**：排除豁免条件中的交费期（不是赔付条件）
4. **阶段拆分判断**：更精确的正则，避免"第11...第一次"误判
5. **多阶段赔付判断**：必须是不同年度数字，避免"第20...第20"误判
6. **formula检查**：有payoutStructure时formula为undefined是正常的（持续给付结构）
7. **年龄提取**：排除括号内重复内容，如"30周岁（含30岁）"

**用户反馈修正**：
- 序号338有payoutStructure，formula为undefined是正常的
- 括号内数字是重复说明，不应重复提取

### v1.2 (2026-01-30)
**核心修复**：
- ✅ **年龄运算符误报修复**：从216个P2误报降至5个（减少97.7%）
  - 单数字句子：看整个句子最后的方向词
  - 多数字句子：每个数字只看到下一个数字之前的方向词
  - 成功避免误判："年满20周岁但未满60周岁"

**新增功能**：
- 交费期条件未在naturalLanguageDescription中体现的检查（P1）

**用户明确要求**：
- ⚠️ 如果检查到approved记录有问题，必须立即通知用户
- ⚠️ 不生成MD总结报告，只维护错误清单和升级工具

### v1.1 (2026-01-30)
**新增功能**：
1. 中文数字识别（一、二、三...十）
2. 多阶段赔付识别（检测"第2年...第3年"）
3. 赔付限额识别（检测"最高XX万元"）
4. 交费期字段检查

**范围调整**：
- 移除note内容检查（专注赔付结构）
- 工具定位为"赔付金额结构检查工具"

### v1.0 (2026-01-30)
**初始版本**：
- 整合所有已知检查规则
- 8大类检查项
- P0/P1/P2严重程度分级
