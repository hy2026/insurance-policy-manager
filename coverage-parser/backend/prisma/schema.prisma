// Coverage Parser 独立数据库
// 使用PostgreSQL（与zhichu1一致，便于后期共享数据库）
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表（简化版）
model User {
  id                      Int                       @id @default(autoincrement())
  email                   String                    @unique
  name                    String?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  insurancePoliciesParsed InsurancePolicyParsed[]

  @@map("users")
}

// 保险产品库（系统预置）
model InsuranceProduct {
  id                  Int      @id @default(autoincrement())
  
  // 基本信息（对应Excel列）
  policyId            String?  @unique // 保险产品ID号（如：粤寿保险约字[2009]年金保险013号）
  insuranceCompany    String   // 公司名称
  productName         String   // 保险产品名称
  productCategory     String?  // 保险大类：人寿险/疾病险/意外险/年金险
  productSubCategory  String?  // 保险小类：重大疾病保险/定期寿险/etc
  coveragePeriod      String?  // 保障期限：1年/终身/至XX岁
  paymentPeriod       String?  // 交费期限：1年/10年/20年
  salesStatus         String   @default("在售") // 销售状态：在售/停售/停用
  
  // 责任统计
  diseaseCount        Int?     // 疾病责任数
  deathCount          Int?     // 身故责任数
  accidentCount       Int?     // 意外责任数
  annuityCount        Int?     // 年金责任数
  
  // 旧字段（保留兼容）
  policyType          String   // 重疾险/人寿险/意外险/年金险（从productCategory映射）
  policyDocumentId    String?  // 保单文件编号（与policyId可以相同）
  approvalDate        DateTime? @db.Date // 合同审批上架时间
  
  productInfo         Json?    // 产品基础信息（扩展字段）
  coverages           Json?    // 责任列表（预置）
  
  isActive            Boolean  @default(true)
  verified            Boolean  @default(false) // 是否已审核（保留兼容）
  
  // 数据来源
  source              String   @default("imported") // imported=Excel导入 | auto_generated=责任库自动生成
  
  // 审核信息（新）
  reviewStatus        String   @default("pending") // pending/approved/rejected
  reviewNotes         String?  @db.Text // 审核备注
  reviewedBy          String?  // 审核人
  reviewedAt          DateTime? // 审核时间
  
  trainingStatus      String   @default("pending") // pending/annotated/trained/deployed
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // 关联到责任库
  coverageDetails     InsuranceCoverageLibrary[]

  @@index([policyId])
  @@index([insuranceCompany])
  @@index([productCategory])
  @@index([salesStatus])
  @@index([trainingStatus])
  @@map("insurance_product_library")
}

// 客户保单（解析后的保单）
model InsurancePolicyParsed {
  id               Int      @id @default(autoincrement())
  userId           Int
  policyNumber     String?
  insuranceCompany String
  productName      String
  policyType       String // 重疾险/人寿险/意外险/年金险
  entity           String // 主体：本人/配偶/孩子
  insuredPerson    String
  policyHolder     String?
  beneficiary      String?
  policyStartYear  Int
  birthYear        Int?
  basicSumInsured  Float?
  annualPremium    Float?
  paymentType      String?
  paymentPeriod    Int?
  coverageEndYear  Int?
  coverages        Json? // 责任列表（Json格式）
  source           String? // manual/library
  verified         Boolean  @default(false)
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, entity])
  @@index([userId, policyType])
  @@index([userId, entity, policyType])
  @@index([policyNumber])
  @@map("insurance_policies_parsed")
}

// 责任库（产品的具体责任，用于训练）
model InsuranceCoverageLibrary {
  id                  Int       @id @default(autoincrement())
  
  // 关联产品
  productId           Int?
  product             InsuranceProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  // 责任分类
  coverageType        String    // 疾病责任/身故责任/意外责任/年金责任/满期责任/生存金/其他
  coverageName        String
  isRequired          String    @default("可选") // 可选/必选
  diseaseCategory     String?   // 重症/中症/轻症/特殊疾病/其他（仅疾病责任）
  
  // 原文和解析结果
  clauseText          String    @db.Text // 原文片段
  parsedResult        Json?     // 解析后的结构化数据（包含keyAmounts等）
  
  // 解析元数据
  parseMethod         String    @default("llm") // manual/llm/rule/hybrid
  confidenceScore     Float?    // 置信度（0-1）
  verified            Boolean   @default(false) // 是否已人工审核（保留兼容）
  
  // 审核信息（新）
  reviewStatus        String    @default("pending") // pending/approved/rejected
  reviewNotes         String?   @db.Text // 审核备注
  reviewedBy          String?   // 审核人
  reviewedAt          DateTime? // 审核时间
  
  // 旧字段（保留兼容）
  verifiedBy          String?
  verifiedAt          DateTime?
  
  // 训练数据标注
  isTrainingSample    Boolean   @default(false) // 是否作为训练样本
  annotationQuality   String?   // high/medium/low
  
  // 快速查询字段（从parsedResult中提取，用于提升查询性能）
  policyIdNumber       String?   // 保单ID号（从parsedResult中提取）
  sequenceNumber       Int?      // 序号（从parsedResult中提取）
  payoutCount          String?   // "1次" | "最多3次" | null (null表示一次赔付不涉及)
  isRepeatablePayout   Boolean?  // true | false | null (null表示一次赔付不涉及)
  isGrouped            Boolean?  // true | false | null (null表示一次赔付不涉及)
  intervalPeriod       String?   // "间隔180日" | "" (空字符串表示无间隔期) | null
  isPremiumWaiver      Boolean   @default(false) // 是否豁免
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([productId])
  @@index([coverageType])
  @@index([isTrainingSample, verified])
  @@index([policyIdNumber])
  @@index([sequenceNumber])
  @@index([payoutCount])
  @@index([isRepeatablePayout])
  @@index([isGrouped])
  @@index([isPremiumWaiver])
  @@map("insurance_coverage_library")
}

// 解析规则库
model ParsingRule {
  id          Int      @id @default(autoincrement())
  ruleType    String // payoutAmount/payoutCount/intervalPeriod...
  pattern     String   @db.Text
  extraction  Json
  priority    Int      @default(0)
  enabled     Boolean  @default(true)
  usage       Int      @default(0)
  successRate Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ruleType, enabled])
  @@index([priority])
  @@map("parsing_rules")
}

// 训练数据导出记录
model TrainingExport {
  id                  Int       @id @default(autoincrement())
  
  exportVersion       String    // 导出版本号（如：v1.0, v2024-01-06）
  exportType          String    @default("full") // full/incremental
  
  // 统计信息
  totalSamples        Int
  verifiedSamples     Int
  coverageBreakdown   Json?     // 责任类型分布
  
  // 文件信息
  filePath            String?
  fileSizeKb          Int?
  
  // 智谱平台信息
  zhipuJobId          String?   // 智谱训练任务ID
  zhipuModelId        String?   // 训练后的模型ID
  trainingStatus      String    @default("exported") // exported/uploaded/training/completed/failed
  
  exportedBy          String?
  exportedAt          DateTime  @default(now())

  @@index([exportVersion])
  @@index([trainingStatus])
  @@map("training_exports")
}

