/**
 * ==================== Period è§„èŒƒåŒ–æœåŠ¡ ====================
 * èŒè´£ï¼šå°†å¤§æ¨¡å‹è¿”å›çš„å„ç§periodè¡¨è¿°ç»Ÿä¸€è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
 * 
 * ç›®æ ‡ï¼šé¿å…åç«¯æ­£åˆ™æ— æ³•åŒ¹é…å„ç§åŒä¹‰è¡¨è¾¾
 */

export class PeriodNormalizer {
  /**
   * è§„èŒƒåŒ–periodå­—ç¬¦ä¸²
   * @param period åŸå§‹periodå­—ç¬¦ä¸²
   * @returns è§„èŒƒåŒ–åçš„periodå­—ç¬¦ä¸²
   */
  static normalize(period: string): string {
    if (!period) return period;
    
    let normalized = period;
    
    // ========================================
    // 1. ä¿å•å¹´åº¦ç›¸å…³è§„èŒƒåŒ–
    // ========================================
    
    // "ç¬¬Nä¿å•å¹´åº¦åŠä»¥å‰" â†’ "ç¬¬1-Nä¿å•å¹´åº¦"
    normalized = normalized.replace(
      /ç¬¬\s*(\d+)\s*ä¸ª?ä¿å•å¹´åº¦\s*(?:åŠ)?(?:ä»¥å‰|ä¹‹å‰|åŠä»¥ä¸‹)/g,
      'ç¬¬1-$1ä¿å•å¹´åº¦'
    );
    
    // "ç¬¬Nä¿å•å¹´åº¦åŠä»¥å" â†’ "ç¬¬Nä¿å•å¹´åº¦èµ·"
    normalized = normalized.replace(
      /ç¬¬\s*(\d+)\s*ä¸ª?ä¿å•å¹´åº¦\s*(?:åŠ)?(?:ä»¥å|ä¹‹å|åŠä»¥ä¸Š|ä»¥ä¸Š)/g,
      'ç¬¬$1ä¿å•å¹´åº¦èµ·'
    );
    
    // "ç¬¬Nä¿å•å¹´åº¦ä¹‹å" â†’ "ç¬¬Nä¿å•å¹´åº¦èµ·"
    normalized = normalized.replace(
      /ç¬¬\s*(\d+)\s*ä¸ª?ä¿å•å¹´åº¦ä¹‹å/g,
      'ç¬¬$1ä¿å•å¹´åº¦èµ·'
    );
    
    // ========================================
    // 2. å¹´é¾„ç›¸å…³è§„èŒƒåŒ–
    // ========================================
    
    // "æ»¡18å‘¨å²" â†’ "å¹´æ»¡18å‘¨å²"
    normalized = normalized.replace(
      /(?<![å¹´æœªä¸])(æ»¡\s*\d+\s*(?:å‘¨å²|å²))/g,
      'å¹´$1'
    );
    
    // "18å‘¨å²ä»¥å‰" â†’ "æœªæ»¡18å‘¨å²"
    normalized = normalized.replace(
      /(\d+)\s*(?:å‘¨å²|å²)\s*(?:ä»¥å‰|ä¹‹å‰)/g,
      'æœªæ»¡$1å‘¨å²'
    );
    
    // "18å‘¨å²ä»¥å" â†’ "å¹´æ»¡18å‘¨å²"
    normalized = normalized.replace(
      /(\d+)\s*(?:å‘¨å²|å²)\s*(?:ä»¥å|ä¹‹å)/g,
      'å¹´æ»¡$1å‘¨å²'
    );
    
    // ========================================
    // 3. ç¼´è´¹æœŸç›¸å…³è§„èŒƒåŒ–
    // ========================================
    
    // "äº¤è´¹å®Œæˆå" â†’ "äº¤è´¹æœŸæ»¡å"
    normalized = normalized.replace(/äº¤è´¹å®Œæˆå/g, 'äº¤è´¹æœŸæ»¡å');
    normalized = normalized.replace(/ç¼´è´¹å®Œæˆå/g, 'äº¤è´¹æœŸæ»¡å');
    
    // "ç¼´è´¹" â†’ "äº¤è´¹"ï¼ˆç»Ÿä¸€ç”¨è¯ï¼‰
    normalized = normalized.replace(/ç¼´è´¹/g, 'äº¤è´¹');
    
    // ========================================
    // 4. ç­‰å¾…æœŸç›¸å…³è§„èŒƒåŒ–
    // ========================================
    
    // "ç­‰å¾…æœŸè¿‡å" â†’ "ç­‰å¾…æœŸå"
    normalized = normalized.replace(/ç­‰å¾…æœŸè¿‡å/g, 'ç­‰å¾…æœŸå');
    normalized = normalized.replace(/ç­‰å¾…æœŸä¹‹å/g, 'ç­‰å¾…æœŸå');
    
    // è®°å½•è§„èŒƒåŒ–ç»“æœ
    if (normalized !== period) {
      console.log(`ğŸ“ [è§„èŒƒåŒ–] "${period}" â†’ "${normalized}"`);
    }
    
    return normalized;
  }
  
  /**
   * æ‰¹é‡è§„èŒƒåŒ–tiers
   */
  static normalizeTiers(tiers: any[]): any[] {
    if (!tiers || !Array.isArray(tiers)) {
      return tiers;
    }
    
    return tiers.map(tier => {
      if (tier.period) {
        return {
          ...tier,
          period: this.normalize(tier.period)
        };
      }
      return tier;
    });
  }
}

