# 责任库架构优化方案

## 当前问题

1. **性能问题**：每次查询都要从 JSON 中提取字段，或重新调用 HardRuleParser
2. **重复计算**：同样的解析逻辑在保存和查询时都要执行
3. **查询慢**：3000条数据查询时，每条都要解析

## 优化方案

### 方案A：字段直接入库（推荐）

**优点：**
- 查询性能大幅提升（直接读列，无需解析）
- 可以建立索引，支持高效筛选
- 数据更清晰，便于维护

**缺点：**
- 需要数据库迁移
- 字段冗余（JSON 中也有，列中也有）

**实现步骤：**

1. **数据库迁移**：在 `InsuranceCoverageLibrary` 表中添加列
   ```prisma
   // 赔付相关字段
   payoutCount          String?   // "1次" | "最多3次" | null
   isRepeatablePayout  Boolean?  // true | false | null (null表示"一次赔付不涉及")
   isGrouped           Boolean?  // true | false | null (null表示"一次赔付不涉及")
   intervalPeriod      String?   // "间隔180日" | "" (空字符串表示无间隔期) | null
   isPremiumWaiver     Boolean   @default(false) // 是否豁免
   ```

2. **保存时解析**：在 `create` 和 `importFromJson` 时解析并写入
   ```typescript
   // 在保存时，从 parsedResult 或 note 中提取字段
   const hardRuleFields = HardRuleParser.parseAdditionalFields(note || clauseText);
   // 转换为数据库列格式
   const payoutCount = formatPayoutCount(hardRuleFields.payoutCount);
   const isRepeatablePayout = formatRepeatablePayout(hardRuleFields);
   // ... 保存到数据库
   ```

3. **查询优化**：直接读取列，移除 `enrichCoverageData` 的解析逻辑
   ```typescript
   // 查询时直接返回列值
   return {
     ...item,
     赔付次数: item.payoutCount || '1次',
     是否可以重复赔付: item.isRepeatablePayout,
     // ...
   };
   ```

### 方案B：缓存解析结果（备选）

**优点：**
- 不需要数据库迁移
- 实现简单

**缺点：**
- 仍然需要解析 JSON
- 无法建立索引

**实现：**
- 在 `parsedResult` 中确保包含解析后的字段
- 查询时直接从 `parsedResult` 读取，不再调用 HardRuleParser

## 推荐方案

**推荐方案A**，原因：
1. 性能提升明显（查询快10倍以上）
2. 可以建立索引，支持高效筛选
3. 数据更清晰，便于后续扩展

## 迁移计划

1. **阶段1**：添加数据库列（允许 null）
2. **阶段2**：修改保存逻辑，同时写入列和 JSON
3. **阶段3**：数据迁移脚本，为现有数据填充列
4. **阶段4**：修改查询逻辑，直接读取列
5. **阶段5**：移除 `enrichCoverageData` 中的解析逻辑

## 字段映射

| 显示字段 | 数据库列 | 类型 | 说明 |
|---------|---------|------|------|
| 赔付次数 | payoutCount | String? | "1次" \| "最多3次" |
| 是否可以重复赔付 | isRepeatablePayout | Boolean? | true \| false \| null (null=一次赔付不涉及) |
| 是否分组 | isGrouped | Boolean? | true \| false \| null (null=一次赔付不涉及) |
| 间隔期 | intervalPeriod | String? | "间隔180日" \| "" (空=无间隔期) \| null |
| 是否豁免 | isPremiumWaiver | Boolean | true \| false |


