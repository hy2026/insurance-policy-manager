<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿å•æ™ºèƒ½å½•å…¥è§£æåŠ©æ‰‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .header {
      background: white;
      color: #333;
      padding: 30px 30px 20px 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 0;
      color: #333;
    }
    
    .back-button {
      position: absolute;
      left: 30px;
      top: 50%;
      transform: translateY(-50%);
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      display: none;
      transition: all 0.3s;
      text-decoration: none;
    }
    
    .back-button:hover {
      background: #e8e8e8;
      border-color: #5FC8D4;
      color: #5FC8D4;
    }
    
    .back-button::before {
      content: 'â† ';
      margin-right: 4px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    @media (max-width: 968px) {
      .content {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 2px solid #9FE8ED;
    }

    .section h2 {
      color: #5FC8D4;
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #5FC8D4;
    }

    textarea {
      width: 100%;
      min-height: 300px;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      resize: vertical;
      transition: border-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #5FC8D4;
      box-shadow: 0 0 0 3px rgba(95, 200, 212, 0.15);
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      min-width: 120px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #5FC8D4 0%, #7FD4E0 100%);
      color: white;
      border: 2px solid #5FC8D4;
      font-weight: 600;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #7FD4E0 0%, #9FE8ED 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(95, 200, 212, 0.4);
      border-color: #5FC8D4;
    }

    .btn-secondary {
      background: #f8f9fa;
      color: #2c3e50;
      border: 2px solid #e0e0e0;
    }

    .btn-secondary:hover {
      background: #e9ecef;
      border-color: #5FC8D4;
      transform: translateY(-1px);
    }

    /* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†æ ·å¼ */
    input[type="number"],
    select {
      transition: all 0.3s;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #5FC8D4 !important;
      box-shadow: 0 0 0 3px rgba(95, 200, 212, 0.15);
    }
    
    /* å•é€‰æŒ‰é’®æ ·å¼ */
    input[type="radio"] {
      accent-color: #5FC8D4;
      width: 18px;
      height: 18px;
    }
    
    /* é€‰æ‹©æ¡†æ ·å¼ä¼˜åŒ– */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235FC8D4' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    /* å ä½ç¬¦æ–‡æœ¬æ ·å¼ - å¢å¼ºå¯¹æ¯”åº¦ */
    input::placeholder,
    textarea::placeholder {
      color: #888 !important;
      opacity: 1;
    }
    
    input:focus::placeholder,
    textarea:focus::placeholder {
      color: #aaa !important;
    }

    .btn-success {
      background: linear-gradient(135deg, #5FC8D4 0%, #7FD4E0 100%);
      color: white;
      border: 2px solid #5FC8D4;
      font-weight: 600;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #7FD4E0 0%, #9FE8ED 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(95, 200, 212, 0.4);
    }

    .result-item {
      background: #ffffff;
      border: 2px solid #9FE8ED;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.3s;
    }

    .result-item:hover {
      border-color: #5FC8D4;
      box-shadow: 0 2px 8px rgba(95, 200, 212, 0.2);
    }

    /* ç½®ä¿¡åº¦ä½æˆ–éœ€è¦æ‰‹åŠ¨è¾“å…¥æ—¶çš„æ ·å¼ */
    .result-item.low-confidence,
    .result-item.manual-input {
      background: rgba(255, 182, 193, 0.2); /* æµ…çº¢è‰²é€æ˜ */
      border: 2px solid rgba(255, 99, 99, 0.5); /* æµ…çº¢è‰²è¾¹æ¡† */
    }

    .result-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .result-value {
      color: #333;
      font-size: 15px;
      line-height: 1.6;
      padding: 12px;
      background: white;
      border-radius: 6px;
      min-height: 40px;
      cursor: text;
      border: 1px solid #e0e0e0;
      transition: all 0.3s;
    }

    .result-value:focus {
      outline: none;
      border-color: #5FC8D4;
      background: white;
      box-shadow: 0 0 0 3px rgba(95, 200, 212, 0.15);
    }

    .result-value[contenteditable="true"] {
      background: white;
    }

    .extracted-text {
      margin-top: 8px;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
      font-style: italic;
    }

    .confidence-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .confidence-high {
      background: #d4edda;
      color: #155724;
    }

    .confidence-medium {
      background: #fff3cd;
      color: #856404;
    }

    .confidence-low {
      background: #f8d7da;
      color: #721c24;
    }

    .edit-btn {
      background: none;
      border: none;
      color: #5FC8D4;
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
      text-decoration: underline;
      font-weight: 500;
    }

    .edit-btn:hover {
      color: #3FB8C4;
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid #e0e0e0;
    }

    .message {
      padding: 0;
      border-radius: 0;
      margin-bottom: 20px;
      display: none;
      white-space: nowrap;
      overflow-x: auto;
    }
    
    .message.info-message {
      padding: 0;
      margin-top: 24px;
      margin-bottom: 20px;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .info-message {
      background: transparent;
      color: #666;
      border: none;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #5FC8D4;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #5FC8D4;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="javascript:void(0)" id="backButton" class="back-button" onclick="showPolicyCards()">è¿”å›</a>
      <h1 id="pageTitle">å®¶åº­ä¿å•ç®¡å®¶</h1>
    </div>

    <!-- åˆåŒå¡ç‰‡åˆ—è¡¨åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="policyCardsContainer" style="display: none; padding: 20px 30px 30px 30px;">
      <!-- å®¶åº­æˆå‘˜ç»Ÿè®¡åŒºåŸŸ -->
      <div id="familyMemberStats" style="margin-bottom: 20px; padding: 0;">
        <div style="display: flex; align-items: center; gap: 16px; overflow-x: auto; padding: 8px 0;">
          <!-- å®¶åº­æˆå‘˜ç»Ÿè®¡é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      
      <div id="policyCardsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        <!-- æ·»åŠ æ–°åˆåŒå¡ç‰‡ï¼ˆå°†åŠ¨æ€ç”Ÿæˆï¼‰ -->
        <!-- åˆåŒå¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <div class="content" id="mainContent">
      <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
      <div class="section">
        <h2>ğŸ“ è¾“å…¥ä¿é™©æ¡æ¬¾</h2>
        
        <!-- ä¿å•åŸºæœ¬ä¿¡æ¯ -->
        <div style="margin-bottom: 24px;">
          <!-- ä¿é™©å…¬å¸ -->
          <div style="margin-bottom: 16px; position: relative;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
              ä¿é™©å…¬å¸ <span style="color: #ef4444;">*</span>
            </label>
            <input type="text" id="insuranceCompany" placeholder="è¯·é€‰æ‹©æˆ–è¾“å…¥ä¿é™©å…¬å¸åç§°ï¼ˆæ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢ï¼‰" 
                   autocomplete="off"
                   style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; transition: border-color 0.3s;">
            <div id="insuranceCompanyDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #9FE8ED; border-radius: 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 4px;"></div>
          </div>
          
          <!-- ä¿å•ç±»å‹å’Œäº§å“åç§° - ä¸€è¡Œä¸¤æ  -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- ä¿å•ç±»å‹ -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                ä¿å•ç±»å‹ <span style="color: #ef4444;">*</span>
              </label>
              <select id="policyType" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.3s;" onchange="updatePolicyType()">
                <option value="annuity">å¹´é‡‘é™©</option>
                <option value="critical_illness" selected>é‡ç–¾é™©</option>
                <option value="accident">æ„å¤–é™©</option>
                <option value="life">äººå¯¿é™©</option>
              </select>
            </div>
            
            <!-- äº§å“åç§° -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                äº§å“åç§° <span style="color: #ef4444;">*</span>
              </label>
              <input type="text" id="productName" placeholder="è¯·è¾“å…¥ä¿é™©äº§å“åç§°" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; transition: border-color 0.3s;">
            </div>
          </div>
          
          <!-- è¢«ä¿é™©äººå’Œå‡ºç”Ÿå¹´ä»½ - ä¸€è¡Œä¸¤æ  -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- è¢«ä¿é™©äºº -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                è¢«ä¿é™©äºº <span style="color: #ef4444;">*</span>
              </label>
              <select id="insuredPerson" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.3s;">
                <option value="">è¯·é€‰æ‹©è¢«ä¿é™©äºº</option>
                <option value="æœ¬äºº">æœ¬äºº</option>
                <option value="é…å¶">é…å¶</option>
                <option value="å­å¥³1">å­å¥³1</option>
                <option value="å­å¥³2">å­å¥³2</option>
              </select>
            </div>
            
            <!-- å‡ºç”Ÿå¹´ä»½ -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                å‡ºç”Ÿå¹´ä»½ <span style="color: #ef4444;">*</span>
              </label>
              <select id="birthYear" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.3s;">
                <option value="">è¯·é€‰æ‹©å‡ºç”Ÿå¹´ä»½</option>
              </select>
            </div>
          </div>
          
          <!-- æŠ•ä¿å¼€å§‹å¹´ä»½å’Œä¿éšœç»“æŸå¹´ä»½ - ä¸€è¡Œä¸¤æ  -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- æŠ•ä¿å¼€å§‹å¹´ä»½ -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                æŠ•ä¿å¼€å§‹å¹´ä»½ <span style="color: #ef4444;">*</span>
              </label>
              <select id="policyStartYear" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.3s;">
                <option value="">è¯·é€‰æ‹©æŠ•ä¿å¼€å§‹å¹´ä»½</option>
              </select>
            </div>
            
            <!-- ä¿éšœç»“æŸå¹´ä»½ -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                ä¿éšœç»“æŸå¹´ä»½ <span style="color: #ef4444;">*</span>
              </label>
              <select id="coverageEndYear" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.3s;">
                <option value="">è¯·é€‰æ‹©ä¿éšœç»“æŸå¹´ä»½</option>
                <option value="lifetime">ç»ˆèº«</option>
              </select>
            </div>
          </div>
          
          <!-- æ€»ç¼´è´¹æœŸé™å’Œæ¯å¹´ä¿è´¹ - ä¸€è¡Œä¸¤æ  -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- æ€»ç¼´è´¹æœŸé™ -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                æ€»ç¼´è´¹æœŸé™ <span style="color: #ef4444;">*</span>
                <span style="font-size: 12px; color: #999; font-weight: normal; margin-left: 4px;">ä»æŠ•ä¿å¼€å§‹å¹´ä»½è®¡ç®—</span>
              </label>
              <select id="totalPaymentPeriod" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.3s;">
                <option value="">è¯·é€‰æ‹©ç¼´è´¹æœŸé™</option>
                <option value="1">1å¹´</option>
                <option value="3">3å¹´</option>
                <option value="5">5å¹´</option>
                <option value="10">10å¹´</option>
                <option value="15">15å¹´</option>
                <option value="20">20å¹´</option>
                <option value="30">30å¹´</option>
                <option value="lifetime">ç»ˆèº«ç¼´è´¹</option>
              </select>
            </div>
            
            <!-- æ¯å¹´ä¿è´¹ -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                æ¯å¹´ä¿è´¹ <span style="color: #ef4444;">*</span>
              </label>
              <div style="position: relative;">
                <input type="number" id="annualPremium" placeholder="è¯·è¾“å…¥æ¯å¹´ä¿è´¹" min="0" step="1" style="width: 100%; padding: 10px 40px 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; transition: border-color 0.3s;">
                <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px; pointer-events: none;">å…ƒ</span>
              </div>
            </div>
          </div>
          
          <!-- åŸºæœ¬ä¿é¢ -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
              åŸºæœ¬ä¿é¢ <span style="color: #ef4444;">*</span>
            </label>
            <div style="position: relative;">
              <input type="number" id="basicSumInsured" placeholder="è¯·è¾“å…¥åŸºæœ¬ä¿é¢" min="0" step="1" style="width: 100%; padding: 10px 40px 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; background: white; transition: border-color 0.3s;">
              <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px; pointer-events: none;">ä¸‡å…ƒ</span>
            </div>
          </div>
        </div>
        
        <!-- è´£ä»»ç±»å‹é€‰æ‹© -->
        <div style="margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="flex: 1; border-top: 2px dashed #5FC8D4;"></div>
            <div style="font-size: 14px; font-weight: 600; color: #5FC8D4; white-space: nowrap;">è¯·é€‰æ‹©è´£ä»»ç±»å‹</div>
            <div style="flex: 1; border-top: 2px dashed #5FC8D4;"></div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; padding: 16px 0; justify-items: center;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="coverageType" value="disease" style="width: 16px; height: 16px; cursor: pointer;" onchange="updateCoverageType()">
              <span style="font-size: 14px; color: #374151; white-space: nowrap;">ç–¾ç—…è´£ä»»</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="coverageType" value="death" style="width: 16px; height: 16px; cursor: pointer;" onchange="updateCoverageType()">
              <span style="font-size: 14px; color: #374151; white-space: nowrap;">èº«æ•…è´£ä»»</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="coverageType" value="accident" style="width: 16px; height: 16px; cursor: pointer;" onchange="updateCoverageType()">
              <span style="font-size: 14px; color: #374151; white-space: nowrap;">æ„å¤–è´£ä»»</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="coverageType" value="annuity" style="width: 16px; height: 16px; cursor: pointer;" onchange="updateCoverageType()">
              <span style="font-size: 14px; color: #374151; white-space: nowrap;">å¹´é‡‘è´£ä»»</span>
            </label>
          </div>
        </div>
        
        <!-- è´£ä»»ç²˜è´´å’Œåˆ†æåŒºåŸŸï¼ˆä¸€ç›´æ˜¾ç¤ºï¼‰ -->
        <div style="margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="flex: 1; border-top: 2px dashed #5FC8D4;"></div>
            <div style="font-size: 14px; font-weight: 600; color: #5FC8D4; white-space: nowrap;">ç²˜è´´è´£ä»»æ¡æ¬¾</div>
            <div style="flex: 1; border-top: 2px dashed #5FC8D4;"></div>
          </div>
          
          <!-- è´£ä»»æ¡æ¬¾ï¼ˆåŒ…å«åç§°å’Œæ¡æ¬¾ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ç¬¬ä¸€è¡Œä¸ºåç§°ï¼‰ -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
              ä¿éšœè´£ä»»æ¡æ¬¾ <span style="color: #ef4444;">*</span>
            </label>
            <textarea id="pageClauseInput" placeholder="è¯·ä»…ç²˜è´´ä¸€ä»½è´£ä»»çš„å®Œæ•´å†…å®¹ï¼Œæ—¢è¦ç¡®ä¿å†…å®¹æ— é—æ¼ï¼Œä¹Ÿä¸è¦å¤šç²˜å…¶ä»–è´£ä»»æˆ–é‡å¤ç²˜è´´ã€‚ç¬¬ä¸€è¡Œå°†è‡ªåŠ¨è¯†åˆ«ä¸ºè´£ä»»åç§°ã€‚" style="width: 100%; min-height: 180px; padding: 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; background: white;" onpaste="autoDetectCoverageNameFromPage(event)" oninput="autoDetectCoverageNameFromPageInput(event)"></textarea>
          </div>
          
          <!-- åˆ†ææŒ‰é’® -->
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button class="btn btn-primary" onclick="analyzeCoverageFromPage()" id="pageParseBtn" style="padding: 10px 24px; font-weight: 600;" disabled>
              ğŸ” åˆ†æè´£ä»»
          </button>
          </div>
        </div>

        <!-- è´£ä»»åˆ—è¡¨ -->
        <div style="margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="flex: 1; border-top: 2px dashed #5FC8D4;"></div>
            <div style="font-size: 14px; font-weight: 600; color: #5FC8D4; white-space: nowrap;">ä¿éšœè´£ä»»åˆ—è¡¨</div>
            <div style="flex: 1; border-top: 2px dashed #5FC8D4;"></div>
          </div>
          
          <div id="coverageList" style="margin-bottom: 16px;">
            <!-- è´£ä»»é¡¹å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            <p style="color: #999; text-align: center; padding: 20px; font-size: 14px;">
              æš‚æ— è´£ä»»ï¼Œè¯·åœ¨ä¸Šæ–¹ç²˜è´´è´£ä»»æ¡æ¬¾è¿›è¡Œåˆ†æ
            </p>
          </div>
        </div>

        <!-- åˆåŒå®ŒæˆæŒ‰é’® -->
        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e0e0e0;">
          <button class="btn btn-primary" onclick="completePolicy()" id="completePolicyBtn" style="width: 100%; padding: 12px; font-size: 16px; font-weight: 600;" disabled>
            âœ… åˆåŒå¡«å†™å®Œæˆ
          </button>
        </div>
      </div>

      <!-- å³ä¾§ï¼šè§£æç»“æœ -->
      <div class="section">
        <h2>ğŸ“Š è§£æç»“æœ</h2>
        
        <div class="loading" id="loading">
          <div style="text-align: center; padding: 40px 20px;">
            <div class="spinner" style="margin: 0 auto 20px;"></div>
            <div style="max-width: 500px; margin: 0 auto;">
              <div class="loading-step" style="margin: 12px 0; padding: 12px; background: #f0f8fc; border-left: 3px solid #5FC8D4; border-radius: 4px; opacity: 0; animation: fadeIn 0.5s ease-in forwards; font-size: 14px; text-align: left;">
                ğŸ¤– <strong>AIæ­£åœ¨è§£ææ¡æ¬¾ç»“æ„...</strong>
              </div>
              <div class="loading-step" style="margin: 12px 0; padding: 12px; background: #f0f8fc; border-left: 3px solid #5FC8D4; border-radius: 4px; opacity: 0; animation: fadeIn 0.5s ease-in 1s forwards; font-size: 14px; text-align: left;">
                ğŸ“‹ <strong>è¯†åˆ«èµ”ä»˜é˜¶æ®µå’Œè®¡ç®—å…¬å¼...</strong>
              </div>
              <div class="loading-step" style="margin: 12px 0; padding: 12px; background: #f0f8fc; border-left: 3px solid #5FC8D4; border-radius: 4px; opacity: 0; animation: fadeIn 0.5s ease-in 2s forwards; font-size: 14px; text-align: left;">
                ğŸ’° <strong>ç»“åˆæ‚¨çš„ä¿å•ä¿¡æ¯è®¡ç®—å®é™…é‡‘é¢...</strong>
              </div>
              <div class="loading-step" style="margin: 12px 0; padding: 8px 12px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; opacity: 0; animation: fadeIn 0.5s ease-in 3s forwards; font-size: 13px; color: #856404; text-align: left;">
                â±ï¸ é¢„è®¡è¿˜éœ€50ç§’ï¼Œè¯·ç¨å€™...
              </div>
            </div>
          </div>
        </div>

        <div class="message" id="message"></div>

        <!-- ğŸ¬ Streamingåˆ†ææ˜¾ç¤ºåŒºåŸŸ -->
        <div id="streamingContainer" style="display: none; margin: 20px 0; padding: 20px; background: #f0f8fc; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); border: 1px solid #d1e7f0;">
          <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <div class="streaming-spinner" style="width: 20px; height: 20px; border: 3px solid #d1e7f0; border-top-color: #5FC8D4; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px;"></div>
            <h3 style="margin: 0; color: #5FC8D4; font-size: 16px; font-weight: 600;">âœ¨ AIæ­£åœ¨åˆ†ææ¡æ¬¾...</h3>
          </div>
          <div id="streamingAnalysis" style="background: #ffffff; padding: 24px; border-radius: 8px; min-height: 200px; max-height: 600px; overflow-y: auto; color: #333; line-height: 1.8; font-size: 14px; white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; border: 1px solid #e8f4f8;"></div>
        </div>

        <div id="resultContainer">
          <p style="color: #999; text-align: center; padding: 40px;">
            è§£æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
            <br><br>
            <small>ç‚¹å‡»å·¦ä¾§"è§£ææ¡æ¬¾"æŒ‰é’®å¼€å§‹</small>
          </p>
        </div>

        <div class="actions" id="actionsSection" style="display: none;">
          <button class="btn btn-primary" onclick="saveAnalyzingCoverage()" style="margin-right: 12px;">
            ğŸ’¾ ä¿å­˜è´£ä»»
          </button>
          <button class="btn btn-secondary" onclick="copyResult()">
            ğŸ“‹ å¤åˆ¶ç»“æœ
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- æ·»åŠ è´£ä»»å¯¹è¯æ¡† -->
  <div id="addCoverageDialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="font-size: 18px; color: #333; font-weight: 600;">æ·»åŠ ä¿éšœè´£ä»»</h3>
        <button onclick="closeAddCoverageDialog()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer;">&times;</button>
      </div>
      
      <!-- è´£ä»»ç±»å‹é€‰æ‹© -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
          è´£ä»»ç±»å‹ <span style="color: #ef4444;">*</span>
        </label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="dialogCoverageType" value="disease" style="width: 16px; height: 16px;">
            <span style="font-size: 14px;">ç–¾ç—…è´£ä»»</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="dialogCoverageType" value="death" style="width: 16px; height: 16px;">
            <span style="font-size: 14px;">èº«æ•…è´£ä»»</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="dialogCoverageType" value="accident" style="width: 16px; height: 16px;">
            <span style="font-size: 14px;">æ„å¤–è´£ä»»</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="dialogCoverageType" value="annuity" style="width: 16px; height: 16px;">
            <span style="font-size: 14px;">å¹´é‡‘è´£ä»»</span>
          </label>
        </div>
      </div>
      
      <!-- è´£ä»»åç§° -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
          è´£ä»»åç§° <span style="color: #ef4444;">*</span>
          <small style="color: #999; font-weight: normal; margin-left: 8px;">ï¼ˆç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼Œä¹Ÿå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰</small>
        </label>
        <input type="text" id="coverageName" placeholder="è¯·è¾“å…¥æˆ–ç²˜è´´è´£ä»»åç§°ï¼ˆç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«ç¬¬ä¸€è¡Œï¼‰" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px;">
      </div>
      
      <!-- è´£ä»»æ¡æ¬¾ -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
          ä¿éšœè´£ä»»æ¡æ¬¾ <span style="color: #ef4444;">*</span>
        </label>
        <textarea id="dialogClauseInput" placeholder="è¯·ç²˜è´´ä¿é™©äº§å“çš„ä¿éšœè´£ä»»æ¡æ¬¾æ–‡æœ¬..." style="width: 100%; min-height: 200px; padding: 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;" onpaste="autoDetectCoverageName(event)"></textarea>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeAddCoverageDialog()" style="padding: 10px 20px;">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="addCoverageFromDialog()" style="padding: 10px 20px;">è§£æå¹¶æ·»åŠ </button>
      </div>
    </div>
  </div>

  <!-- è´£ä»»è§£æç»“æœç¼–è¾‘å¯¹è¯æ¡† -->
  <div id="editCoverageDialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="font-size: 18px; color: #333; font-weight: 600;">ç¼–è¾‘è´£ä»»è§£æç»“æœ</h3>
        <button onclick="closeEditCoverageDialog()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer;">&times;</button>
      </div>
      
      <div id="editCoverageContent">
        <!-- ç¼–è¾‘å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
        <button class="btn btn-secondary" onclick="closeEditCoverageDialog()" style="padding: 10px 20px;">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveCoverageEdit()" style="padding: 10px 20px;">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ==================== å¼•å…¥æœåŠ¡æ–‡ä»¶ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰==================== -->
  <!-- ç‹¬ç«‹çš„å­—æ®µè§£æå™¨æœåŠ¡ -->
  <script src="services/parsers/payoutAmountParser.js"></script>
  <script src="services/parsers/payoutCountParser.js"></script>
  <script src="services/parsers/intervalPeriodParser.js"></script>
  <script src="services/parsers/groupingParser.js"></script>
  <script src="services/parsers/repeatablePayoutParser.js"></script>
  <script src="services/parsers/premiumWaiverParser.js"></script>
  <script src="services/parsers/conditionsParser.js"></script>
  <script src="services/rules/ruleBasedParser.js"></script>
  <script src="services/rules/ruleExtraction.js"></script>
  <script src="services/rules/ruleStorage.js"></script>
  <!-- è§£æç›¸å…³æœåŠ¡ -->
  <script src="services/parser/llmParser.js"></script>
  <script src="services/parser/backendParser.js?v=20260101"></script>
  <script src="services/parser/parseCoordinator.js"></script>
  <!-- å­˜å‚¨ç›¸å…³æœåŠ¡ -->
  <script src="services/storage/policyStorage.js"></script>
  <script src="services/storage/coverageManager.js"></script>
  <script src="services/storage/policyManager.js"></script>
  <!-- æ•°æ®æœåŠ¡ -->
  <script src="services/data/insuranceCompanyData.js"></script>
  <!-- å·¥å…·æœåŠ¡ -->
  <script src="services/utils/textExtractor.js"></script>
  <script src="services/utils/validation.js?v=20260103"></script>
  <script src="services/utils/formatter.js?v=20260103b"></script>
  <script src="services/utils/utility.js"></script>
  <!-- UIæœåŠ¡ -->
  <script src="services/ui/uiRender.js?v=20260103"></script>
  <script src="services/ui/insuranceCompanySelector.js"></script>
  <!-- çŠ¶æ€ç®¡ç† -->
  <script src="services/state/appState.js"></script>
  <!-- UIåè°ƒæœåŠ¡ -->
  <script src="services/ui/coverageAnalysisCoordinator.js"></script>
  <script src="services/ui/coverageSaveCoordinator.js"></script>
  <script src="services/ui/resultCollectionService.js"></script>
  <script src="services/ui/policyFormCoordinator.js"></script>
  <script src="services/ui/payoutAmountRenderer.js"></script>
  <!-- é‡æ–°è®¡ç®—æœåŠ¡ -->
  <script src="services/parser/recalculateService.js"></script>
  <!-- ä¿å•ä¿¡æ¯åŠ©æ‰‹ -->
  <script src="services/utils/policyInfoHelper.js"></script>

  <script>
    // ==================== å…¨å±€å˜é‡ï¼ˆä½¿ç”¨AppStateç®¡ç†ï¼‰====================
    // æ³¨æ„ï¼šå¤§éƒ¨åˆ†çŠ¶æ€å·²è¿ç§»åˆ° AppStateï¼Œè¿™é‡Œä¿ç•™å…¼å®¹æ€§å¼•ç”¨
    let parseResult = null; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.parseResult
    let parseMethod = 'rule'; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.parseMethod
    let currentCoverageType = null; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.currentCoverageType
    let currentPolicyType = null; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.currentPolicyType
    let coverages = []; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.coverages
    let policies = []; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.policies
    let editingCoverageIndex = -1; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.editingCoverageIndex
    let editingPolicyId = null; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.editingPolicyId
    window.filteredMember = null; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.filteredMember
    
    // åŒæ­¥åˆ°AppStateï¼ˆåˆå§‹åŒ–ï¼‰
    if (typeof appState !== 'undefined') {
      parseResult = () => appState.parseResult;
      Object.defineProperty(window, 'parseResult', {
        get: () => appState.parseResult,
        set: (val) => { appState.parseResult = val; }
      });
      Object.defineProperty(window, 'currentCoverageType', {
        get: () => appState.currentCoverageType,
        set: (val) => { appState.currentCoverageType = val; }
      });
      Object.defineProperty(window, 'currentPolicyType', {
        get: () => appState.currentPolicyType,
        set: (val) => { appState.currentPolicyType = val; }
      });
      Object.defineProperty(window, 'coverages', {
        get: () => appState.coverages,
        set: (val) => { appState.coverages = val; }
      });
      Object.defineProperty(window, 'policies', {
        get: () => appState.policies,
        set: (val) => { appState.policies = val; }
      });
      coverages = appState.coverages;
      policies = appState.policies;
    }

    // UIåè°ƒå‡½æ•°ï¼šåˆå§‹åŒ–å¹´ä»½é€‰é¡¹
    function initPolicyStartYearOptions() {
      UtilityService.initPolicyStartYearOptions();
    }
    
    // UIåè°ƒå‡½æ•°ï¼šè‡ªåŠ¨è¯†åˆ«è´£ä»»åç§°ï¼ˆå¯¹è¯æ¡†ï¼‰
    function autoDetectCoverageName(event) {
      setTimeout(() => {
        const textarea = event.target;
        const detectedName = UtilityService.autoDetectCoverageName(textarea.value);
        if (detectedName) {
          document.getElementById('coverageName').value = detectedName;
        }
      }, 100);
    }
    
    // UIåè°ƒå‡½æ•°ï¼šè‡ªåŠ¨è¯†åˆ«è´£ä»»åç§°ï¼ˆé¡µé¢ï¼‰- ç²˜è´´æ—¶
    function autoDetectCoverageNameFromPage(event) {
      setTimeout(() => {
        const textarea = event.target;
        const detectedName = UtilityService.autoDetectCoverageName(textarea.value);
        if (detectedName) {
          document.getElementById('pageCoverageName').value = detectedName;
        }
      }, 100);
    }
    
    // UIåè°ƒå‡½æ•°ï¼šè‡ªåŠ¨è¯†åˆ«è´£ä»»åç§°ï¼ˆé¡µé¢ï¼‰- è¾“å…¥æ—¶
    function autoDetectCoverageNameFromPageInput(event) {
      const textarea = event.target;
      const detectedName = UtilityService.autoDetectCoverageName(textarea.value);
      if (detectedName && !document.getElementById('pageCoverageName').value) {
        // åªæœ‰å½“åç§°æ¡†ä¸ºç©ºæ—¶æ‰è‡ªåŠ¨å¡«å……ï¼Œé¿å…è¦†ç›–ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„å†…å®¹
        document.getElementById('pageCoverageName').value = detectedName;
      }
    }

    // æ›´æ–°ä¿å•ç±»å‹
    function updatePolicyType() {
      const select = document.getElementById('policyType');
      currentPolicyType = select ? select.value : null;
    }

    // æ›´æ–°è´£ä»»ç±»å‹
    function updateCoverageType() {
      // ä¼˜å…ˆæ£€æŸ¥é¡µé¢ä¸Šæ–¹çš„é€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ£€æŸ¥å¯¹è¯æ¡†ä¸­çš„é€‰æ‹©
      const pageSelected = document.querySelector('input[name="coverageType"]:checked');
      const dialogSelected = document.querySelector('input[name="dialogCoverageType"]:checked');
      const selected = pageSelected || dialogSelected;
      const newType = selected ? selected.value : null;
      
      // æ›´æ–°çŠ¶æ€ï¼ˆå…¼å®¹æ—§ä»£ç å’ŒAppStateï¼‰
      currentCoverageType = newType;
      if (typeof appState !== 'undefined') {
        appState.currentCoverageType = newType;
      }
      
      // ğŸ”¥ æš‚æ—¶åœç”¨ç¡¬è§„åˆ™ï¼Œä¸å†åˆ›å»ºè§„åˆ™è§£æå™¨
      // if (currentCoverageType) {
      //   ruleParser = new RuleBasedParser(currentCoverageType);
      // }
      
      // æ›´æ–°é¡µé¢åˆ†ææŒ‰é’®çŠ¶æ€
      const pageParseBtn = document.getElementById('pageParseBtn');
      if (pageParseBtn) {
        if (currentCoverageType) {
          pageParseBtn.disabled = false;
          pageParseBtn.style.opacity = '1';
          pageParseBtn.style.cursor = 'pointer';
        } else {
          pageParseBtn.disabled = true;
          pageParseBtn.style.opacity = '0.5';
          pageParseBtn.style.cursor = 'not-allowed';
        }
      }
      
      // æ›´æ–°å¯¹è¯æ¡†åˆ†ææŒ‰é’®çŠ¶æ€
      const parseBtn = document.getElementById('parseBtn');
      if (parseBtn) {
        if (currentCoverageType) {
          parseBtn.disabled = false;
          parseBtn.style.opacity = '1';
          parseBtn.style.cursor = 'pointer';
        } else {
          parseBtn.disabled = true;
          parseBtn.style.opacity = '0.5';
          parseBtn.style.cursor = 'not-allowed';
        }
      }
    }
    
    // æ˜¾ç¤ºæ·»åŠ è´£ä»»å¯¹è¯æ¡†
    function showAddCoverageDialog() {
      document.getElementById('addCoverageDialog').style.display = 'flex';
      // æ¸…ç©ºå¯¹è¯æ¡†å†…å®¹
      document.getElementById('coverageName').value = '';
      document.getElementById('dialogClauseInput').value = '';
      document.querySelectorAll('input[name="dialogCoverageType"]').forEach(radio => radio.checked = false);
    }
    
    // å…³é—­æ·»åŠ è´£ä»»å¯¹è¯æ¡†
    function closeAddCoverageDialog() {
      document.getElementById('addCoverageDialog').style.display = 'none';
    }
    
    // ä»å¯¹è¯æ¡†æ·»åŠ è´£ä»»
    // ValidationService å·²ç§»è‡³ services/utils/validation.js

    // CoverageManagerService å·²ç§»è‡³ services/storage/coverageManager.js

    // PolicyManagerService å·²ç§»è‡³ services/storage/policyManager.js

    // DataFormatterService å·²ç§»è‡³ services/utils/formatter.js

    // UtilityService å·²ç§»è‡³ services/utils/utility.js

    // ==================== UIåè°ƒå‡½æ•°ï¼ˆèŒè´£ï¼šåè°ƒæœåŠ¡å’ŒUIæ›´æ–°ï¼‰====================
    
    // ä»é¡µé¢ç›´æ¥åˆ†æè´£ä»»ï¼ˆå·²è¿ç§»åˆ°CoverageAnalysisCoordinatorï¼‰
    async function analyzeCoverageFromPage() {
      if (typeof CoverageAnalysisCoordinator !== 'undefined') {
        return CoverageAnalysisCoordinator.analyzeFromPage();
      }
      // é™çº§ï¼šå¦‚æœæœåŠ¡æœªåŠ è½½ï¼Œä½¿ç”¨æ—§ä»£ç 
      console.warn('âš ï¸ CoverageAnalysisCoordinatoræœªåŠ è½½ï¼Œä½¿ç”¨é™çº§ä»£ç ');
      // ... ä¿ç•™æ—§ä»£ç ä½œä¸ºé™çº§æ–¹æ¡ˆ ...
    }
    
    // æ›´æ–°ç»“æœä¸­çš„è´£ä»»åç§°
    function updateCoverageNameInResult(newName) {
      if (window.currentAnalyzingCoverage) {
        // å¦‚æœåç§°ä¸­åŒ…å«åˆ†ç±»ï¼ˆæ‹¬å·ï¼‰ï¼Œéœ€è¦æå–åŸå§‹åç§°
        let finalName = newName.trim();
        const categoryMatch = finalName.match(/^(.+?)ï¼ˆ(.+?)ï¼‰$/);
        if (categoryMatch) {
          finalName = categoryMatch[1]; // æå–æ‹¬å·å‰çš„åç§°
        }
        window.currentAnalyzingCoverage.name = finalName;
        
        // æ›´æ–°æ˜¾ç¤ºçš„åç§°ï¼ˆå¦‚æœç”¨æˆ·ä¿®æ”¹äº†ï¼Œé‡æ–°æ£€æµ‹åˆ†ç±»ï¼‰
        const nameElement = document.getElementById('resultCoverageName');
        if (nameElement && currentCoverageType === 'disease') {
          const clauseText = document.getElementById('pageClauseInput')?.value || '';
          const category = UtilityService.detectDiseaseCategory(finalName, clauseText);
          if (category) {
            nameElement.textContent = `${finalName}ï¼ˆ${category}ï¼‰`;
            nameElement.setAttribute('data-original-name', finalName);
            nameElement.setAttribute('data-category', category);
          } else {
            nameElement.textContent = finalName;
            nameElement.removeAttribute('data-category');
          }
        }
      }
    }
    
    // ä¿å­˜å½“å‰åˆ†æçš„è´£ä»»ï¼ˆå·²è¿ç§»åˆ°CoverageSaveCoordinatorï¼‰
    function saveAnalyzingCoverage() {
      if (typeof CoverageSaveCoordinator !== 'undefined') {
        return CoverageSaveCoordinator.save();
      }
      // é™çº§ï¼šå¦‚æœæœåŠ¡æœªåŠ è½½ï¼Œä½¿ç”¨æ—§ä»£ç 
      console.warn('âš ï¸ CoverageSaveCoordinatoræœªåŠ è½½ï¼Œä½¿ç”¨é™çº§ä»£ç ');
      // ... ä¿ç•™æ—§ä»£ç ä½œä¸ºé™çº§æ–¹æ¡ˆ ...
    }
    
    // æ”¶é›†ç”¨æˆ·ä¿®æ”¹åçš„è§£æç»“æœï¼ˆå·²è¿ç§»åˆ°ResultCollectionServiceï¼‰
    function collectUpdatedResult(originalResult) {
      if (typeof ResultCollectionService !== 'undefined') {
        return ResultCollectionService.collect(originalResult);
      }
      // é™çº§ï¼šå¦‚æœæœåŠ¡æœªåŠ è½½ï¼Œä½¿ç”¨æ—§ä»£ç 
      console.warn('âš ï¸ ResultCollectionServiceæœªåŠ è½½ï¼Œä½¿ç”¨é™çº§ä»£ç ');
      const result = JSON.parse(JSON.stringify(originalResult)); // æ·±æ‹·è´
      
      // 1. èµ”ä»˜é‡‘é¢ï¼ˆæ”¶é›†å¤šé˜¶æ®µæ•°æ®ï¼‰
      const payoutAmountItem = document.getElementById('payoutAmountItem');
      if (payoutAmountItem) {
        const tiers = [];
        const tierInputs = payoutAmountItem.querySelectorAll('[data-tier]');
        const tierMap = {};
        
        // æŒ‰é˜¶æ®µåˆ†ç»„æ”¶é›†æ•°æ®
        tierInputs.forEach(input => {
          const tierIndex = input.getAttribute('data-tier');
          const field = input.getAttribute('data-field');
          
          if (!tierMap[tierIndex]) {
            tierMap[tierIndex] = {};
          }
          
          if (input.type === 'number') {
            tierMap[tierIndex][field] = input.value ? parseFloat(input.value) : null;
          } else if (input.tagName === 'SELECT') {
            tierMap[tierIndex][field] = input.value;
          }
        });
        
        // è½¬æ¢ä¸ºtiersæ•°ç»„ï¼ˆä¿ç•™åŸå§‹tierçš„å®Œæ•´æ•°æ®ï¼‰
        Object.keys(tierMap).sort((a, b) => parseInt(a) - parseInt(b)).forEach(tierIndex => {
          const tierData = tierMap[tierIndex];
          const index = parseInt(tierIndex);
          
          // ğŸ¯ è·å–åŸå§‹tierçš„å®Œæ•´æ•°æ®
          const originalTier = originalResult.payoutAmount?.details?.tiers?.[index] || 
                              originalResult.payoutAmount?.details?.conditions?.[index] || {};
          
          // ğŸ¯ åˆå¹¶ï¼šä¿ç•™åŸå§‹æ•°æ®ï¼Œåªæ›´æ–°ç”¨æˆ·ä¿®æ”¹çš„å­—æ®µ
          const updatedTier = {
            ...originalTier, // ä¿ç•™æ‰€æœ‰åŸå§‹å­—æ®µï¼ˆkeyAmountsã€formulaã€periodç­‰ï¼‰
            // ç”¨æˆ·å¯ä¿®æ”¹çš„å­—æ®µ
            amount: tierData.amount !== null ? tierData.amount : originalTier.amount,
            startAge: tierData.startAge !== null ? tierData.startAge : originalTier.startAge,
            endAge: tierData.endAge !== null ? tierData.endAge : originalTier.endAge,
            increase: tierData.increase || originalTier.increase || 0,
            interestType: tierData.interestType || originalTier.interestType || 'simple'
          };
          
          tiers.push(updatedTier);
        });
        
        if (tiers.length > 0) {
          result.payoutAmount = {
            type: 'tiered',
            details: { tiers },
            confidence: result.payoutAmount?.confidence || 0.8,
            extractedText: result.payoutAmount?.extractedText || ''
          };
        } else if (result.payoutAmount && result.payoutAmount.type === 'tiered' && result.payoutAmount.details?.tiers) {
          // ğŸ¯ å¦‚æœç”¨æˆ·æ²¡æœ‰ä¿®æ”¹è¾“å…¥æ¡†ï¼Œç›´æ¥ä¿ç•™åŸå§‹tiersï¼ˆåŒ…å«æ‰€æœ‰å­—æ®µï¼‰
          // åªéœ€è¦ç§»é™¤undefinedçš„periodå­—æ®µå³å¯
          result.payoutAmount.details.tiers = result.payoutAmount.details.tiers.map(tier => {
            // å¦‚æœtieræ—¢æ²¡æœ‰startAge/endAgeä¹Ÿæ²¡æœ‰periodï¼Œæ ‡è®°ä¸ºæ— æ•ˆ
            if (!tier.startAge && !tier.endAge && !tier.period) {
              return null;
            }
            
            // ğŸ¯ ä¿ç•™tierçš„æ‰€æœ‰å­—æ®µï¼ˆkeyAmountsã€formulaã€formulaTypeç­‰ï¼‰
            // åªç§»é™¤å€¼ä¸ºundefinedçš„periodå­—æ®µ
            const cleanedTier = { ...tier };
            if (tier.period === undefined) {
              delete cleanedTier.period;
            }
            
            return cleanedTier;
          }).filter(tier => tier !== null); // è¿‡æ»¤æ‰æ— æ•ˆçš„tier
          
          // å¦‚æœæ¸…ç†åæ²¡æœ‰æœ‰æ•ˆçš„tiersï¼Œç§»é™¤payoutAmount
          if (result.payoutAmount.details.tiers.length === 0) {
            delete result.payoutAmount;
          }
        }
      }
      
      // 2. èµ”ä»˜æ¬¡æ•°ï¼ˆé»˜è®¤1æ¬¡ï¼‰
      const payoutCountInput = document.getElementById('payoutCountInput');
      const count = payoutCountInput && payoutCountInput.value ? parseInt(payoutCountInput.value) : 1;
      result.payoutCount = {
        type: count === 1 ? 'single' : 'multiple',
        maxCount: count,
        terminateAfterPayout: count === 1,
        confidence: result.payoutCount?.confidence || 0.8,
        extractedText: result.payoutCount?.extractedText || ''
      };
      
      // 3. æ˜¯å¦åˆ†ç»„ï¼ˆé»˜è®¤ä¸åˆ†ç»„ï¼‰
      const groupingRadio = document.querySelector('input[name="groupingRadio"]:checked');
      const groupingValue = groupingRadio ? groupingRadio.value : 'not_grouped';
      // å¦‚æœé€‰æ‹©"ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠ"ï¼Œä¿å­˜ä¸ºä¸åˆ†ç»„ï¼Œç½®ä¿¡åº¦ä¸º0.8
      if (groupingValue === 'not_applicable') {
        result.grouping = {
          isGrouped: false,
          confidence: 0.8,
          extractedText: result.grouping?.extractedText || 'ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠ'
        };
      } else {
        result.grouping = {
          isGrouped: groupingValue === 'grouped',
          confidence: result.grouping?.confidence || (groupingValue === 'not_grouped' && count >= 2 && !result.grouping ? 0 : 0.8),
          extractedText: result.grouping?.extractedText || ''
        };
      }
      
      // 4. æ˜¯å¦å¯ä»¥é‡å¤èµ”ä»˜ï¼ˆé»˜è®¤å¯ä»¥ï¼‰
      const repeatablePayoutRadio = document.querySelector('input[name="repeatablePayoutRadio"]:checked');
      const repeatableValue = repeatablePayoutRadio ? repeatablePayoutRadio.value : 'repeatable';
      // å¦‚æœé€‰æ‹©"ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠ"ï¼Œä¿å­˜ä¸ºä¸å¯ä»¥é‡å¤ï¼Œç½®ä¿¡åº¦ä¸º0.8
      if (repeatableValue === 'not_applicable') {
        result.repeatablePayout = {
          isRepeatable: false,
          confidence: 0.8,
          extractedText: result.repeatablePayout?.extractedText || 'ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠ'
        };
      } else {
        result.repeatablePayout = {
          isRepeatable: repeatableValue === 'repeatable',
          confidence: result.repeatablePayout?.confidence || (repeatableValue === 'repeatable' && count >= 2 && !result.repeatablePayout ? 0 : 0.8),
          extractedText: result.repeatablePayout?.extractedText || ''
        };
      }
      
      // 5. é—´éš”æœŸï¼ˆé»˜è®¤0å¤©ï¼‰
      const intervalPeriodInput = document.getElementById('intervalPeriodInput');
      const days = intervalPeriodInput && intervalPeriodInput.value !== '' ? parseInt(intervalPeriodInput.value) || 0 : 0;
      result.intervalPeriod = {
        hasInterval: days > 0,
        days: days > 0 ? days : null,
        confidence: result.intervalPeriod?.confidence || 0.8,
        extractedText: result.intervalPeriod?.extractedText || ''
      };
      
      // 6. æ˜¯å¦è±å…ä¿è´¹ï¼ˆé»˜è®¤ä¸è±å…ï¼‰
      const premiumWaiverRadio = document.querySelector('input[name="premiumWaiverRadio"]:checked');
      const waiverValue = premiumWaiverRadio ? premiumWaiverRadio.value : 'not_waived';
      result.premiumWaiver = {
        isWaived: waiverValue === 'waived',
        confidence: result.premiumWaiver?.confidence || 0.8,
        extractedText: result.premiumWaiver?.extractedText || ''
      };
      
      return result;
    }
    
    // ğŸ”’ é˜²æ­¢é‡å¤æäº¤çš„æ ‡å¿—ï¼ˆå·²è¿ç§»åˆ°AppStateï¼‰
    let isParsingInProgress = false; // å…¼å®¹æ€§ï¼šä½¿ç”¨ appState.isParsingInProgress
    
    async function addCoverageFromDialog() {
      if (typeof CoverageAnalysisCoordinator !== 'undefined') {
        return CoverageAnalysisCoordinator.analyzeFromDialog();
      }
      // é™çº§ï¼šå¦‚æœæœåŠ¡æœªåŠ è½½ï¼Œä½¿ç”¨æ—§ä»£ç 
      console.warn('âš ï¸ CoverageAnalysisCoordinatoræœªåŠ è½½ï¼Œä½¿ç”¨é™çº§ä»£ç ');
      // ... ä¿ç•™æ—§ä»£ç ä½œä¸ºé™çº§æ–¹æ¡ˆ ...
    }
    
    // UIRenderService å·²ç§»è‡³ services/ui/uiRender.js

    // UIåè°ƒå‡½æ•°ï¼šè°ƒç”¨æ¸²æŸ“æœåŠ¡æ›´æ–°DOM
    function renderCoverageList() {
      const container = document.getElementById('coverageList');
      const policyInfo = getPolicyInfo();
      container.innerHTML = UIRenderService.renderCoverageList(coverages, policyInfo);
    }
    
    // ç¼–è¾‘è´£ä»»ï¼šåŠ è½½åˆ°åˆ†ææ¡†ä¸­
    async function editCoverage(index) {
      editingCoverageIndex = index;
      const coverage = coverages[index];
      
      // ğŸ”¥ æ¸…ç©ºåŸå§‹è®¡ç®—å€¼ï¼Œå‡†å¤‡é‡æ–°åˆå§‹åŒ–
      originalCalculatedAmounts = {};
      console.log(`ğŸ“¦ [ç¼–è¾‘è´£ä»»] å·²æ¸…ç©º originalCalculatedAmountsï¼Œå‡†å¤‡é‡æ–°åˆå§‹åŒ–`);
      
      // 1. è®¾ç½®è´£ä»»ç±»å‹é€‰æ‹©
      const typeRadio = document.querySelector(`input[name="coverageType"][value="${coverage.type}"]`);
      if (typeRadio) {
        typeRadio.checked = true;
        updateCoverageType();
      }
      
      // 2. å¡«å……å·¦ä¾§æ¡æ¬¾æ–‡æœ¬
      document.getElementById('pageClauseInput').value = coverage.clauseText || coverage.clause || '';
      window.detectedCoverageName = coverage.name;
      
      // ğŸ¯ æ£€æŸ¥ä¿å•ä¿¡æ¯æ˜¯å¦å˜åŒ–ï¼Œå¦‚æœå˜åŒ–åˆ™é‡æ–°è®¡ç®—
      const birthYearEl = document.getElementById('birthYear');
      const policyStartYearEl = document.getElementById('policyStartYear');
      const coverageEndYearEl = document.getElementById('coverageEndYear');
      const basicSumInsuredEl = document.getElementById('basicSumInsured');
      const totalPaymentPeriodEl = document.getElementById('totalPaymentPeriod');
      const annualPremiumEl = document.getElementById('annualPremium');
      
      const currentPolicyInfo = {
        birthYear: birthYearEl ? parseInt(birthYearEl.value) : undefined,
        policyStartYear: policyStartYearEl ? parseInt(policyStartYearEl.value) : undefined,
        coverageEndYear: coverageEndYearEl ? (coverageEndYearEl.value === 'lifetime' ? 'lifetime' : parseInt(coverageEndYearEl.value)) : undefined,
        basicSumInsured: basicSumInsuredEl ? parseFloat(basicSumInsuredEl.value) * 10000 : undefined,
        totalPaymentPeriod: totalPaymentPeriodEl ? totalPaymentPeriodEl.value : undefined,
        annualPremium: annualPremiumEl ? parseFloat(annualPremiumEl.value) : undefined
      };
      
      console.log('ğŸ” [ç¼–è¾‘è´£ä»»] å½“å‰ä¿å•ä¿¡æ¯:', currentPolicyInfo);
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—
      let needsRecalculation = false;
      if (coverage.parseResult?.payoutAmount?.details?.tiers) {
        const firstTier = coverage.parseResult.payoutAmount.details.tiers[0];
        if (firstTier?.keyAmounts && firstTier.keyAmounts.length > 0) {
          // é€šè¿‡ç¬¬ä¸€ä¸ªkeyAmountåæ¨å‡ºåŸæ¥çš„ä¿å•ä¿¡æ¯
          const firstKeyAmount = firstTier.keyAmounts[0];
          const originalBirthYear = firstKeyAmount.year - firstKeyAmount.age;
          
          needsRecalculation = originalBirthYear !== currentPolicyInfo.birthYear;
          
          console.log('ğŸ” [ç¼–è¾‘è´£ä»»] åŸå‡ºç”Ÿå¹´ä»½:', originalBirthYear, 'å½“å‰å‡ºç”Ÿå¹´ä»½:', currentPolicyInfo.birthYear);
          console.log('ğŸ” [ç¼–è¾‘è´£ä»»] æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—:', needsRecalculation ? 'âœ… æ˜¯' : 'âŒ å¦');
        }
      }
      
      // ğŸ”„ å¦‚æœéœ€è¦é‡æ–°è®¡ç®—ï¼Œè°ƒç”¨åç«¯é‡æ–°è®¡ç®—æ‰€æœ‰é˜¶æ®µ
      if (needsRecalculation && coverage.parseResult?.payoutAmount?.details?.tiers) {
        console.log('ğŸ”„ [ç¼–è¾‘è´£ä»»] ä¿å•ä¿¡æ¯å·²å˜åŒ–ï¼Œå¼€å§‹é‡æ–°è®¡ç®—æ‰€æœ‰é˜¶æ®µ...');
        
        showMessage('â³ æ£€æµ‹åˆ°ä¿å•ä¿¡æ¯å˜åŒ–ï¼Œæ­£åœ¨é‡æ–°è®¡ç®—...', 'warning');
        
        try {
          for (let j = 0; j < coverage.parseResult.payoutAmount.details.tiers.length; j++) {
            const tier = coverage.parseResult.payoutAmount.details.tiers[j];
            
            if (!tier.keyAmounts || tier.keyAmounts.length === 0) {
              console.log(`   âš ï¸ [ç¼–è¾‘è´£ä»»] é˜¶æ®µ${j + 1}æ²¡æœ‰keyAmountsï¼Œè·³è¿‡`);
              continue;
            }
            
            console.log(`   ğŸ”„ [ç¼–è¾‘è´£ä»»] é‡æ–°è®¡ç®—é˜¶æ®µ${j + 1}: ${tier.period}`);
            
            try {
              const response = await fetch('http://localhost:4000/api/coverage/recalculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tier, policyInfo: currentPolicyInfo })
              });
              
              if (!response.ok) {
                console.error(`   âŒ [ç¼–è¾‘è´£ä»»] é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—å¤±è´¥: ${response.status}`);
                continue;
              }
              
              const result = await response.json();
              if (result.success && result.keyAmounts) {
                tier.keyAmounts = result.keyAmounts;
                
                // ğŸ¯ åŒæ—¶æ›´æ–°tierçš„startAgeå’ŒendAge
                if (result.keyAmounts.length > 0) {
                  tier.startAge = result.keyAmounts[0].age;
                  tier.endAge = result.keyAmounts[result.keyAmounts.length - 1].age;
                  console.log(`   âœ… [ç¼–è¾‘è´£ä»»] é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—æˆåŠŸï¼Œå¹´é¾„èŒƒå›´ï¼š${tier.startAge}å²-${tier.endAge}å²`);
                }
              } else {
                console.error(`   âŒ [ç¼–è¾‘è´£ä»»] é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—å“åº”å¼‚å¸¸:`, result);
              }
            } catch (err) {
              console.error(`   âŒ [ç¼–è¾‘è´£ä»»] é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—ç½‘ç»œé”™è¯¯:`, err);
            }
          }
          
          console.log('âœ… [ç¼–è¾‘è´£ä»»] æ‰€æœ‰é˜¶æ®µé‡æ–°è®¡ç®—å®Œæˆ');
          showMessage('âœ… é‡æ–°è®¡ç®—å®Œæˆ', 'success');
        } catch (error) {
          console.error('âŒ [ç¼–è¾‘è´£ä»»] é‡æ–°è®¡ç®—è¿‡ç¨‹å‡ºé”™:', error);
          showMessage('âš ï¸ é‡æ–°è®¡ç®—éƒ¨åˆ†å¤±è´¥ï¼Œè¯·æ£€æŸ¥', 'warning');
        }
      }
      
      // 3. æ˜¾ç¤ºå³ä¾§è§£æç»“æœï¼ˆåŒ…å«è´£ä»»åç§°ï¼‰
      parseResult = coverage.parseResult;
      displayResult(coverage.parseResult, coverage.name);
      
      // 4. æ˜¾ç¤ºä¿å­˜æŒ‰é’®
      document.getElementById('actionsSection').style.display = 'flex';
      
      // 5. ä¿å­˜å½“å‰ç¼–è¾‘çŠ¶æ€
      window.currentAnalyzingCoverage = {
        type: coverage.type,
        name: coverage.name,
        clause: coverage.clauseText || coverage.clause || '',
        result: coverage.parseResult,
        isEditing: true,
        editIndex: index
      };
      
      // 6. æ»šåŠ¨åˆ°åˆ†æåŒºåŸŸ
      document.getElementById('pageClauseInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      if (!needsRecalculation) {
      showMessage('âœ… å·²åŠ è½½è´£ä»»å†…å®¹ï¼Œå¯åœ¨å·¦ä¾§ä¿®æ”¹æ¡æ¬¾æ–‡æœ¬ï¼Œå³ä¾§ä¿®æ”¹è§£æç»“æœ', 'success');
      }
    }
    
    // ç”Ÿæˆç¼–è¾‘è¡¨å•
    function generateEditForm(coverage) {
      const result = coverage.parseResult;
      return `
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">è´£ä»»åç§°</label>
          <input type="text" id="editCoverageName" value="${coverage.name}" style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px;">
        </div>
        ${createEditableResultItem('èµ”ä»˜é‡‘é¢', formatPayoutAmount(result.payoutAmount), 'payoutAmount', result.payoutAmount)}
        ${createEditableResultItem('èµ”ä»˜æ¬¡æ•°', formatPayoutCount(result.payoutCount), 'payoutCount', result.payoutCount)}
        ${createEditableResultItem('é‡ç–¾åˆ†ç»„', formatGrouping(result.grouping), 'grouping', result.grouping)}
        ${createEditableResultItem('é—´éš”æœŸ', formatIntervalPeriod(result.intervalPeriod), 'intervalPeriod', result.intervalPeriod)}
      `;
    }
    
    // åˆ›å»ºå¯ç¼–è¾‘çš„ç»“æœé¡¹
    function createEditableResultItem(label, value, key, originalData) {
      return `
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">${label}</label>
          <div contenteditable="true" data-key="${key}" style="padding: 12px; border: 2px solid #9FE8ED; border-radius: 8px; min-height: 40px; background: white;">${value}</div>
        </div>
      `;
    }
    
    // ä¿å­˜è´£ä»»ç¼–è¾‘
    function saveCoverageEdit() {
      if (editingCoverageIndex === -1) return;
      
      const coverage = coverages[editingCoverageIndex];
      coverage.name = document.getElementById('editCoverageName').value.trim();
      
      // æ›´æ–°è§£æç»“æœï¼ˆä»å¯ç¼–è¾‘å†…å®¹ä¸­æå–ï¼‰
      const editableDivs = document.querySelectorAll('#editCoverageContent [contenteditable="true"]');
      editableDivs.forEach(div => {
        const key = div.getAttribute('data-key');
        // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ›´æ–°å¯¹åº”çš„æ•°æ®ç»“æ„
        // ç®€åŒ–å¤„ç†ï¼šä¿æŒåŸæœ‰æ•°æ®ç»“æ„
      });
      
      renderCoverageList();
      closeEditCoverageDialog();
      showMessage('âœ… è´£ä»»å·²ä¿å­˜', 'success');
    }
    
    // å…³é—­ç¼–è¾‘å¯¹è¯æ¡†
    function closeEditCoverageDialog() {
      document.getElementById('editCoverageDialog').style.display = 'none';
      editingCoverageIndex = -1;
    }
    
    // UIåè°ƒå‡½æ•°ï¼šåˆ é™¤è´£ä»»
    function deleteCoverage(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´£ä»»å—ï¼Ÿ')) {
        CoverageManagerService.delete(coverages, index);
        renderCoverageList();
        updateCompleteButton();
        showMessage('âœ… è´£ä»»å·²åˆ é™¤', 'success');
      }
    }
    
    // æ›´æ–°å®ŒæˆæŒ‰é’®çŠ¶æ€ï¼ˆå·²è¿ç§»åˆ°PolicyFormCoordinatorï¼‰
    function updateCompleteButton() {
      if (typeof PolicyFormCoordinator !== 'undefined') {
        return PolicyFormCoordinator.updateCompleteButton();
      }
      // é™çº§ä»£ç 
      const btn = document.getElementById('completePolicyBtn');
      if (!btn) return;
      const hasBasicInfo = document.getElementById('insuranceCompany')?.value.trim() &&
                          document.getElementById('productName')?.value.trim() &&
                          document.getElementById('insuredPerson')?.value &&
                          document.getElementById('birthYear')?.value &&
                          document.getElementById('policyStartYear')?.value &&
                          document.getElementById('coverageEndYear')?.value &&
                          document.getElementById('totalPaymentPeriod')?.value &&
                          document.getElementById('annualPremium')?.value &&
                          document.getElementById('basicSumInsured')?.value;
      const hasCoverages = (appState?.coverages || coverages).length > 0;
      btn.disabled = !(hasBasicInfo && hasCoverages);
    }
    
    // PolicyStorageService å·²ç§»è‡³ services/storage/policyStorage.js

    // UIåè°ƒå‡½æ•°ï¼šå®ŒæˆåˆåŒå¡«å†™ï¼ˆå·²è¿ç§»åˆ°PolicyFormCoordinatorï¼‰
    async function completePolicy() {
      if (typeof PolicyFormCoordinator !== 'undefined') {
        return PolicyFormCoordinator.complete();
      }
      // é™çº§ï¼šå¦‚æœæœåŠ¡æœªåŠ è½½ï¼Œä½¿ç”¨æ—§ä»£ç 
      console.warn('âš ï¸ PolicyFormCoordinatoræœªåŠ è½½ï¼Œä½¿ç”¨é™çº§ä»£ç ');
      try {
        console.log('========== å¼€å§‹å®ŒæˆåˆåŒå¡«å†™ ==========');
        console.log('å½“å‰è´£ä»»æ•°é‡:', (appState?.coverages || coverages).length);
        console.log('å½“å‰ä¿å•åˆ—è¡¨æ•°é‡:', (appState?.policies || policies).length);
        
        // 1. æ”¶é›†è¡¨å•æ•°æ®
        const insuranceCompanyEl = document.getElementById('insuranceCompany');
        const productNameEl = document.getElementById('productName');
        const policyTypeEl = document.getElementById('policyType');
        const insuredPersonEl = document.getElementById('insuredPerson');
        const birthYearEl = document.getElementById('birthYear');
        const policyStartYearEl = document.getElementById('policyStartYear');
        const coverageEndYearEl = document.getElementById('coverageEndYear');
        const totalPaymentPeriodEl = document.getElementById('totalPaymentPeriod');
        const annualPremiumEl = document.getElementById('annualPremium');
        const basicSumInsuredEl = document.getElementById('basicSumInsured');
        
        console.log('è¡¨å•å…ƒç´ æ£€æŸ¥:');
        console.log('  insuranceCompany:', insuranceCompanyEl?.value);
        console.log('  productName:', productNameEl?.value);
        console.log('  policyType:', policyTypeEl?.value);
        console.log('  insuredPerson:', insuredPersonEl?.value);
        console.log('  birthYear:', birthYearEl?.value);
        console.log('  policyStartYear:', policyStartYearEl?.value);
        console.log('  coverageEndYear:', coverageEndYearEl?.value);
        console.log('  totalPaymentPeriod:', totalPaymentPeriodEl?.value);
        console.log('  annualPremium:', annualPremiumEl?.value);
        console.log('  basicSumInsured:', basicSumInsuredEl?.value);
        
        const newPolicyInfo = {
          birthYear: birthYearEl?.value ? parseInt(birthYearEl.value) : null,
          policyStartYear: policyStartYearEl?.value ? parseInt(policyStartYearEl.value) : null,
          coverageEndYear: coverageEndYearEl?.value === 'lifetime' ? 'lifetime' : (coverageEndYearEl?.value ? parseInt(coverageEndYearEl.value) : null),
          totalPaymentPeriod: totalPaymentPeriodEl?.value === 'lifetime' ? 'lifetime' : (totalPaymentPeriodEl?.value ? parseInt(totalPaymentPeriodEl.value) : null),
          annualPremium: annualPremiumEl?.value ? parseFloat(annualPremiumEl.value) : 0,
          basicSumInsured: basicSumInsuredEl?.value ? parseFloat(basicSumInsuredEl.value) * 10000 : 0
        };
        
        // ğŸ¯ æ£€æŸ¥policyInfoæ˜¯å¦å˜åŒ–ï¼ˆå¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼‰
        let needsRecalculation = false;
        if (editingPolicyId) {
          const existingPolicy = policies.find(p => p.id === editingPolicyId);
          if (existingPolicy) {
            console.log('ğŸ” æ£€æŸ¥policyInfoæ˜¯å¦å˜åŒ–...');
            console.log('  åŸå§‹policyInfo:', {
              birthYear: existingPolicy.birthYear,
              policyStartYear: existingPolicy.policyStartYear,
              coverageEndYear: existingPolicy.coverageEndYear,
              totalPaymentPeriod: existingPolicy.totalPaymentPeriod,
              annualPremium: existingPolicy.annualPremium,
              basicSumInsured: existingPolicy.basicSumInsured
            });
            console.log('  æ–°çš„policyInfo:', newPolicyInfo);
            
            needsRecalculation = 
              existingPolicy.birthYear !== newPolicyInfo.birthYear ||
              existingPolicy.policyStartYear !== newPolicyInfo.policyStartYear ||
              existingPolicy.coverageEndYear !== newPolicyInfo.coverageEndYear ||
              existingPolicy.totalPaymentPeriod !== newPolicyInfo.totalPaymentPeriod ||
              existingPolicy.annualPremium !== newPolicyInfo.annualPremium ||
              existingPolicy.basicSumInsured !== newPolicyInfo.basicSumInsured;
            
            console.log('  æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—:', needsRecalculation ? 'âœ… æ˜¯' : 'âŒ å¦');
          }
        }
        
        // ğŸ”„ å¦‚æœpolicyInfoå˜åŒ–äº†ï¼Œé‡æ–°è®¡ç®—æ‰€æœ‰è´£ä»»
        if (needsRecalculation && coverages.length > 0) {
          console.log('ğŸ”„ policyInfoå·²å˜åŒ–ï¼Œå¼€å§‹é‡æ–°è®¡ç®—æ‰€æœ‰è´£ä»»çš„èµ”ä»˜é‡‘é¢...');
          
          // ğŸ¯ è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­ï¼ˆå¯é€‰ï¼šå¦‚æœä½ æƒ³ç»™ç”¨æˆ·é€‰æ‹©æƒï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šï¼‰
          // const confirmed = confirm(
          //   `æ£€æµ‹åˆ°ä¿å•ä¿¡æ¯å˜åŒ–ï¼Œå°†è‡ªåŠ¨é‡æ–°è®¡ç®—${coverages.length}ä¸ªè´£ä»»çš„é‡‘é¢ã€‚\n\n` +
          //   `æ˜¯å¦ç»§ç»­ï¼Ÿç‚¹å‡»"å–æ¶ˆ"å¯è¿”å›ä¿®æ”¹ã€‚`
          // );
          // if (!confirmed) return;
          
          const completePolicyBtn = document.getElementById('completePolicyBtn');
          const originalText = completePolicyBtn ? completePolicyBtn.textContent : '';
          
          showMessage(`â³ æ£€æµ‹åˆ°ä¿å•ä¿¡æ¯å˜åŒ–ï¼Œæ­£åœ¨é‡æ–°è®¡ç®—${coverages.length}ä¸ªè´£ä»»...`, 'info', 0);
          
          try {
            let successCount = 0;
            for (let i = 0; i < coverages.length; i++) {
              const coverage = coverages[i];
              
              // ğŸ¯ å®æ—¶æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºè¿›åº¦
              if (completePolicyBtn) {
                completePolicyBtn.textContent = `â³ æ­£åœ¨è®¡ç®— (${i + 1}/${coverages.length})...`;
                completePolicyBtn.disabled = true;
              }
              
              console.log(`ğŸ”„ [${i + 1}/${coverages.length}] é‡æ–°è®¡ç®—è´£ä»»: ${coverage.name}`);
              
              // ğŸ› ä¿®å¤ï¼šåº”è¯¥æ˜¯parseResultï¼Œä¸æ˜¯result
              if (coverage.parseResult?.payoutAmount?.details?.tiers) {
                for (let j = 0; j < coverage.parseResult.payoutAmount.details.tiers.length; j++) {
                  const tier = coverage.parseResult.payoutAmount.details.tiers[j];
                  
                  if (!tier.keyAmounts || tier.keyAmounts.length === 0) {
                    console.log(`   âš ï¸ é˜¶æ®µ${j + 1}æ²¡æœ‰keyAmountsï¼Œè·³è¿‡`);
                    continue;
                  }
                  
                  console.log(`   ğŸ”„ é‡æ–°è®¡ç®—é˜¶æ®µ${j + 1}: ${tier.period}`);
                  
                  try {
                    const response = await fetch('http://localhost:4000/api/coverage/recalculate', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ tier, policyInfo: newPolicyInfo })
                    });
                    
                    if (!response.ok) {
                      console.error(`   âŒ é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—å¤±è´¥: ${response.status}`);
                      continue;
                    }
                    
                    const result = await response.json();
                    if (result.success && result.keyAmounts) {
                      tier.keyAmounts = result.keyAmounts;
                      
                      // ğŸ¯ åŒæ—¶æ›´æ–°tierçš„startAgeå’ŒendAgeï¼ˆç”¨äºè¾“å…¥æ¡†æ˜¾ç¤ºï¼‰
                      if (result.keyAmounts.length > 0) {
                        tier.startAge = result.keyAmounts[0].age;
                        tier.endAge = result.keyAmounts[result.keyAmounts.length - 1].age;
                        console.log(`   âœ… é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—æˆåŠŸï¼Œå¹´é¾„èŒƒå›´ï¼š${tier.startAge}å²-${tier.endAge}å²ï¼Œå…±${result.keyAmounts.length}ä¸ªé‡‘é¢èŠ‚ç‚¹`);
                      } else {
                        console.log(`   âœ… é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—æˆåŠŸï¼Œå…±${result.keyAmounts.length}ä¸ªé‡‘é¢èŠ‚ç‚¹`);
                      }
                    } else {
                      console.error(`   âŒ é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—å“åº”å¼‚å¸¸:`, result);
                    }
                  } catch (err) {
                    console.error(`   âŒ é˜¶æ®µ${j + 1}é‡æ–°è®¡ç®—ç½‘ç»œé”™è¯¯:`, err);
                  }
                }
                successCount++;
              }
            }
            
            console.log(`âœ… æ‰€æœ‰è´£ä»»é‡æ–°è®¡ç®—å®Œæˆï¼ŒæˆåŠŸæ›´æ–°${successCount}ä¸ªè´£ä»»`);
            showMessage(`âœ… å·²è‡ªåŠ¨æ›´æ–°${successCount}ä¸ªè´£ä»»çš„é‡‘é¢æ•°æ®`, 'success', 3000);
          } finally {
            if (completePolicyBtn) {
              completePolicyBtn.textContent = originalText;
              completePolicyBtn.disabled = false;
            }
          }
        }
        
        const policyData = {
          id: editingPolicyId || Date.now().toString(),
          insuranceCompany: insuranceCompanyEl?.value.trim() || '',
          productName: productNameEl?.value.trim() || '',
          policyType: policyTypeEl?.value || currentPolicyType || 'critical_illness',
          insuredPerson: insuredPersonEl?.value || '',
          birthYear: newPolicyInfo.birthYear,
          policyStartYear: newPolicyInfo.policyStartYear,
          coverageEndYear: newPolicyInfo.coverageEndYear,
          totalPaymentPeriod: newPolicyInfo.totalPaymentPeriod,
          annualPremium: newPolicyInfo.annualPremium,
          basicSumInsured: newPolicyInfo.basicSumInsured,
          coverages: coverages || []
        };
        
        console.log('æ”¶é›†çš„ä¿å•æ•°æ®:', JSON.stringify(policyData, null, 2));
        
        // 2. éªŒè¯æ•°æ®ï¼ˆéªŒè¯æœåŠ¡ï¼‰
        if (typeof ValidationService === 'undefined') {
          console.error('ValidationService æœªå®šä¹‰ï¼');
          alert('ç³»ç»Ÿé”™è¯¯ï¼šéªŒè¯æœåŠ¡æœªåŠ è½½');
          return;
        }
        
        const validation = ValidationService.validatePolicyInput(policyData);
        console.log('éªŒè¯ç»“æœ:', validation);
        if (!validation.valid) {
          alert('âŒ ' + validation.message);
          console.error('éªŒè¯å¤±è´¥:', validation.message);
          return;
        }
        
        // 3. åˆ›å»ºåˆåŒå¯¹è±¡ï¼ˆç®¡ç†æœåŠ¡ï¼‰
        if (typeof PolicyManagerService === 'undefined') {
          console.error('PolicyManagerService æœªå®šä¹‰ï¼');
          alert('ç³»ç»Ÿé”™è¯¯ï¼šä¿å•ç®¡ç†æœåŠ¡æœªåŠ è½½');
          return;
        }
        
        const policy = PolicyManagerService.create(policyData);
        console.log('åˆ›å»ºçš„ä¿å•å¯¹è±¡:', JSON.stringify(policy, null, 2));
        
        // 4. ä¿å­˜åˆ°åˆ—è¡¨ï¼ˆç®¡ç†æœåŠ¡ï¼‰
        PolicyManagerService.save(policies, policy);
        console.log('ä¿å­˜åçš„ä¿å•åˆ—è¡¨:', policies);
        console.log('ä¿å•åˆ—è¡¨æ•°é‡:', policies.length);
        
        // 5. æŒä¹…åŒ–å­˜å‚¨ï¼ˆå­˜å‚¨æœåŠ¡ï¼‰
        if (typeof PolicyStorageService === 'undefined') {
          console.error('PolicyStorageService æœªå®šä¹‰ï¼');
          alert('ç³»ç»Ÿé”™è¯¯ï¼šå­˜å‚¨æœåŠ¡æœªåŠ è½½');
          return;
        }
        
        PolicyStorageService.save(policies);
        console.log('å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        
        // éªŒè¯å­˜å‚¨æ˜¯å¦æˆåŠŸ
        const savedPolicies = PolicyStorageService.load();
        console.log('ä»å­˜å‚¨è¯»å–çš„ä¿å•åˆ—è¡¨:', savedPolicies);
        console.log('å­˜å‚¨éªŒè¯:', savedPolicies.length === policies.length ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥');
        
        // 6. æ›´æ–°UI
        console.log('å¼€å§‹æ›´æ–°UI...');
        if (typeof showPolicyCards === 'function') {
          showPolicyCards();
        } else {
          console.error('showPolicyCards å‡½æ•°æœªå®šä¹‰ï¼');
        }
        
        if (typeof showMessage === 'function') {
          showMessage('âœ… åˆåŒå·²ä¿å­˜', 'success');
        } else {
          alert('âœ… åˆåŒå·²ä¿å­˜');
        }
        
        console.log('========== åˆåŒå¡«å†™å®Œæˆ âœ… ==========');
      } catch (error) {
        console.error('========== å®ŒæˆåˆåŒå¡«å†™æ—¶å‘ç”Ÿé”™è¯¯ ==========');
        console.error('é”™è¯¯è¯¦æƒ…:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        alert('ä¿å­˜åˆåŒå¤±è´¥: ' + (error.message || error.toString()));
      }
    }
    
    // æ˜¾ç¤ºåˆåŒå¡ç‰‡åˆ—è¡¨
    function showPolicyCards() {
      try {
        console.log('æ˜¾ç¤ºåˆåŒå¡ç‰‡åˆ—è¡¨...');
        const container = document.getElementById('policyCardsContainer');
        const mainContent = document.getElementById('mainContent');
        const pageTitle = document.getElementById('pageTitle');
        
        if (!container) {
          console.error('policyCardsContainer å…ƒç´ ä¸å­˜åœ¨ï¼');
          alert('ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°åˆåŒå¡ç‰‡å®¹å™¨');
          return;
        }
        
        if (!mainContent) {
          console.error('mainContent å…ƒç´ ä¸å­˜åœ¨ï¼');
          alert('ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°ä¸»å†…å®¹åŒºåŸŸ');
          return;
        }
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸º"å®¶åº­ä¿å•ç®¡å®¶"
        if (pageTitle) {
          pageTitle.textContent = 'å®¶åº­ä¿å•ç®¡å®¶';
        }
        
        // éšè—è¿”å›æŒ‰é’®
        const backButton = document.getElementById('backButton');
        if (backButton) {
          backButton.style.display = 'none';
        }
        
        container.style.display = 'block';
        mainContent.style.display = 'none';
        console.log('å·²åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€');
        
        // æ¸…é™¤ç­›é€‰æ¡ä»¶ï¼ˆé»˜è®¤æ˜¾ç¤ºæ‰€æœ‰ï¼‰
        window.filteredMember = null;
        
        // æ¸²æŸ“å®¶åº­æˆå‘˜ç»Ÿè®¡
        renderFamilyMemberStats();
        
        // æ›´æ–°é€‰ä¸­çŠ¶æ€ï¼ˆé»˜è®¤é€‰ä¸­"å®¶åº­"ï¼‰
        setTimeout(() => {
          updateFamilyMemberSelection(null);
        }, 100);
        
        // æ¸²æŸ“åˆåŒå¡ç‰‡
        renderPolicyCards();
      } catch (error) {
        console.error('æ˜¾ç¤ºåˆåŒå¡ç‰‡åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
        alert('æ˜¾ç¤ºåˆåŒå¡ç‰‡å¤±è´¥: ' + error.message);
      }
    }
    
    // æ¸²æŸ“å®¶åº­æˆå‘˜ç»Ÿè®¡
    function renderFamilyMemberStats() {
      try {
        const statsContainer = document.getElementById('familyMemberStats');
        if (!statsContainer) {
          console.error('familyMemberStats å…ƒç´ ä¸å­˜åœ¨ï¼');
          return;
        }
        
        // å®šä¹‰æ‰€æœ‰å¯èƒ½çš„å®¶åº­æˆå‘˜é…ç½®ï¼ˆä»…æ˜¾ç¤ºè¢«ä¿é™©äººï¼‰
        // ä½¿ç”¨æœ¬åœ°å›¾ç‰‡ï¼ˆå·²å¤åˆ¶åˆ°demo/imagesç›®å½•ï¼‰
        // å®¶åº­å›¾æ ‡ï¼šä½¿ç”¨å®¶åº­å›¾ç‰‡ï¼ˆå·²å©š+å…»å¨ƒçš„å›¾ç‰‡ï¼ŒåŒ…å«ä¸‰ä¸ªäººï¼‰
        const familyIcon = '<img src="images/family.png" alt="å®¶åº­" style="width: 120px; height: 120px; object-fit: contain;" onerror="console.error(\'å®¶åº­å›¾ç‰‡åŠ è½½å¤±è´¥\', this.src);" />';
        // æœ¬äººå›¾æ ‡ï¼šä½¿ç”¨å•äººå›¾ç‰‡ï¼ˆå•èº«+ä¸å…»å¨ƒçš„å›¾ç‰‡ï¼Œå•äººï¼‰
        const selfIcon = '<img src="images/self.png" alt="æœ¬äºº" style="width: 120px; height: 120px; object-fit: contain;" onerror="console.error(\'æœ¬äººå›¾ç‰‡åŠ è½½å¤±è´¥\', this.src);" />';
        
        // é…å¶å›¾æ ‡ï¼šä½¿ç”¨å•äººå›¾ç‰‡ï¼ˆä½¿ç”¨å¦ä¸€ä¸ªæ€§åˆ«çš„å•èº«å›¾ç‰‡ï¼‰
        const spouseIcon = '<img src="images/spouse.png" alt="é…å¶" style="width: 120px; height: 120px; object-fit: contain;" onerror="console.error(\'é…å¶å›¾ç‰‡åŠ è½½å¤±è´¥\', this.src);" />';
        
        const allFamilyMembers = [
          { role: 'å®¶åº­', icon: familyIcon, key: 'all', alwaysShow: true, isImage: true },
          { role: 'æœ¬äºº', icon: selfIcon, key: 'æœ¬äºº', alwaysShow: true, isImage: true },
          { role: 'é…å¶', icon: spouseIcon, key: 'é…å¶', alwaysShow: false, isImage: true },
          { role: 'æœ¬äººçˆ¶äº²', icon: 'ğŸ‘´', key: 'æœ¬äººçˆ¶äº²', alwaysShow: false },
          { role: 'æœ¬äººæ¯äº²', icon: 'ğŸ‘µ', key: 'æœ¬äººæ¯äº²', alwaysShow: false }
        ];
        
        // ç»Ÿè®¡æ¯ä¸ªè¢«ä¿é™©äººçš„ä¿å•æ•°é‡
        const stats = {};
        let totalCount = 0;
        const hasMember = {}; // è®°å½•å“ªäº›æˆå‘˜æœ‰ä¿å•
        const childrenMembers = []; // è®°å½•æ‰€æœ‰å­å¥³æˆå‘˜
        
        policies.forEach(policy => {
          totalCount++;
          const insuredPerson = policy.insuredPerson || 'æœªæŒ‡å®š';
          
          // ç»Ÿè®¡å…·ä½“æˆå‘˜
          if (!stats[insuredPerson]) {
            stats[insuredPerson] = 0;
          }
          stats[insuredPerson]++;
          hasMember[insuredPerson] = true;
          
          // ğŸ¯ æ”¶é›†å­å¥³æˆå‘˜ï¼ˆå­å¥³1ã€å­å¥³2ç­‰ï¼‰ï¼Œä½†ä¸å†åˆå¹¶ç»Ÿè®¡
          if (insuredPerson.startsWith('å­å¥³') && !childrenMembers.includes(insuredPerson)) {
            childrenMembers.push(insuredPerson);
            }
        });
        
        // ğŸ¯ åŠ¨æ€æ·»åŠ æ¯ä¸ªå­å¥³æˆå‘˜åˆ°allFamilyMembers
        childrenMembers.sort().forEach(childKey => {
          allFamilyMembers.push({
            role: childKey, // æ˜¾ç¤º"å­å¥³1"ã€"å­å¥³2"
            icon: 'ğŸ‘¶',
            key: childKey,
            alwaysShow: false
          });
        });
        
        // ç­›é€‰è¦æ˜¾ç¤ºçš„å®¶åº­æˆå‘˜ï¼šå§‹ç»ˆæ˜¾ç¤ºçš„ + æœ‰ä¿å•çš„æˆå‘˜
        const familyMembers = allFamilyMembers.filter(member => {
          if (member.alwaysShow) {
            return true; // å§‹ç»ˆæ˜¾ç¤ºï¼šå®¶åº­ã€æœ¬äºº
          }
          // å…¶ä»–æˆå‘˜ï¼šåªæœ‰å½“æœ‰ä¿å•æ—¶æ‰æ˜¾ç¤º
          return hasMember[member.key];
        });
        
        // ç”ŸæˆHTML
        const statsHtml = familyMembers.map(member => {
          let count = 0;
          if (member.key === 'all') {
            count = totalCount;
          } else {
            count = stats[member.key] || 0;
          }
          
          const onClick = member.key === 'all'
            ? 'onclick="filterPoliciesByMember(null)" style="cursor: pointer;"'
            : `onclick="filterPoliciesByMember('${member.key}')" style="cursor: pointer;"`;
          
          // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œç›´æ¥æ’å…¥HTMLï¼›å¦‚æœæ˜¯SVGï¼Œä¹Ÿç›´æ¥æ’å…¥ï¼›å¦åˆ™ä½¿ç”¨emoji
          const iconHtml = member.isImage ? member.icon : (member.isSvg ? member.icon : `<div style="font-size: 40px; line-height: 1;">${member.icon}</div>`);
          
          return `
            <div ${onClick} class="family-member-card" style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; width: 150px; padding: 8px 10px 10px 10px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; transition: all 0.3s; cursor: pointer; position: relative; box-sizing: border-box;" onmouseover="if(!this.classList.contains('selected')) { this.style.borderColor='#5FC8D4'; this.style.boxShadow='0 2px 8px rgba(95, 200, 212, 0.2)'; }" onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'; }">
              <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 120px; height: 120px; flex-shrink: 0;">
                ${iconHtml}
                <div style="position: absolute; top: 8px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #666; text-align: center; line-height: 1; white-space: nowrap;">${member.role}</div>
                <div style="position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 14px; font-weight: 600; color: #333; text-align: center; line-height: 1; white-space: nowrap;">${count}ä»½</div>
              </div>
            </div>
          `;
        }).join('');
        
        const innerContainer = statsContainer.querySelector('div');
        if (innerContainer) {
          innerContainer.innerHTML = statsHtml;
        } else {
          statsContainer.innerHTML = `<div style="display: flex; align-items: center; gap: 16px; overflow-x: auto; padding: 8px 0;">${statsHtml}</div>`;
        }
        
        console.log('å®¶åº­æˆå‘˜ç»Ÿè®¡æ¸²æŸ“å®Œæˆ');
      } catch (error) {
        console.error('æ¸²æŸ“å®¶åº­æˆå‘˜ç»Ÿè®¡æ—¶å‘ç”Ÿé”™è¯¯:', error);
      }
    }
    
    // æŒ‰è¢«ä¿é™©äººç­›é€‰ä¿å•
    function filterPoliciesByMember(memberKey) {
      // å¦‚æœmemberKeyä¸ºnullï¼Œæ˜¾ç¤ºæ‰€æœ‰ä¿å•
      // å¦‚æœmemberKeyä¸º'å­å¥³'ï¼Œæ˜¾ç¤ºæ‰€æœ‰ä»¥'å­å¥³'å¼€å¤´çš„ä¿å•
      // å¦åˆ™æ˜¾ç¤ºæŒ‡å®šè¢«ä¿é™©äººçš„ä¿å•
      window.filteredMember = memberKey;
      
      // æ›´æ–°å®¶åº­æˆå‘˜ç»Ÿè®¡çš„é€‰ä¸­çŠ¶æ€
      updateFamilyMemberSelection(memberKey);
      
      // é‡æ–°æ¸²æŸ“ä¿å•å¡ç‰‡
      renderPolicyCards();
    }
    
    // æ›´æ–°å®¶åº­æˆå‘˜é€‰ä¸­çŠ¶æ€
    function updateFamilyMemberSelection(selectedKey) {
      const statsContainer = document.getElementById('familyMemberStats');
      if (!statsContainer) return;
      
      const memberCards = statsContainer.querySelectorAll('.family-member-card');
      memberCards.forEach(card => {
        // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
        card.classList.remove('selected');
        card.style.background = 'white';
        card.style.borderColor = '#e0e0e0';
        card.style.boxShadow = 'none';
        
        // ç§»é™¤é€‰ä¸­æ ‡è®°
        const existingCheck = card.querySelector('.selected-check');
        if (existingCheck) {
          existingCheck.remove();
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯é€‰ä¸­çš„æˆå‘˜
        const onclickAttr = card.getAttribute('onclick');
        if (selectedKey === null && onclickAttr && onclickAttr.includes('filterPoliciesByMember(null)')) {
          // é€‰ä¸­"å®¶åº­"
          card.classList.add('selected');
          card.style.background = '#E6F7FF';
          card.style.borderColor = '#5FC8D4';
          card.style.boxShadow = '0 2px 8px rgba(1, 188, 214, 0.2)';
          // æ·»åŠ é€‰ä¸­æ ‡è®°
          const checkMark = document.createElement('div');
          checkMark.className = 'selected-check';
          checkMark.style.cssText = 'position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background: #5FC8D4; border-radius: 50%; display: flex; align-items: center; justify-content: center;';
          checkMark.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6L5 9L10 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          card.appendChild(checkMark);
        } else if (selectedKey !== null && onclickAttr && onclickAttr.includes(`filterPoliciesByMember('${selectedKey}')`)) {
          // é€‰ä¸­å…·ä½“æˆå‘˜
          card.classList.add('selected');
          card.style.background = '#E6F7FF';
          card.style.borderColor = '#5FC8D4';
          card.style.boxShadow = '0 2px 8px rgba(1, 188, 214, 0.2)';
          // æ·»åŠ é€‰ä¸­æ ‡è®°
          const checkMark = document.createElement('div');
          checkMark.className = 'selected-check';
          checkMark.style.cssText = 'position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background: #5FC8D4; border-radius: 50%; display: flex; align-items: center; justify-content: center;';
          checkMark.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6L5 9L10 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          card.appendChild(checkMark);
        }
      });
    }
    
    // UIåè°ƒå‡½æ•°ï¼šè°ƒç”¨æ¸²æŸ“æœåŠ¡æ›´æ–°DOM
    function renderPolicyCards() {
      try {
        console.log('å¼€å§‹æ¸²æŸ“åˆåŒå¡ç‰‡...');
        console.log('ä¿å•åˆ—è¡¨:', policies);
        console.log('ä¿å•æ•°é‡:', policies.length);
        
        const container = document.getElementById('policyCardsList');
        if (!container) {
          console.error('policyCardsList å…ƒç´ ä¸å­˜åœ¨ï¼');
          return;
        }
        
        if (typeof UIRenderService === 'undefined') {
          console.error('UIRenderService æœªå®šä¹‰ï¼');
          container.innerHTML = '<p style="color: #ef4444; padding: 20px;">ç³»ç»Ÿé”™è¯¯ï¼šUIæ¸²æŸ“æœåŠ¡æœªåŠ è½½</p>';
          return;
        }
        
        if (typeof DataFormatterService === 'undefined') {
          console.error('DataFormatterService æœªå®šä¹‰ï¼');
          container.innerHTML = '<p style="color: #ef4444; padding: 20px;">ç³»ç»Ÿé”™è¯¯ï¼šæ•°æ®æ ¼å¼åŒ–æœåŠ¡æœªåŠ è½½</p>';
          return;
        }
        
        // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤ä¿å•
        let filteredPolicies = policies;
        if (window.filteredMember !== undefined && window.filteredMember !== null) {
          if (window.filteredMember === 'å­å¥³') {
            // ç­›é€‰æ‰€æœ‰ä»¥"å­å¥³"å¼€å¤´çš„è¢«ä¿é™©äºº
            filteredPolicies = policies.filter(p => p.insuredPerson && p.insuredPerson.startsWith('å­å¥³'));
          } else {
            // ç­›é€‰æŒ‡å®šè¢«ä¿é™©äºº
            filteredPolicies = policies.filter(p => p.insuredPerson === window.filteredMember);
          }
          console.log('ç­›é€‰åçš„ä¿å•æ•°é‡:', filteredPolicies.length);
        }
        
        // æ·»åŠ æ–°åˆåŒå¡ç‰‡ï¼ˆå§‹ç»ˆæ˜¾ç¤ºåœ¨ç¬¬ä¸€ä½ï¼‰
        // æ ·å¼ä¸ä¿å•å¡ç‰‡ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨è™šçº¿è¾¹æ¡†å’Œæµ…è‰²èƒŒæ™¯åŒºåˆ†
        const addCardHtml = `
          <div onclick="window.showAddPolicyForm()" style="border: 2px dashed #CAF4F7; border-radius: 12px; padding: 20px; background: #f8f9fa; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.borderColor='#CAF4F7'; this.style.background='#f0f9fa'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.borderColor='#CAF4F7'; this.style.background='#f8f9fa'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
            <div style="font-size: 48px; color: #5FC8D4; margin-bottom: 12px; line-height: 1;">+</div>
            <div style="font-size: 16px; font-weight: 600; color: #333;">æ·»åŠ æ–°åˆåŒ</div>
          </div>
        `;
        
        // æ¸²æŸ“ä¿å•å¡ç‰‡
        const policyCardsHtml = UIRenderService.renderPolicyCards(filteredPolicies);
        
        // åˆå¹¶HTMLï¼ˆæ·»åŠ æŒ‰é’®åœ¨å‰ï¼Œä¿å•å¡ç‰‡åœ¨åï¼‰
        container.innerHTML = addCardHtml + policyCardsHtml;
        console.log('ç”Ÿæˆçš„HTMLé•¿åº¦:', container.innerHTML.length);
        console.log('åˆåŒå¡ç‰‡æ¸²æŸ“å®Œæˆ âœ…');
      } catch (error) {
        console.error('æ¸²æŸ“åˆåŒå¡ç‰‡æ—¶å‘ç”Ÿé”™è¯¯:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        const container = document.getElementById('policyCardsList');
        if (container) {
          container.innerHTML = '<p style="color: #ef4444; padding: 20px;">æ¸²æŸ“åˆåŒå¡ç‰‡å¤±è´¥: ' + error.message + '</p>';
        }
      }
    }
    
    // ç¼–è¾‘åˆåŒ
    // ç¼–è¾‘ä¿å•ï¼ˆç¡®ä¿å…¨å±€å¯è®¿é—®ï¼‰
    window.editPolicy = function(policyId) {
      const policy = policies.find(p => p.id === policyId);
      if (!policy) return;
      
      editingPolicyId = policyId;
      
      // ğŸ”¥ æ¸…ç©ºè§£æåŒºåŸŸï¼ˆç¼–è¾‘ä¿å•æ—¶ä¸æ˜¾ç¤ºè§£æå†…å®¹ï¼Œåªæœ‰ç‚¹å‡»è´£ä»»ç¼–è¾‘æ—¶æ‰æ˜¾ç¤ºï¼‰
      window.currentAnalyzingCoverage = null;
      parseResult = null;
      document.getElementById('pageClauseInput').value = '';
      document.getElementById('resultContainer').innerHTML = '<p style="color: #999; padding: 20px; text-align: center;">è¯·ç‚¹å‡»è´£ä»»åˆ—è¡¨ä¸­çš„"ç¼–è¾‘"æŒ‰é’®æ¥æŸ¥çœ‹æˆ–ä¿®æ”¹è´£ä»»å†…å®¹</p>';
      document.getElementById('actionsSection').style.display = 'none';
      
      // æ˜¾ç¤ºè¡¨å•
      document.getElementById('policyCardsContainer').style.display = 'none';
      document.getElementById('mainContent').style.display = 'grid';
      
      // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸º"ä¿å•æ™ºèƒ½å½•å…¥è§£æ"
      const pageTitle = document.getElementById('pageTitle');
      if (pageTitle) {
        pageTitle.textContent = 'ä¿é™©æ™ºèƒ½å½•å…¥è§£æåŠ©æ‰‹';
      }
      
      // æ˜¾ç¤ºè¿”å›æŒ‰é’®
      const backBtn = document.getElementById('backButton');
      if (backBtn) {
        backBtn.style.display = 'block';
      }
      
      // ç¡®ä¿å‡ºç”Ÿå¹´ä»½ä¸‹æ‹‰æ¡†å·²åˆå§‹åŒ–ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²æ˜¾ç¤ºï¼‰
      setTimeout(() => {
        const birthYearSelect = document.getElementById('birthYear');
        if (birthYearSelect) {
          // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–ï¼Œç¡®ä¿ä¸‹æ‹‰æ¡†æœ‰é€‰é¡¹
          console.log('é‡æ–°åˆå§‹åŒ–å‡ºç”Ÿå¹´ä»½ä¸‹æ‹‰æ¡†...');
          UtilityService.initPolicyStartYearOptions();
          
          // å¡«å……è¡¨å•
          if (policy.insuranceCompany) {
            InsuranceCompanySelectorService.setSelectedCompany('insuranceCompany', policy.insuranceCompany);
          }
          document.getElementById('productName').value = policy.productName;
          document.getElementById('insuredPerson').value = policy.insuredPerson || '';
          
          // å…ˆè®¾ç½®å‡ºç”Ÿå¹´ä»½ï¼Œç„¶åæ›´æ–°é€‰é¡¹
          if (policy.birthYear) {
            document.getElementById('birthYear').value = policy.birthYear;
            UtilityService.updatePolicyStartYearOptions();
          }
          
          // è®¾ç½®æŠ•ä¿å¼€å§‹å¹´ä»½å’Œä¿éšœç»“æŸå¹´ä»½
          if (policy.policyStartYear) {
            document.getElementById('policyStartYear').value = policy.policyStartYear;
            UtilityService.updateCoverageEndYearOptions();
          }
          
          if (policy.coverageEndYear) {
            document.getElementById('coverageEndYear').value = policy.coverageEndYear;
          }
          
          // å¡«å……æ€»ç¼´è´¹æœŸé™å’Œæ¯å¹´ä¿è´¹
          if (policy.totalPaymentPeriod) {
            document.getElementById('totalPaymentPeriod').value = policy.totalPaymentPeriod === 'lifetime' ? 'lifetime' : policy.totalPaymentPeriod.toString();
          }
          if (policy.annualPremium) {
            document.getElementById('annualPremium').value = policy.annualPremium;
          }
          document.getElementById('basicSumInsured').value = (policy.basicSumInsured / 10000).toFixed(2); // å­˜å‚¨ä¸ºå…ƒï¼Œæ˜¾ç¤ºä¸ºä¸‡å…ƒ
          
          // é€‰æ‹©ä¿å•ç±»å‹
          const policyTypeSelect = document.getElementById('policyType');
          if (policyTypeSelect && policy.policyType) {
            policyTypeSelect.value = policy.policyType;
            currentPolicyType = policy.policyType;
          }
          
          // åŠ è½½è´£ä»»åˆ—è¡¨ï¼ˆåœ¨å³ä¾§æ˜¾ç¤ºï¼Œä½†ä¸æ˜¾ç¤ºè§£æå†…å®¹ï¼‰
          coverages = policy.coverages || [];
          
          // ğŸ”¥ æ¸…ç©º originalCalculatedAmountsï¼ˆç¼–è¾‘ä¿å•æ—¶ä¸é¢„åŠ è½½ï¼Œç­‰åˆ°ç¼–è¾‘å…·ä½“è´£ä»»æ—¶å†åˆå§‹åŒ–ï¼‰
          originalCalculatedAmounts = {};
          console.log(`ğŸ“¦ [åŠ è½½ä¿å•] å·²æ¸…ç©º originalCalculatedAmountsï¼Œå°†åœ¨ç¼–è¾‘è´£ä»»æ—¶é‡æ–°åˆå§‹åŒ–`);
          
          renderCoverageList();
          updateCompleteButton();
          
          console.log(`âœ… å·²åŠ è½½ä¿å•ä¿¡æ¯ï¼Œå…±${coverages.length}ä¸ªè´£ä»»ã€‚è¯·ç‚¹å‡»è´£ä»»åˆ—è¡¨ä¸­çš„"ç¼–è¾‘"æŒ‰é’®æŸ¥çœ‹è¯¦æƒ…ã€‚`);
        } else {
          console.error('å‡ºç”Ÿå¹´ä»½ä¸‹æ‹‰æ¡†å…ƒç´ ä¸å­˜åœ¨');
        }
      }, 50);
    }
    
    // åˆ é™¤ä¿å•ï¼ˆç¡®ä¿å…¨å±€å¯è®¿é—®ï¼‰
    window.deletePolicy = function(policyId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¿å•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
      }
      
      try {
        // ä½¿ç”¨ PolicyManagerService åˆ é™¤ä¿å•
        policies = PolicyManagerService.delete(policies, policyId);
        
        // ä¿å­˜åˆ° localStorageï¼ˆä½¿ç”¨æ­£ç¡®çš„æœåŠ¡åç§°ï¼‰
        PolicyStorageService.save(policies);
        
        // é‡æ–°æ¸²æŸ“ä¿å•å¡ç‰‡
        renderPolicyCards();
        
        showMessage('âœ… ä¿å•å·²åˆ é™¤', 'success');
        console.log('ä¿å•åˆ é™¤æˆåŠŸ âœ…');
      } catch (error) {
        console.error('åˆ é™¤ä¿å•æ—¶å‘ç”Ÿé”™è¯¯:', error);
        showMessage('âŒ åˆ é™¤ä¿å•å¤±è´¥: ' + error.message, 'error');
        alert('åˆ é™¤ä¿å•å¤±è´¥: ' + error.message);
      }
    }
    
    // æ˜¾ç¤ºæ·»åŠ åˆåŒè¡¨å•ï¼ˆç¡®ä¿å…¨å±€å¯è®¿é—®ï¼‰
    window.showAddPolicyForm = function() {
      try {
        console.log('showAddPolicyForm è¢«è°ƒç”¨');
        editingPolicyId = null;
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        coverages = []; // æ¸…ç©ºè´£ä»»åˆ—è¡¨
        window.currentAnalyzingCoverage = null; // æ¸…ç©ºå½“å‰åˆ†æä¸­çš„è´£ä»»
        parseResult = null; // æ¸…ç©ºè§£æç»“æœ
        
        // æ¸…ç©ºæ‰€æœ‰è¾“å…¥å­—æ®µ
        clearInput();
        
        const policyCardsContainer = document.getElementById('policyCardsContainer');
        const mainContent = document.getElementById('mainContent');
        
        if (!policyCardsContainer) {
          console.error('policyCardsContainer å…ƒç´ ä¸å­˜åœ¨');
          return;
        }
        
        if (!mainContent) {
          console.error('mainContent å…ƒç´ ä¸å­˜åœ¨');
          return;
        }
        
        policyCardsContainer.style.display = 'none';
        mainContent.style.display = 'grid';
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸º"ä¿å•æ™ºèƒ½å½•å…¥è§£æ"
        const pageTitle = document.getElementById('pageTitle');
        if (pageTitle) {
          pageTitle.textContent = 'ä¿å•æ™ºèƒ½å½•å…¥è§£æ';
        }
        
        // æ˜¾ç¤ºè¿”å›æŒ‰é’®
        const backBtn = document.getElementById('backButton');
        if (backBtn) {
          backBtn.style.display = 'block';
        }
        
        // æ¸…ç©ºè´£ä»»åˆ—è¡¨æ˜¾ç¤º
        renderCoverageList();
        
        // æ›´æ–°å®ŒæˆæŒ‰é’®çŠ¶æ€
        updateCompleteButton();
        
        // ç¡®ä¿å‡ºç”Ÿå¹´ä»½ä¸‹æ‹‰æ¡†å·²åˆå§‹åŒ–ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²æ˜¾ç¤ºï¼‰
        setTimeout(() => {
          const birthYearSelect = document.getElementById('birthYear');
          if (birthYearSelect) {
            // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–ï¼Œç¡®ä¿ä¸‹æ‹‰æ¡†æœ‰é€‰é¡¹
            console.log('é‡æ–°åˆå§‹åŒ–å‡ºç”Ÿå¹´ä»½ä¸‹æ‹‰æ¡†...');
            UtilityService.initPolicyStartYearOptions();
            
            // åˆå§‹åŒ–å®Œæˆåè®¾ç½®é»˜è®¤å€¼
            setTimeout(() => {
              UtilityService.setDefaultValues();
              // è®¾ç½®ä¿å•ç±»å‹é»˜è®¤å€¼ä¸º"é‡ç–¾é™©"
              const policyTypeSelect = document.getElementById('policyType');
              if (policyTypeSelect) {
                policyTypeSelect.value = 'critical_illness';
                currentPolicyType = 'critical_illness';
              }
              console.log('é»˜è®¤å€¼è®¾ç½®å®Œæˆ');
            }, 150);
          } else {
            console.error('å‡ºç”Ÿå¹´ä»½ä¸‹æ‹‰æ¡†å…ƒç´ ä¸å­˜åœ¨');
          }
        }, 100);
      } catch (error) {
        console.error('showAddPolicyForm æ‰§è¡Œé”™è¯¯:', error);
        alert('æ‰“å¼€æ·»åŠ åˆåŒè¡¨å•å¤±è´¥: ' + error.message);
      }
    };
    
    // UIåè°ƒå‡½æ•°ï¼šåŠ è½½ä¿å­˜çš„åˆåŒ
    function loadPolicies() {
      policies = PolicyStorageService.load();
    }

    // RuleStorageService å·²ç§»è‡³ services/rules/ruleStorage.js

    // ============================================================================
    // è§„åˆ™å®šä¹‰è¯´æ˜
    // ============================================================================
    // æ‰€æœ‰å­—æ®µè§£æè§„åˆ™å·²è¿ç§»åˆ°å¯¹åº”çš„ç‹¬ç«‹æœåŠ¡æ–‡ä»¶ï¼Œä¾¿äºåç»­ç»´æŠ¤æ–°è§„åˆ™ï¼š
    // - services/parsers/payoutAmountParser.js (èµ”ä»˜é‡‘é¢)
    // - services/parsers/payoutCountParser.js (èµ”ä»˜æ¬¡æ•°)
    // - services/parsers/groupingParser.js (æ˜¯å¦åˆ†ç»„)
    // - services/parsers/repeatablePayoutParser.js (æ˜¯å¦å¯ä»¥é‡å¤èµ”ä»˜)
    // - services/parsers/intervalPeriodParser.js (é—´éš”æœŸ)
    // - services/parsers/premiumWaiverParser.js (ç–¾ç—…å‘ç”Ÿæ˜¯å¦è±å…ä¿è´¹)
    // - services/parsers/conditionsParser.js (å…¶ä»–æ¡ä»¶)
    //
    // RuleDefinitionService å·²ç§»è‡³ services/rules/ruleDefinition.js
    // RuleBasedParser å·²ç§»è‡³ services/rules/ruleBasedParser.js
    // RuleManagementService å·²ç§»è‡³ services/rules/ruleManagement.js
    // ParseCoordinatorService å·²ç§»è‡³ services/parser/parseCoordinator.js
    // LLMParserService å·²ç§»è‡³ services/parser/llmParser.js
    // ============================================================================
    // æ³¨æ„ï¼šæ‰€æœ‰è§„åˆ™å®šä¹‰å·²è¿ç§»åˆ°å¯¹åº”çš„ç‹¬ç«‹æœåŠ¡æ–‡ä»¶ï¼ŒHTML æ–‡ä»¶ä¸­ä¸å†åŒ…å«è§„åˆ™å®šä¹‰
    // å¦‚éœ€ç»´æŠ¤è§„åˆ™ï¼Œè¯·ç›´æ¥ä¿®æ”¹å¯¹åº”çš„æœåŠ¡æ–‡ä»¶ï¼š
    // - services/parsers/payoutAmountParser.js
    // - services/parsers/payoutCountParser.js
    // - services/parsers/groupingParser.js
    // - services/parsers/repeatablePayoutParser.js
    // - services/parsers/intervalPeriodParser.js
    // - services/parsers/premiumWaiverParser.js
    // - services/parsers/conditionsParser.js
    // ============================================================================

    // RuleManagementService å·²ç§»è‡³ services/rules/ruleManagement.js
    // ParseCoordinatorService å·²ç§»è‡³ services/parser/parseCoordinator.js
    // LLMParserService å·²ç§»è‡³ services/parser/llmParser.js
    // ResultMergeService å·²ç§»è‡³ services/parser/resultMerge.js
    // RuleExtractionService å·²ç§»è‡³ services/rules/ruleExtraction.js

    // ==================== é‡‘é¢ç¼–è¾‘å’Œé‡ç½®åŠŸèƒ½ ====================
    
    // å­˜å‚¨åŸå§‹è®¡ç®—å€¼ï¼ˆç”¨äºé‡ç½®ï¼‰
    let originalCalculatedAmounts = {};
    
    // å­˜å‚¨å½“å‰æ‰€æœ‰é˜¶æ®µæ•°æ®
    let currentTiersData = [];
    
    /**
     * ç”ŸæˆMaxé€‰é¡¹HTML
     */
    function generateMaxOptionHTML(option, tierIndex, optIndex) {
      const base = option.base || 'basicSumInsured';
      const growthType = option.growthType || 'none';
      const ratio = option.ratio || 100;
      const interestRate = option.interestRate || 3.5;
      
      let paramsHTML = '';
      
      if (growthType === 'fixed') {
        // å›ºå®šæ¯”ä¾‹
        paramsHTML = `
          <div>
            <label style="font-size: 10px; color: #999; display: block; margin-bottom: 2px;">æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
            <input type="number" class="max-option-ratio" data-tier="${tierIndex}" data-option="${optIndex}" 
                   value="${ratio}" step="1" onchange="updateFormulaPreview(${tierIndex})"
                   style="width: 100%; padding: 4px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px;" />
          </div>
        `;
      } else if (growthType === 'simple' || growthType === 'compound') {
        // å•åˆ©/å¤åˆ©
        paramsHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
            <div>
              <label style="font-size: 10px; color: #999; display: block; margin-bottom: 2px;">åˆå§‹æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
              <input type="number" class="max-option-ratio" data-tier="${tierIndex}" data-option="${optIndex}" 
                     value="${ratio}" step="1" onchange="updateFormulaPreview(${tierIndex})"
                     style="width: 100%; padding: 4px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px;" />
            </div>
            <div>
              <label style="font-size: 10px; color: #999; display: block; margin-bottom: 2px;">å¢é•¿ç‡ï¼ˆ%ï¼‰</label>
              <input type="number" class="max-option-rate" data-tier="${tierIndex}" data-option="${optIndex}" 
                     value="${interestRate}" step="0.1" onchange="updateFormulaPreview(${tierIndex})"
                     style="width: 100%; padding: 4px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px;" />
            </div>
          </div>
        `;
      }
      
      return `
        <div class="max-option-item" data-tier="${tierIndex}" data-option="${optIndex}" 
             style="margin-bottom: 8px; padding: 8px; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <span style="font-size: 11px; font-weight: 600; color: #666;">é€‰é¡¹${optIndex + 1}</span>
            <button onclick="deleteMaxOption(${tierIndex}, ${optIndex})" type="button"
                    style="padding: 2px 6px; font-size: 10px; color: #f44336; background: #fff; border: 1px solid #f44336; border-radius: 2px; cursor: pointer;">
              ğŸ—‘ï¸
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">
            <div>
              <label style="font-size: 10px; color: #999; display: block; margin-bottom: 2px;">åŸºç¡€è¦ç´ </label>
              <select class="max-option-base" data-tier="${tierIndex}" data-option="${optIndex}" 
                      onchange="updateFormulaPreview(${tierIndex})"
                      style="width: 100%; padding: 4px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px;">
                <option value="basicSumInsured" ${base === 'basicSumInsured' ? 'selected' : ''}>åŸºæœ¬ä¿é¢</option>
                <option value="paidPremium" ${base === 'paidPremium' ? 'selected' : ''}>å·²äº¤ä¿è´¹</option>
                <option value="cashValue" ${base === 'cashValue' ? 'selected' : ''}>ç°é‡‘ä»·å€¼</option>
              </select>
            </div>
            <div>
              <label style="font-size: 10px; color: #999; display: block; margin-bottom: 2px;">å¢é•¿ç±»å‹</label>
              <select class="max-option-growth" data-tier="${tierIndex}" data-option="${optIndex}" 
                      onchange="updateMaxOptionParams(${tierIndex}, ${optIndex})"
                      style="width: 100%; padding: 4px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px;">
                <option value="none" ${growthType === 'none' ? 'selected' : ''}>æ— </option>
                <option value="fixed" ${growthType === 'fixed' ? 'selected' : ''}>å›ºå®šæ¯”ä¾‹</option>
                <option value="simple" ${growthType === 'simple' ? 'selected' : ''}>å•åˆ©</option>
                <option value="compound" ${growthType === 'compound' ? 'selected' : ''}>å¤åˆ©</option>
              </select>
            </div>
          </div>
          
          <div class="max-option-params" data-tier="${tierIndex}" data-option="${optIndex}">
            ${paramsHTML}
          </div>
        </div>
      `;
    }
    
    /**
     * æ›´æ–°Maxé€‰é¡¹å‚æ•°åŒºåŸŸ
     */
    function updateMaxOptionParams(tierIndex, optIndex) {
      const growthSelect = document.querySelector(`.max-option-growth[data-tier="${tierIndex}"][data-option="${optIndex}"]`);
      const paramsContainer = document.querySelector(`.max-option-params[data-tier="${tierIndex}"][data-option="${optIndex}"]`);
      
      if (!growthSelect || !paramsContainer) return;
      
      const growthType = growthSelect.value;
      let paramsHTML = '';
      
      if (growthType === 'fixed') {
        paramsHTML = `
          <div>
            <label style="font-size: 10px; color: #999; display: block; margin-bottom: 2px;">æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
            <input type="number" class="max-option-ratio" data-tier="${tierIndex}" data-option="${optIndex}" 
                   value="100" step="1" onchange="updateFormulaPreview(${tierIndex})"
                   style="width: 100%; padding: 4px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px;" />
          </div>
        `;
      } else if (growthType === 'simple' || growthType === 'compound') {
        paramsHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
            <div>
              <label style="font-size: 10px; color: #999; display: block; margin-bottom: 2px;">åˆå§‹æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
              <input type="number" class="max-option-ratio" data-tier="${tierIndex}" data-option="${optIndex}" 
                     value="100" step="1" onchange="updateFormulaPreview(${tierIndex})"
                     style="width: 100%; padding: 4px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px;" />
            </div>
            <div>
              <label style="font-size: 10px; color: #999; display: block; margin-bottom: 2px;">å¢é•¿ç‡ï¼ˆ%ï¼‰</label>
              <input type="number" class="max-option-rate" data-tier="${tierIndex}" data-option="${optIndex}" 
                     value="3.5" step="0.1" onchange="updateFormulaPreview(${tierIndex})"
                     style="width: 100%; padding: 4px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px;" />
            </div>
          </div>
        `;
      }
      
      paramsContainer.innerHTML = paramsHTML;
      updateFormulaPreview(tierIndex);
    }
    
    /**
     * æ·»åŠ Maxé€‰é¡¹
     */
    function addMaxOption(tierIndex) {
      const container = document.querySelector(`.max-options-container[data-tier="${tierIndex}"]`);
      if (!container) return;
      
      const currentOptions = container.querySelectorAll('.max-option-item').length;
      const newOption = {
        base: 'basicSumInsured',
        growthType: 'none'
      };
      
      const newOptionHTML = generateMaxOptionHTML(newOption, tierIndex, currentOptions);
      container.insertAdjacentHTML('beforeend', newOptionHTML);
      
      updateFormulaPreview(tierIndex);
    }
    
    /**
     * åˆ é™¤Maxé€‰é¡¹
     */
    function deleteMaxOption(tierIndex, optIndex) {
      const item = document.querySelector(`.max-option-item[data-tier="${tierIndex}"][data-option="${optIndex}"]`);
      if (!item) return;
      
      const container = item.parentElement;
      const remainingOptions = container.querySelectorAll('.max-option-item').length;
      
      if (remainingOptions <= 2) {
        alert('âš ï¸ Max/Minè‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹');
        return;
      }
      
      item.remove();
      
      // é‡æ–°ç¼–å·
      container.querySelectorAll('.max-option-item').forEach((item, newIndex) => {
        item.querySelector('span').textContent = `é€‰é¡¹${newIndex + 1}`;
        item.setAttribute('data-option', newIndex);
        
        // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„data-option
        item.querySelectorAll('[data-option]').forEach(el => {
          el.setAttribute('data-option', newIndex);
        });
      });
      
      updateFormulaPreview(tierIndex);
    }
    
    /**
     * ç”Ÿæˆå…¬å¼å‚æ•°HTML
     */
    function generateFormulaParamsHTML(tier, tierIndex) {
      const formulaType = tier.formulaType || 'fixed';
      const basicSumInsured = tier.basicSumInsured || 100;
      const interestRate = tier.interestRate || 3.5;
      const ratio = tier.ratio || 100;
      
      let html = '';
      
      if (formulaType === 'fixed') {
        // å›ºå®šé‡‘é¢
        html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <label style="font-size: 11px; color: #999; display: block; margin-bottom: 4px;">åŸºç¡€é‡‘é¢</label>
              <select class="base-amount-select" data-tier="${tierIndex}" 
                      onchange="updateFormulaPreview(${tierIndex})"
                      style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;">
                <option value="basicSumInsured">åŸºæœ¬ä¿é¢</option>
                <option value="paidPremium">å·²äº¤ä¿è´¹</option>
                <option value="cashValue">ç°é‡‘ä»·å€¼</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; color: #999; display: block; margin-bottom: 4px;">é‡‘é¢å€¼ï¼ˆä¸‡ï¼‰</label>
              <input type="number" class="base-amount-value" data-tier="${tierIndex}" value="${basicSumInsured}" step="0.1"
                     oninput="updateFormulaPreview(${tierIndex})"
                     style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;" />
            </div>
            <div>
              <label style="font-size: 11px; color: #999; display: block; margin-bottom: 4px;">æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
              <input type="number" class="ratio-input" data-tier="${tierIndex}" value="${ratio}" step="1"
                     oninput="updateFormulaPreview(${tierIndex})"
                     style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;" />
            </div>
          </div>
        `;
      } else if (formulaType === 'simple' || formulaType === 'compound') {
        // å•åˆ©/å¤åˆ©
        html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <label style="font-size: 11px; color: #999; display: block; margin-bottom: 4px;">åŸºç¡€é‡‘é¢</label>
              <select class="base-amount-select" data-tier="${tierIndex}" 
                      onchange="updateFormulaPreview(${tierIndex})"
                      style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;">
                <option value="basicSumInsured">åŸºæœ¬ä¿é¢</option>
                <option value="paidPremium">å·²äº¤ä¿è´¹</option>
                <option value="cashValue">ç°é‡‘ä»·å€¼</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; color: #999; display: block; margin-bottom: 4px;">é‡‘é¢å€¼ï¼ˆä¸‡ï¼‰</label>
              <input type="number" class="base-amount-value" data-tier="${tierIndex}" value="${basicSumInsured}" step="0.1"
                     style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;" />
            </div>
            <div>
              <label style="font-size: 11px; color: #999; display: block; margin-bottom: 4px;">åˆå§‹æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
              <input type="number" class="initial-ratio-input" data-tier="${tierIndex}" value="${ratio}" step="1"
                     oninput="updateFormulaPreview(${tierIndex})"
                     style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;" />
            </div>
            <div>
              <label style="font-size: 11px; color: #999; display: block; margin-bottom: 4px;">å¢é•¿ç‡ï¼ˆ%ï¼‰</label>
              <input type="number" class="interest-rate-input" data-tier="${tierIndex}" value="${interestRate}" step="0.1"
                     oninput="updateFormulaPreview(${tierIndex})"
                     style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;" />
            </div>
          </div>
        `;
      } else if (formulaType === 'max' || formulaType === 'min') {
        // Max/Minæ¯”è¾ƒ
        const maxOptions = tier.maxOptions || [
          { base: 'basicSumInsured', growthType: 'none' },
          { base: 'paidPremium', growthType: 'none' }
        ];
        
        html = `
          <div style="border: 1px dashed #e0e0e0; border-radius: 4px; padding: 8px; background: #fafafa;">
            <div style="font-size: 11px; color: #999; margin-bottom: 8px; font-weight: 600;">${formulaType === 'max' ? 'Max' : 'Min'}é€‰é¡¹é…ç½®ï¼š</div>
            <div class="max-options-container" data-tier="${tierIndex}">
              ${maxOptions.map((option, optIndex) => generateMaxOptionHTML(option, tierIndex, optIndex)).join('')}
            </div>
            <button onclick="addMaxOption(${tierIndex})" type="button"
                    style="margin-top: 8px; padding: 6px 12px; font-size: 11px; color: #5FC8D4; background: #fff; border: 1px dashed #CAF4F7; border-radius: 3px; cursor: pointer; width: 100%;">
              â• æ·»åŠ æ–°é€‰é¡¹
            </button>
          </div>
        `;
      }
      
      return html;
    }
    
    /**
     * æ›´æ–°å…¬å¼å‚æ•°åŒºåŸŸ
     */
    function updateFormulaParams(tierIndex) {
      const select = document.querySelector(`.formula-type-select[data-tier="${tierIndex}"]`);
      const container = document.querySelector(`.formula-params-container[data-tier="${tierIndex}"]`);
      
      if (!select || !container) return;
      
      const formulaType = select.value;
      const tier = currentTiersData[tierIndex] || {};
      tier.formulaType = formulaType;
      
      // é‡æ–°ç”Ÿæˆå‚æ•°HTML
      container.innerHTML = generateFormulaParamsHTML(tier, tierIndex);
      
      // æ›´æ–°å…¬å¼é¢„è§ˆ
      updateFormulaPreview(tierIndex);
    }
    
    /**
     * æ›´æ–°å…¬å¼é¢„è§ˆ
     */
    function updateFormulaPreview(tierIndex) {
      const formulaTypeSelect = document.querySelector(`.formula-type-select[data-tier="${tierIndex}"]`);
      const previewSpan = document.querySelector(`.formula-preview[data-tier="${tierIndex}"]`);
      
      if (!formulaTypeSelect || !previewSpan) return;
      
      const formulaType = formulaTypeSelect.value;
      let preview = '';
      
      if (formulaType === 'fixed') {
        const baseAmount = document.querySelector(`.base-amount-select[data-tier="${tierIndex}"]`)?.selectedOptions[0]?.text || 'åŸºæœ¬ä¿é¢';
        const ratio = document.querySelector(`.ratio-input[data-tier="${tierIndex}"]`)?.value || 100;
        preview = `${baseAmount} Ã— ${ratio}%`;
      } else if (formulaType === 'simple') {
        const baseAmount = document.querySelector(`.base-amount-select[data-tier="${tierIndex}"]`)?.selectedOptions[0]?.text || 'åŸºæœ¬ä¿é¢';
        const rate = document.querySelector(`.interest-rate-input[data-tier="${tierIndex}"]`)?.value || 3.5;
        preview = `${baseAmount} Ã— (1 + ${rate}% Ã— n)`;
      } else if (formulaType === 'compound') {
        const baseAmount = document.querySelector(`.base-amount-select[data-tier="${tierIndex}"]`)?.selectedOptions[0]?.text || 'åŸºæœ¬ä¿é¢';
        const rate = document.querySelector(`.interest-rate-input[data-tier="${tierIndex}"]`)?.value || 3.5;
        preview = `${baseAmount} Ã— (1 + ${rate}%)^n`;
      } else if (formulaType === 'max' || formulaType === 'min') {
        // ç”ŸæˆMax/Miné¢„è§ˆ
        const options = document.querySelectorAll(`.max-option-item[data-tier="${tierIndex}"]`);
        const optionTexts = [];
        
        options.forEach((optionEl, optIndex) => {
          const baseSelect = optionEl.querySelector(`.max-option-base`);
          const growthSelect = optionEl.querySelector(`.max-option-growth`);
          const ratioInput = optionEl.querySelector(`.max-option-ratio`);
          const rateInput = optionEl.querySelector(`.max-option-rate`);
          
          if (!baseSelect || !growthSelect) return;
          
          const baseText = baseSelect.selectedOptions[0]?.text || 'åŸºæœ¬ä¿é¢';
          const growthType = growthSelect.value;
          
          let optionText = baseText;
          
          if (growthType === 'fixed') {
            const ratio = ratioInput?.value || 100;
            optionText = `${baseText}Ã—${ratio}%`;
          } else if (growthType === 'simple') {
            const rate = rateInput?.value || 3.5;
            optionText = `${baseText}Ã—(1+${rate}%Ã—n)`;
          } else if (growthType === 'compound') {
            const rate = rateInput?.value || 3.5;
            optionText = `${baseText}Ã—(1+${rate}%)^n`;
          }
          
          optionTexts.push(optionText);
        });
        
        preview = `${formulaType === 'max' ? 'Max' : 'Min'}(${optionTexts.join(', ')})`;
      }
      
      previewSpan.textContent = preview;
    }
    
    /**
     * åˆ‡æ¢å…¬å¼ç¼–è¾‘å™¨æ˜¾ç¤º/éšè—
     */
    function toggleFormulaEditor(tierIndex) {
      const container = document.querySelector(`.formula-editor-container[data-tier="${tierIndex}"]`);
      const button = document.querySelector(`.formula-edit-toggle[data-tier="${tierIndex}"]`);
      
      if (!container || !button) return;
      
      if (container.style.display === 'none' || container.style.display === '') {
        // å±•å¼€
        container.style.display = 'block';
        button.innerHTML = '<span style="font-size: 16px;">âœ“</span><span>å®Œæˆ</span>';
        button.title = 'æ”¶èµ·ç¼–è¾‘å™¨';
        button.style.color = '#4caf50';
        button.style.background = 'transparent';
      } else {
        // æ”¶èµ·
        container.style.display = 'none';
        button.innerHTML = '<span style="font-size: 16px;">âœï¸</span><span>ç¼–è¾‘</span>';
        button.title = 'ä¿®æ”¹å…¬å¼';
        button.style.color = '#0366d6';
        button.style.background = 'transparent';
      }
    }
    
    /**
     * åº”ç”¨å…¬å¼ä¿®æ”¹
     */
    function applyFormulaChanges(tierIndex) {
      console.log(`ğŸ”„ [åº”ç”¨å…¬å¼ä¿®æ”¹] é˜¶æ®µ${tierIndex + 1}`);
      
      // 1. è¯»å–ç”¨æˆ·ä¿®æ”¹çš„å…¬å¼å‚æ•°
      const formulaTypeSelect = document.querySelector(`.formula-type-select[data-tier="${tierIndex}"]`);
      const formulaType = formulaTypeSelect ? formulaTypeSelect.value : 'fixed';
      
      console.log(`ğŸ“Š [åº”ç”¨å…¬å¼ä¿®æ”¹] å…¬å¼ç±»å‹: ${formulaType}`);
      
      // 2. è·å–tierå¯¹è±¡
      if (!window.currentAnalyzingCoverage || !window.currentAnalyzingCoverage.result) {
        showMessage('âŒ å½“å‰æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„è´£ä»»', 'error');
        return;
      }
      
      const payoutAmount = window.currentAnalyzingCoverage.result.payoutAmount;
      if (!payoutAmount || !payoutAmount.details || !payoutAmount.details.tiers) {
        showMessage('âŒ æ— æ•ˆçš„èµ”ä»˜é‡‘é¢æ•°æ®', 'error');
        return;
      }
      
      const tier = payoutAmount.details.tiers[tierIndex];
      if (!tier) {
        showMessage('âŒ æ‰¾ä¸åˆ°å¯¹åº”é˜¶æ®µ', 'error');
        return;
      }
      
      // 3. æ ¹æ®å…¬å¼ç±»å‹ï¼Œè¯»å–å¹¶ä¿å­˜å‚æ•°åˆ°tierå¯¹è±¡
      tier.formulaType = formulaType;
      
      if (formulaType === 'fixed') {
        // å›ºå®šé‡‘é¢ï¼šè¯»å–åŸºç¡€é‡‘é¢å’Œæ¯”ä¾‹
        const baseAmountSelect = document.querySelector(`.base-amount-select[data-tier="${tierIndex}"]`);
        const ratioInput = document.querySelector(`.ratio-input[data-tier="${tierIndex}"]`);
        
        const baseAmount = baseAmountSelect?.selectedOptions[0]?.text || 'åŸºæœ¬ä¿é¢';
        const ratio = parseFloat(ratioInput?.value) || 100;
        
        tier.ratio = ratio;
        tier.formula = `${baseAmount}Ã—${ratio}%`;
        console.log(`ğŸ“Š [åº”ç”¨å…¬å¼ä¿®æ”¹] å›ºå®šé‡‘é¢ï¼ŒåŸºç¡€: ${baseAmount}ï¼Œæ¯”ä¾‹: ${ratio}%`);
        console.log(`ğŸ“Š [åº”ç”¨å…¬å¼ä¿®æ”¹] æ–°å…¬å¼: ${tier.formula}`);
      } else if (formulaType === 'simple' || formulaType === 'compound') {
        // å•åˆ©/å¤åˆ©ï¼šè¯»å–åŸºç¡€é‡‘é¢ã€åˆå§‹æ¯”ä¾‹å’Œå¢é•¿ç‡
        const baseAmountSelect = document.querySelector(`.base-amount-select[data-tier="${tierIndex}"]`);
        const ratioInput = document.querySelector(`.initial-ratio-input[data-tier="${tierIndex}"]`);
        const rateInput = document.querySelector(`.interest-rate-input[data-tier="${tierIndex}"]`);
        
        const baseAmount = baseAmountSelect?.selectedOptions[0]?.text || 'åŸºæœ¬ä¿é¢';
        const ratio = parseFloat(ratioInput?.value) || 100;
        const rate = parseFloat(rateInput?.value) || 3.5;
        
        tier.ratio = ratio;
        tier.interestRate = rate;
        
        if (formulaType === 'simple') {
          tier.formula = `${baseAmount}Ã—${ratio}%Ã—(1+${rate}%Ã—n)`;
        } else {
          tier.formula = `${baseAmount}Ã—${ratio}%Ã—(1+${rate}%)^n`;
        }
        console.log(`ğŸ“Š [åº”ç”¨å…¬å¼ä¿®æ”¹] ${formulaType === 'simple' ? 'å•åˆ©' : 'å¤åˆ©'}ï¼ŒåŸºç¡€: ${baseAmount}ï¼Œåˆå§‹æ¯”ä¾‹: ${ratio}%ï¼Œå¢é•¿ç‡: ${rate}%`);
        console.log(`ğŸ“Š [åº”ç”¨å…¬å¼ä¿®æ”¹] æ–°å…¬å¼: ${tier.formula}`);
      } else if (formulaType === 'max' || formulaType === 'min') {
        // Max/Minæ¯”è¾ƒï¼šä¿æŒåŸæœ‰é€»è¾‘
        console.log(`ğŸ“Š [åº”ç”¨å…¬å¼ä¿®æ”¹] ${formulaType.toUpperCase()}æ¯”è¾ƒï¼Œä¿æŒåŸæœ‰æ•°æ®`);
      }
      
      console.log(`âœ… [åº”ç”¨å…¬å¼ä¿®æ”¹] tierå¯¹è±¡å·²æ›´æ–°:`, tier);
      
      // 4. æ›´æ–°å…¬å¼é¢„è§ˆ
      updateFormulaPreview(tierIndex);
      
      // 5. æ”¶èµ·ç¼–è¾‘å™¨
      const container = document.querySelector(`.formula-editor-container[data-tier="${tierIndex}"]`);
      const button = document.querySelector(`.formula-edit-toggle[data-tier="${tierIndex}"]`);
      
      if (container) {
        container.style.display = 'none';
      }
      if (button) {
        button.innerHTML = '<span style="font-size: 16px;">âœï¸</span><span>ç¼–è¾‘</span>';
        button.title = 'ä¿®æ”¹å…¬å¼';
        button.style.background = 'transparent';
        button.style.color = '#0366d6';
      }
      
      showMessage('âœ… å…¬å¼å·²æ›´æ–°ï¼Œç‚¹å‡»"é‡æ–°è®¡ç®—"æŒ‰é’®åº”ç”¨æ›´æ”¹', 'success');
    }
    
    
    /**
     * æ˜¾ç¤ºæ–°å¢é˜¶æ®µå¯¹è¯æ¡†
     */
    function addNewTierDialog() {
      console.log('ğŸ¯ [æ–°å¢é˜¶æ®µ] æ‰“å¼€å¯¹è¯æ¡†');
      
      if (!window.currentAnalyzingCoverage || !window.currentAnalyzingCoverage.result) {
        showMessage('âŒ å½“å‰æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„è´£ä»»', 'error');
        return;
      }
      
      const policyInfo = getPolicyInfo();
      if (!policyInfo) {
        showMessage('âŒ è¯·å…ˆå¡«å†™ä¿å•åŸºæœ¬ä¿¡æ¯ï¼ˆå‡ºç”Ÿå¹´ä»½ã€æŠ•ä¿å¹´ä»½ã€åŸºæœ¬ä¿é¢ï¼‰', 'error');
        return;
      }
      
      // è·å–å½“å‰é˜¶æ®µæ•°é‡
      const tiers = window.currentAnalyzingCoverage.result.payoutAmount?.details?.tiers || [];
      const tierCount = tiers.length;
      
      // åˆ›å»ºå¯¹è¯æ¡†HTML
      const dialogHTML = `
        <div id="addTierDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">â• æ–°å¢é˜¶æ®µ</h3>
            
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                é˜¶æ®µæè¿° <span style="color: #999; font-size: 12px;">ï¼ˆå¦‚ï¼š18å²å‰ã€18å²åå‰10å¹´ï¼‰</span>
              </label>
              <input type="text" id="newTierPeriod" placeholder="è¯·è¾“å…¥é˜¶æ®µæè¿°" value="ç¬¬${tierCount + 1}é˜¶æ®µ"
                     style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                å…¬å¼ <span style="color: #ef4444;">*</span>
              </label>
              <input type="text" id="newTierFormula" placeholder="å¦‚ï¼šåŸºæœ¬ä¿é¢Ã—150% æˆ– Max(å·²äº¤ä¿è´¹, ç°é‡‘ä»·å€¼)"
                     style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                  å¼€å§‹å¹´é¾„ï¼ˆå²ï¼‰
                </label>
                <input type="number" id="newTierStartAge" placeholder="å¦‚ï¼š18" value="${policyInfo.policyStartYear - policyInfo.birthYear}"
                       style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
                  ç»“æŸå¹´é¾„
                </label>
                <input type="text" id="newTierEndAge" placeholder="å¦‚ï¼š100 æˆ– ç»ˆèº«" value="ç»ˆèº«"
                       style="width: 100%; padding: 10px 12px; border: 2px solid #9FE8ED; border-radius: 8px; font-size: 14px;">
              </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
              <button onclick="closeAddTierDialog()" 
                      style="padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                å–æ¶ˆ
              </button>
              <button onclick="confirmAddTier()" 
                      style="padding: 10px 20px; background: #CAF4F7; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s;"
                      onmouseover="this.style.background='#9FE8ED';"
                      onmouseout="this.style.background='#CAF4F7';">
                ç¡®è®¤æ·»åŠ 
              </button>
            </div>
          </div>
        </div>
      `;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.insertAdjacentHTML('beforeend', dialogHTML);
    }
    
    /**
     * å…³é—­æ–°å¢é˜¶æ®µå¯¹è¯æ¡†
     */
    function closeAddTierDialog() {
      const dialog = document.getElementById('addTierDialog');
      if (dialog) {
        dialog.remove();
      }
    }
    
    /**
     * ç¡®è®¤æ·»åŠ æ–°é˜¶æ®µ
     */
    async function confirmAddTier() {
      const period = document.getElementById('newTierPeriod').value.trim();
      const formula = document.getElementById('newTierFormula').value.trim();
      const startAgeInput = document.getElementById('newTierStartAge').value.trim();
      const endAgeInput = document.getElementById('newTierEndAge').value.trim();
      
      if (!formula) {
        showMessage('âŒ è¯·è¾“å…¥å…¬å¼', 'error');
        return;
      }
      
      console.log('ğŸ¯ [æ–°å¢é˜¶æ®µ] å‡†å¤‡æ·»åŠ :', { period, formula, startAgeInput, endAgeInput });
      
      // è§£æç»“æŸå¹´é¾„
      let endAge = 100;
      if (endAgeInput === 'ç»ˆèº«' || endAgeInput === 'lifetime' || endAgeInput === '') {
        endAge = 100;
      } else {
        endAge = parseInt(endAgeInput) || 100;
      }
      
      // åˆ›å»ºæ–°é˜¶æ®µ
      const newTier = {
        period: period || `æ–°é˜¶æ®µ`,
        formula: formula,
        formulaType: 'fixed',  // é»˜è®¤å›ºå®šé‡‘é¢ï¼Œåç«¯ä¼šè‡ªåŠ¨è¯†åˆ«
        startAge: parseInt(startAgeInput) || 0,
        endAge: endAge,
        keyAmounts: []
      };
      
      // è·å–ä¿å•ä¿¡æ¯ï¼Œè°ƒç”¨åç«¯è®¡ç®—
      const policyInfo = getPolicyInfo();
      if (policyInfo) {
        try {
          showMessage('â³ æ­£åœ¨è®¡ç®—æ–°é˜¶æ®µé‡‘é¢...', 'info');
          
          const response = await fetch('http://localhost:4000/api/coverage/recalculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tier: newTier, policyInfo: policyInfo })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.keyAmounts) {
              newTier.keyAmounts = result.keyAmounts;
              console.log('âœ… [æ–°å¢é˜¶æ®µ] åç«¯è®¡ç®—å®Œæˆï¼ŒkeyAmountsé•¿åº¦:', result.keyAmounts.length);
            }
          }
        } catch (error) {
          console.warn('âš ï¸ [æ–°å¢é˜¶æ®µ] è®¡ç®—å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
        }
      }
      
      // æ·»åŠ åˆ°å½“å‰è´£ä»»çš„tiers
      if (!window.currentAnalyzingCoverage.result.payoutAmount) {
        window.currentAnalyzingCoverage.result.payoutAmount = { type: 'tiered', details: { tiers: [] } };
      }
      if (!window.currentAnalyzingCoverage.result.payoutAmount.details) {
        window.currentAnalyzingCoverage.result.payoutAmount.details = { tiers: [] };
      }
      if (!window.currentAnalyzingCoverage.result.payoutAmount.details.tiers) {
        window.currentAnalyzingCoverage.result.payoutAmount.details.tiers = [];
      }
      
      window.currentAnalyzingCoverage.result.payoutAmount.details.tiers.push(newTier);
      
      console.log('âœ… [æ–°å¢é˜¶æ®µ] å·²æ·»åŠ åˆ°tiersï¼Œå½“å‰å…±', window.currentAnalyzingCoverage.result.payoutAmount.details.tiers.length, 'ä¸ªé˜¶æ®µ');
      
      // å…³é—­å¯¹è¯æ¡†
      closeAddTierDialog();
      
      // é‡æ–°æ¸²æŸ“æ•´ä¸ªç»“æœåŒºåŸŸ
      displayResult(window.currentAnalyzingCoverage.result, window.currentAnalyzingCoverage.name);
      
      showMessage(`âœ… å·²æ·»åŠ æ–°é˜¶æ®µ`, 'success');
    }
    
    /**
     * åˆ é™¤é˜¶æ®µï¼ˆæ›´æ–°ç‰ˆï¼‰
     */
    function deleteTier(tierIndex) {
      if (!confirm(`ç¡®è®¤åˆ é™¤ç¬¬${tierIndex + 1}é˜¶æ®µï¼Ÿ\nåˆ é™¤åæ— æ³•æ¢å¤ã€‚`)) {
        return;
      }
      
      if (!window.currentAnalyzingCoverage || !window.currentAnalyzingCoverage.result) {
        showMessage('âŒ å½“å‰æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„è´£ä»»', 'error');
        return;
      }
      
      const tiers = window.currentAnalyzingCoverage.result.payoutAmount?.details?.tiers;
      if (!tiers || !tiers[tierIndex]) {
        showMessage('âŒ æ‰¾ä¸åˆ°å¯¹åº”é˜¶æ®µ', 'error');
        return;
      }
      
      // ä»æ•°ç»„ä¸­åˆ é™¤
      tiers.splice(tierIndex, 1);
      console.log(`âœ… [åˆ é™¤é˜¶æ®µ] å·²åˆ é™¤é˜¶æ®µ${tierIndex + 1}ï¼Œå‰©ä½™${tiers.length}ä¸ªé˜¶æ®µ`);
      
      // é‡æ–°æ¸²æŸ“
      displayResult(window.currentAnalyzingCoverage.result, window.currentAnalyzingCoverage.name);
      
      showMessage(`âœ… å·²åˆ é™¤ç¬¬${tierIndex + 1}é˜¶æ®µ`, 'success');
    }
    
    /**
     * é‡ç½®å›ºå®šé‡‘é¢ä¸ºåŸå§‹è®¡ç®—å€¼
     * @param {number} tierIndex - é˜¶æ®µç´¢å¼•
     */
    /**
     * æ ¹æ®å½“å‰å…¬å¼é‡æ–°è®¡ç®—é‡‘é¢
     * @param {number} tierIndex - é˜¶æ®µç´¢å¼•
     */
    async function recalculateAmount(tierIndex) {
      console.log(`ğŸ”„ [é‡æ–°è®¡ç®—] å¼€å§‹é‡æ–°è®¡ç®—é˜¶æ®µ${tierIndex + 1}çš„é‡‘é¢`);
      
      if (!window.currentAnalyzingCoverage || !window.currentAnalyzingCoverage.result) {
        showMessage('âŒ å½“å‰æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„è´£ä»»', 'error');
        return;
      }
      
      const payoutAmount = window.currentAnalyzingCoverage.result.payoutAmount;
      if (!payoutAmount || !payoutAmount.details || !payoutAmount.details.tiers) {
        showMessage('âŒ æ— æ•ˆçš„èµ”ä»˜é‡‘é¢æ•°æ®', 'error');
        return;
      }
      
      const tier = payoutAmount.details.tiers[tierIndex];
      if (!tier) {
        showMessage('âŒ æ‰¾ä¸åˆ°å¯¹åº”é˜¶æ®µ', 'error');
        return;
      }
      
      console.log(`ğŸ“Š [é‡æ–°è®¡ç®—] é˜¶æ®µ${tierIndex + 1}çš„å½“å‰æ•°æ®:`, tier);
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showMessage('â³ æ­£åœ¨é‡æ–°è®¡ç®—...', 'info');
      
      try {
        // è°ƒç”¨åç«¯è®¡ç®—æœåŠ¡
        const policyInfo = getPolicyInfo();
        
        if (!policyInfo) {
          showMessage('âŒ è¯·å…ˆå¡«å†™ä¿å•åŸºæœ¬ä¿¡æ¯ï¼ˆå‡ºç”Ÿå¹´ä»½ã€æŠ•ä¿å¹´ä»½ã€åŸºæœ¬ä¿é¢ï¼‰', 'error');
          return;
        }
        
        console.log('ğŸ“Š [é‡æ–°è®¡ç®—] å‘é€è¯·æ±‚ï¼Œtier:', tier);
        console.log('ğŸ“Š [é‡æ–°è®¡ç®—] å‘é€è¯·æ±‚ï¼ŒpolicyInfo:', policyInfo);
        
        const response = await fetch('http://localhost:4000/api/coverage/recalculate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tier: tier,
            policyInfo: policyInfo
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ [é‡æ–°è®¡ç®—] åç«¯è¿”å›é”™è¯¯:', errorText);
          throw new Error(`è®¡ç®—å¤±è´¥: ${response.status}`);
        }
        
        const result = await response.json();
        console.log(`âœ… [é‡æ–°è®¡ç®—] åç«¯è¿”å›ç»“æœ:`, result);
        
        // æ£€æŸ¥è¿”å›æ ¼å¼
        if (!result.success) {
          showMessage(`âŒ ${result.message || 'è®¡ç®—å¤±è´¥'}`, 'error');
          return;
        }
        
        // æ›´æ–°æ•°æ®
        if (result.keyAmounts && result.keyAmounts.length > 0) {
          tier.keyAmounts = result.keyAmounts;
          console.log(`âœ… [é‡æ–°è®¡ç®—] å·²æ›´æ–°é˜¶æ®µ${tierIndex + 1}çš„é‡‘é¢æ•°æ®ï¼Œå…±${result.keyAmounts.length}æ¡`);
          console.log(`âœ… [é‡æ–°è®¡ç®—] å‰3æ¡æ•°æ®:`, result.keyAmounts.slice(0, 3));
          
          // é‡æ–°æ¸²æŸ“ç»“æœåŒºåŸŸ
          displayResult(window.currentAnalyzingCoverage.result, window.currentAnalyzingCoverage.name);
          
          showMessage(`âœ… é‡æ–°è®¡ç®—å®Œæˆï¼Œå·²æ›´æ–°${result.keyAmounts.length}æ¡é‡‘é¢æ•°æ®`, 'success');
      } else {
          console.warn('âš ï¸ [é‡æ–°è®¡ç®—] è¿”å›çš„keyAmountsä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„:', result.keyAmounts);
          showMessage('âš ï¸ è®¡ç®—ç»“æœä¸ºç©ºï¼Œè¯·æ£€æŸ¥å…¬å¼å’Œä¿å•ä¿¡æ¯', 'warning');
      }
      } catch (error) {
        console.error(`âŒ [é‡æ–°è®¡ç®—] é”™è¯¯:`, error);
        showMessage(`âŒ é‡æ–°è®¡ç®—å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    
    /**
     * å­˜å‚¨åŸå§‹è®¡ç®—å€¼ï¼ˆåœ¨æ¸²æŸ“æ—¶è°ƒç”¨ï¼‰
     * @param {number} tierIndex - é˜¶æ®µç´¢å¼•
     * @param {object} amounts - é‡‘é¢æ•°æ®
     * @param {boolean} isFixed - æ˜¯å¦ä¸ºå›ºå®šé‡‘é¢
     */
    function storeOriginalAmounts(tierIndex, amounts, isFixed) {
      if (isFixed) {
        originalCalculatedAmounts[tierIndex] = {
          fixedAmount: amounts[0]?.amount
        };
      } else {
        originalCalculatedAmounts[tierIndex] = {
          variableAmounts: amounts.map(item => ({
            age: item.age,
            amount: item.amount
          }))
        };
      }
      console.log(`ğŸ“¦ [å­˜å‚¨] é˜¶æ®µ${tierIndex + 1}çš„åŸå§‹è®¡ç®—å€¼å·²ä¿å­˜`, originalCalculatedAmounts[tierIndex]);
    }
    
    /**
     * è®¾ç½®å¹´é¾„èŒƒå›´è”åŠ¨
     * å½“æŸä¸ªé˜¶æ®µçš„ç»“æŸå¹´é¾„æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°ä¸‹ä¸€ä¸ªé˜¶æ®µçš„å¼€å§‹å¹´é¾„
     */
    function setupAgeLinkage() {
      console.log('ğŸ”— [è”åŠ¨] è®¾ç½®å¹´é¾„èŒƒå›´è”åŠ¨');
      
      // è·å–æ‰€æœ‰ç»“æŸå¹´é¾„è¾“å…¥æ¡†
      const endAgeInputs = document.querySelectorAll('.payout-tier-end-age');
      
      endAgeInputs.forEach((input, index) => {
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
        input.removeEventListener('change', handleEndAgeChange);
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        input.addEventListener('change', handleEndAgeChange);
      });
      
      console.log(`âœ… [è”åŠ¨] å·²ä¸º${endAgeInputs.length}ä¸ªç»“æŸå¹´é¾„è¾“å…¥æ¡†è®¾ç½®è”åŠ¨`);
    }
    
    /**
     * å¤„ç†ç»“æŸå¹´é¾„æ”¹å˜äº‹ä»¶
     */
    function handleEndAgeChange(event) {
      const currentInput = event.target;
      const currentTierIndex = parseInt(currentInput.getAttribute('data-tier'));
      const currentEndAge = currentInput.value.trim();
      
      console.log(`ğŸ”— [è”åŠ¨] é˜¶æ®µ${currentTierIndex + 1}çš„ç»“æŸå¹´é¾„æ”¹å˜ä¸º: ${currentEndAge}`);
      
      // å¦‚æœè¾“å…¥çš„æ˜¯"ç»ˆèº«"ï¼Œä¸å¤„ç†è”åŠ¨
      if (currentEndAge === 'ç»ˆèº«' || currentEndAge === 'lifetime' || currentEndAge === '') {
        console.log(`âš ï¸ [è”åŠ¨] ç»“æŸå¹´é¾„ä¸º"ç»ˆèº«"æˆ–ç©ºï¼Œè·³è¿‡è”åŠ¨`);
        return;
      }
      
      const endAge = parseInt(currentEndAge);
      if (isNaN(endAge)) {
        console.warn(`âš ï¸ [è”åŠ¨] æ— æ•ˆçš„ç»“æŸå¹´é¾„: ${currentEndAge}`);
        return;
      }
      
      // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªé˜¶æ®µçš„å¼€å§‹å¹´é¾„è¾“å…¥æ¡†
      const nextTierIndex = currentTierIndex + 1;
      const nextStartAgeInput = document.querySelector(`.payout-tier-start-age[data-tier="${nextTierIndex}"]`);
      
      if (nextStartAgeInput) {
        const newStartAge = endAge + 1;
        console.log(`ğŸ”— [è”åŠ¨] å°†é˜¶æ®µ${nextTierIndex + 1}çš„å¼€å§‹å¹´é¾„è®¾ç½®ä¸º: ${newStartAge}å²`);
        nextStartAgeInput.value = newStartAge;
        
        // è§¦å‘changeäº‹ä»¶ï¼Œä»¥ä¾¿æ›´æ–°coveragesæ•°ç»„
        nextStartAgeInput.dispatchEvent(new Event('change', { bubbles: true }));
        
        showMessage(`âœ… å·²è‡ªåŠ¨æ›´æ–°ç¬¬${nextTierIndex + 1}é˜¶æ®µçš„å¼€å§‹å¹´é¾„ä¸º${newStartAge}å²`, 'success');
      } else {
        console.log(`â„¹ï¸ [è”åŠ¨] æ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œå½“å‰æ˜¯æœ€åä¸€ä¸ªé˜¶æ®µ`);
      }
    }
    
    // ==================== è§£æå…¥å£å‡½æ•°ï¼ˆèŒè´£ï¼šåè°ƒè§£æå¹¶å¤„ç†UIåé¦ˆï¼‰====================
    async function parseClause(clauseText, coverageType) {
      // â±ï¸ å¼€å§‹è®¡æ—¶
      const startTime = performance.now();
      console.log('â±ï¸ [æ€§èƒ½] å¼€å§‹è§£æï¼Œæ—¶é—´æˆ³:', new Date().toLocaleTimeString());
      console.log('ğŸ“‹ parseClause è¢«è°ƒç”¨:', { clauseTextLength: clauseText.length, coverageType });
      
      try {
        // ğŸ”¥ æ··åˆè§£æï¼šå¤§æ¨¡å‹ï¼ˆèµ”ä»˜é‡‘é¢ï¼‰ + ç¡¬è§„åˆ™ï¼ˆå…¶ä»–å­—æ®µï¼‰
        console.log('ğŸš€ å¯ç”¨æ··åˆè§£ææ¨¡å¼');
        
        // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬åœ°æ–‡ä»¶ç¯å¢ƒï¼ˆfile://åè®®ï¼‰
        if (window.location.protocol === 'file:') {
          console.warn('âš ï¸ æ£€æµ‹åˆ°æœ¬åœ°æ–‡ä»¶ç¯å¢ƒï¼Œæ— æ³•è°ƒç”¨åç«¯API');
          const message = 'âš ï¸ å½“å‰ä¸ºæœ¬åœ°æ–‡ä»¶ç¯å¢ƒï¼Œæ— æ³•è°ƒç”¨åç«¯å¤§æ¨¡å‹æœåŠ¡ã€‚\n\n' +
                        'è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€è§£å†³ï¼š\n' +
                        '1. é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®é¡µé¢ï¼ˆå¦‚ http://localhost:8080ï¼‰\n' +
                        '2. æ‰‹åŠ¨è°ƒæ•´è§£æç»“æœ\n\n' +
                        'ç³»ç»Ÿå·²é…ç½®ä¸ºç›´æ¥ä½¿ç”¨å¤§æ¨¡å‹è¿›è¡Œè§£æï¼Œä½†ç”±äºç¯å¢ƒé™åˆ¶æ— æ³•è°ƒç”¨ã€‚';
          showMessage(message, 'warning');
          // è¿”å›ä¸€ä¸ªç©ºç»“æœï¼Œè®©ç”¨æˆ·çŸ¥é“éœ€è¦æ‰‹åŠ¨è¾“å…¥
          return {
            payoutAmount: { type: 'unknown', confidence: 0 },
            payoutCount: { type: 'unknown', maxCount: null, confidence: 0 },
            intervalPeriod: { hasInterval: false, days: null, confidence: 0 },
            grouping: { isGrouped: false, groupCount: null, confidence: 0 },
            repeatablePayout: { isRepeatable: false, confidence: 0 },
            premiumWaiver: { isWaived: false, confidence: 0 },
            conditions: [],
            overallConfidence: 0,
            parseMethod: 'llm'
          };
        }
        
        try {
          // æ”¶é›†ä¿å•ä¿¡æ¯
          const birthYearEl = document.getElementById('birthYear');
          const policyStartYearEl = document.getElementById('policyStartYear');
          const coverageEndYearEl = document.getElementById('coverageEndYear');
          const basicSumInsuredEl = document.getElementById('basicSumInsured');
          const totalPaymentPeriodEl = document.getElementById('totalPaymentPeriod');
          const annualPremiumEl = document.getElementById('annualPremium');
          
          const policyInfo = {
            birthYear: birthYearEl ? parseInt(birthYearEl.value) : undefined,
            policyStartYear: policyStartYearEl ? parseInt(policyStartYearEl.value) : undefined,
            coverageEndYear: coverageEndYearEl ? (coverageEndYearEl.value === 'lifetime' ? 'lifetime' : parseInt(coverageEndYearEl.value)) : undefined,
            basicSumInsured: basicSumInsuredEl ? parseFloat(basicSumInsuredEl.value) * 10000 : undefined, // âœ… ç”¨æˆ·è¾“å…¥ä¸‡å…ƒï¼Œåç«¯éœ€è¦å…ƒ
            totalPaymentPeriod: totalPaymentPeriodEl ? totalPaymentPeriodEl.value : undefined,
            annualPremium: annualPremiumEl ? parseFloat(annualPremiumEl.value) : undefined
          };
          
          // ğŸ¯ éªŒè¯æŠ•ä¿å¹´ä»½æ˜¯å¦åˆç†
          if (policyInfo.birthYear && policyInfo.policyStartYear) {
            const policyStartAge = policyInfo.policyStartYear - policyInfo.birthYear;
            const currentYear = new Date().getFullYear();
            const currentAge = currentYear - policyInfo.birthYear;
            
            console.log(`ğŸ” [éªŒè¯] å‡ºç”Ÿå¹´ä»½=${policyInfo.birthYear}, æŠ•ä¿å¹´ä»½=${policyInfo.policyStartYear}, æŠ•ä¿å¹´é¾„=${policyStartAge}å², å½“å‰å¹´é¾„=${currentAge}å²`);
            
            if (policyStartAge > currentAge) {
              alert(`âš ï¸ æŠ•ä¿å¹´ä»½è®¾ç½®æœ‰è¯¯ï¼\n\n` +
                    `å½“å‰å¹´é¾„ï¼š${currentAge}å²\n` +
                    `æŠ•ä¿å¹´ä»½ï¼š${policyInfo.policyStartYear}å¹´\n` +
                    `è®¡ç®—å‡ºçš„æŠ•ä¿å¹´é¾„ï¼š${policyStartAge}å²ï¼ˆæœªæ¥å¹´é¾„ï¼ï¼‰\n\n` +
                    `å»ºè®®ä¿®æ”¹"æŠ•ä¿å¼€å§‹å¹´ä»½"ä¸ºï¼š${policyInfo.birthYear + policyStartAge}å¹´`);
              return;
            }
            
            if (policyStartAge < 0 || policyStartAge > 100) {
              alert(`âš ï¸ æŠ•ä¿å¹´é¾„ä¸åˆç†ï¼\n\nè®¡ç®—å‡ºçš„æŠ•ä¿å¹´é¾„ä¸ºï¼š${policyStartAge}å²\nè¯·æ£€æŸ¥"å‡ºç”Ÿå¹´ä»½"å’Œ"æŠ•ä¿å¼€å§‹å¹´ä»½"æ˜¯å¦æ­£ç¡®ã€‚`);
              return;
            }
          }
          
          console.log('ğŸ¬ æ­£åœ¨è°ƒç”¨åç«¯æ··åˆè§£ææœåŠ¡...');
          console.log('ğŸ“¡ ä¿å•ä¿¡æ¯:', policyInfo);
          
          // ğŸ¯ æ˜¾ç¤ºloadingè½¬åœˆå›¾æ ‡
          const loadingEl = document.getElementById('loading');
          const resultContainer = document.getElementById('resultContainer');
          const streamingContainer = document.getElementById('streamingContainer');
          
          if (loadingEl) {
            loadingEl.classList.add('active');
          }
          if (streamingContainer) {
            streamingContainer.style.display = 'none'; // éšè—streamingåŒºåŸŸ
          }
          if (resultContainer) {
            resultContainer.innerHTML = ''; // æ¸…ç©ºç»“æœåŒºåŸŸ
          }
          
          // ğŸ¬ è°ƒç”¨æ··åˆè§£ææ¥å£
          const backendResult = await BackendParserService.parse(
            clauseText, 
            coverageType, 
            policyInfo
          );
          
          // â±ï¸ è®¡ç®—æ€»è€—æ—¶
          const endTime = performance.now();
          const totalSeconds = ((endTime - startTime) / 1000).toFixed(2);
          console.log('â±ï¸ [æ€§èƒ½] è§£æå®Œæˆï¼Œæ—¶é—´æˆ³:', new Date().toLocaleTimeString());
          console.log(`â±ï¸ [æ€§èƒ½] ========== æ€»è€—æ—¶: ${totalSeconds}ç§’ ==========`);
          
          console.log('âœ… åç«¯è§£æå®Œæˆ');
          console.log('âœ… åç«¯è§£ææˆåŠŸ:', backendResult);
          
          // ğŸ”¥ è¯¦ç»†æ£€æŸ¥æ¯ä¸ªé˜¶æ®µçš„keyAmountsï¼Œå¹¶è®¾ç½®startAge/endAge
          if (backendResult.payoutAmount?.details?.tiers) {
            backendResult.payoutAmount.details.tiers.forEach((tier, index) => {
              console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ [æ¥æ”¶æ•°æ®] é˜¶æ®µ${index + 1}:`, {
                period: tier.period,
                keyAmountsLength: tier.keyAmounts?.length || 0,
                firstAge: tier.keyAmounts?.[0]?.age,
                lastAge: tier.keyAmounts?.[tier.keyAmounts?.length - 1]?.age,
                firstYear: tier.keyAmounts?.[0]?.year,
                lastYear: tier.keyAmounts?.[tier.keyAmounts?.length - 1]?.year
              });
              
              // ğŸ¯ æ ¹æ®keyAmountsè®¾ç½®tierçš„startAgeå’ŒendAgeï¼ˆç”¨äºè¾“å…¥æ¡†æ˜¾ç¤ºï¼‰
              if (tier.keyAmounts && tier.keyAmounts.length > 0) {
                tier.startAge = tier.keyAmounts[0].age;
                tier.endAge = tier.keyAmounts[tier.keyAmounts.length - 1].age;
                console.log(`âœ… [æ¥æ”¶æ•°æ®] é˜¶æ®µ${index + 1}å·²è®¾ç½®å¹´é¾„èŒƒå›´: ${tier.startAge}å²-${tier.endAge}å²`);
              }
            });
          }
          
          // éªŒè¯åç«¯ç»“æœæ˜¯å¦åŒ…å«èµ”ä»˜é‡‘é¢
          if (backendResult.payoutAmount && backendResult.payoutAmount.confidence > 0) {
            console.log('âœ… åç«¯è§£ææˆåŠŸè¯†åˆ«èµ”ä»˜é‡‘é¢ï¼Œç½®ä¿¡åº¦:', backendResult.payoutAmount.confidence);
          } else {
            console.warn('âš ï¸ åç«¯è§£æç»“æœä¸­èµ”ä»˜é‡‘é¢ä»æœªè¯†åˆ«');
          }
          
          // ç¡®ä¿parseMethodæ­£ç¡®è®¾ç½®
          backendResult.parseMethod = 'llm';
          
          // â±ï¸ åœ¨UIä¸Šæ˜¾ç¤ºè€—æ—¶
          showMessage(`âœ… è§£æå®Œæˆï¼æ€»è€—æ—¶ï¼š${totalSeconds}ç§’`, 'success');
          
          return backendResult;
        } catch (backendError) {
          console.error('âŒ åç«¯æœåŠ¡è°ƒç”¨å¤±è´¥:', backendError);
          console.error('âŒ åç«¯æœåŠ¡è°ƒç”¨å¤±è´¥è¯¦æƒ…:', backendError.message, backendError.stack);
          const errorMessage = `âš ï¸ åç«¯æœåŠ¡è°ƒç”¨å¤±è´¥: ${backendError.message}\n\n` +
                            'è¯·æ£€æŸ¥ï¼š\n' +
                            '1. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:4000\n' +
                            '2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n' +
                            '3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯';
          showMessage(errorMessage, 'warning');
          // è¿”å›ä¸€ä¸ªç©ºç»“æœï¼Œè®©ç”¨æˆ·çŸ¥é“éœ€è¦æ‰‹åŠ¨è¾“å…¥
          return {
            payoutAmount: { type: 'unknown', confidence: 0 },
            payoutCount: { type: 'unknown', maxCount: null, confidence: 0 },
            intervalPeriod: { hasInterval: false, days: null, confidence: 0 },
            grouping: { isGrouped: false, groupCount: null, confidence: 0 },
            repeatablePayout: { isRepeatable: false, confidence: 0 },
            premiumWaiver: { isWaived: false, confidence: 0 },
            conditions: [],
            overallConfidence: 0,
            parseMethod: 'llm'
          };
        }
      } catch (error) {
        console.error('âŒ parseClause é”™è¯¯:', error);
        throw error;
      }
    }

    // è°ƒç”¨åç«¯è§£ææœåŠ¡ï¼ˆå·²ç§»è‡³BackendParserServiceï¼‰
    async function parseWithBackend(clauseText, coverageType) {
      return await BackendParserService.parse(clauseText, coverageType);
    }

    // ä½¿ç”¨æ··åˆæ–¹æ¡ˆè§£æï¼ˆå…ˆç¡¬è§„åˆ™ï¼ŒåLLMï¼‰
    async function parseWithMockData() {
      // æ£€æŸ¥åŸºæœ¬ä¿¡æ¯
      const productName = document.getElementById('productName').value.trim();
      const insuredPerson = document.getElementById('insuredPerson').value;
      const birthYear = document.getElementById('birthYear').value;
      const policyStartYear = document.getElementById('policyStartYear').value;
      const coverageEndYear = document.getElementById('coverageEndYear').value;
      const basicSumInsured = document.getElementById('basicSumInsured').value;
      
      if (!productName) {
        showMessage('âŒ è¯·è¾“å…¥äº§å“åç§°', 'error');
        return;
      }
      
      if (!insuredPerson) {
        showMessage('âŒ è¯·é€‰æ‹©è¢«ä¿é™©äºº', 'error');
        return;
      }
      
      if (!birthYear) {
        showMessage('âŒ è¯·é€‰æ‹©å‡ºç”Ÿå¹´ä»½', 'error');
        return;
      }
      
      // éªŒè¯å‡ºç”Ÿå¹´ä»½å’ŒæŠ•ä¿å¼€å§‹å¹´ä»½çš„åˆç†æ€§
      if (policyStartYear) {
        const age = UtilityService.calculateAge(birthYear, policyStartYear);
        if (age < 0 || age > 120) {
          showMessage('âŒ æ ¹æ®å‡ºç”Ÿå¹´ä»½å’ŒæŠ•ä¿å¼€å§‹å¹´ä»½è®¡ç®—çš„å¹´é¾„ä¸åˆç†ï¼ˆ0-120å²ï¼‰', 'error');
          return;
        }
      }
      
      if (!policyStartYear) {
        showMessage('âŒ è¯·é€‰æ‹©æŠ•ä¿å¼€å§‹å¹´ä»½', 'error');
        return;
      }
      
      if (!coverageEndYear) {
        showMessage('âŒ è¯·é€‰æ‹©ä¿éšœç»“æŸå¹´ä»½', 'error');
        return;
      }
      
      if (!basicSumInsured || parseFloat(basicSumInsured) <= 0) {
        showMessage('âŒ è¯·è¾“å…¥åŸºæœ¬ä¿é¢ï¼ˆä¸‡å…ƒï¼‰', 'error');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ä¿å•ç±»å‹
      if (!currentPolicyType) {
        showMessage('âŒ è¯·å…ˆé€‰æ‹©ä¿å•ç±»å‹', 'error');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è´£ä»»ç±»å‹
      if (!currentCoverageType) {
        showMessage('âŒ è¯·å…ˆé€‰æ‹©è´£ä»»ç±»å‹', 'error');
        return;
      }
      
      const clauseInput = document.getElementById('pageClauseInput');
      const clauseText = clauseInput ? clauseInput.value.trim() : '';
      
      if (!clauseText) {
        showMessage('âŒ è¯·è¾“å…¥ä¿é™©æ¡æ¬¾æ–‡æœ¬', 'error');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('loading').classList.add('active');
      document.getElementById('resultContainer').innerHTML = '';
      document.getElementById('actionsSection').style.display = 'none';

      try {
        // ä½¿ç”¨æ··åˆè§£ææ–¹æ¡ˆï¼ˆä¼ å…¥è´£ä»»ç±»å‹ï¼‰
        const result = await parseClause(clauseText, currentCoverageType);
        parseResult = result;
        // è‡ªåŠ¨è¯†åˆ«è´£ä»»åç§°
        const detectedName = UtilityService.autoDetectCoverageName(clauseText);
        displayResult(result, detectedName || '');
        document.getElementById('loading').classList.remove('active');
        document.getElementById('actionsSection').style.display = 'flex';
        
        // æ˜¾ç¤ºè§£æå®Œæˆæç¤ºï¼ˆä¸æ˜¾ç¤ºæŠ€æœ¯ç»†èŠ‚ï¼‰
        const confidenceText = result.overallConfidence 
          ? `ï¼ˆç½®ä¿¡åº¦: ${(result.overallConfidence * 100).toFixed(0)}%ï¼‰` 
          : '';
        showMessage(`âœ… è§£æå®Œæˆ${confidenceText}`, 'success');
      } catch (error) {
        console.error('è§£æå¤±è´¥:', error);
        showMessage('âŒ è§£æå¤±è´¥ï¼š' + error.message, 'error');
        document.getElementById('loading').classList.remove('active');
      }
    }


    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
      setTimeout(() => {
        // åˆå§‹åŒ–ä¿é™©å…¬å¸é€‰æ‹©å™¨
        try {
          InsuranceCompanySelectorService.init('insuranceCompany', 'insuranceCompanyDropdown');
          console.log('ä¿é™©å…¬å¸é€‰æ‹©å™¨åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
          console.error('åˆå§‹åŒ–ä¿é™©å…¬å¸é€‰æ‹©å™¨å¤±è´¥:', error);
        }
        
        // åˆå§‹åŒ–æŠ•ä¿å¼€å§‹å¹´ä»½é€‰é¡¹ï¼ˆåŒ…æ‹¬å‡ºç”Ÿå¹´ä»½ä¸‹æ‹‰æ¡†ï¼‰
        console.log('å¼€å§‹åˆå§‹åŒ–å¹´ä»½é€‰é¡¹...');
        try {
          initPolicyStartYearOptions();
          console.log('å¹´ä»½é€‰é¡¹åˆå§‹åŒ–å®Œæˆ');
          
          // åˆå§‹åŒ–å®Œæˆåè®¾ç½®é»˜è®¤å€¼
          setTimeout(() => {
            UtilityService.setDefaultValues();
            // è®¾ç½®ä¿å•ç±»å‹é»˜è®¤å€¼ä¸º"é‡ç–¾é™©"
            const policyTypeSelect = document.getElementById('policyType');
            if (policyTypeSelect) {
              policyTypeSelect.value = 'critical_illness';
              currentPolicyType = 'critical_illness';
            }
            console.log('é»˜è®¤å€¼è®¾ç½®å®Œæˆ');
          }, 150);
        } catch (error) {
          console.error('åˆå§‹åŒ–å¹´ä»½é€‰é¡¹å¤±è´¥:', error);
        }
      }, 100);
      
      // åŠ è½½ä¿å­˜çš„åˆåŒ
      loadPolicies();
      
      // å¦‚æœæœ‰ä¿å­˜çš„åˆåŒï¼Œæ˜¾ç¤ºåˆåŒå¡ç‰‡åˆ—è¡¨ï¼ˆé¦–é¡µï¼šå®¶åº­ä¿å•ç®¡å®¶ï¼‰
      // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åˆåŒï¼Œæ˜¾ç¤ºå½•å…¥é¡µé¢ï¼ˆä¿å•æ™ºèƒ½å½•å…¥ï¼‰
      if (policies.length > 0) {
        showPolicyCards(); // ä¼šæ›´æ–°æ ‡é¢˜ä¸º"å®¶åº­ä¿å•ç®¡å®¶"
      } else {
        // æ²¡æœ‰åˆåŒï¼Œæ˜¾ç¤ºå½•å…¥é¡µé¢ï¼Œæ ‡é¢˜ä¸º"ä¿å•æ™ºèƒ½å½•å…¥è§£æ"
        const pageTitle = document.getElementById('pageTitle');
        if (pageTitle) {
          pageTitle.textContent = 'ä¿å•æ™ºèƒ½å½•å…¥è§£æ';
        }
        
        // æ˜¾ç¤ºè¿”å›æŒ‰é’®
        const backButton = document.getElementById('backButton');
        if (backButton) {
          backButton.style.display = 'block';
        }
      }
      
      // ç›‘å¬åŸºæœ¬ä¿¡æ¯å˜åŒ–ï¼Œæ›´æ–°å®ŒæˆæŒ‰é’®çŠ¶æ€
      ['insuranceCompany', 'productName', 'insuredPerson', 'birthYear', 'policyStartYear', 'coverageEndYear', 'totalPaymentPeriod', 'annualPremium', 'basicSumInsured'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateCompleteButton);
          element.addEventListener('change', updateCompleteButton);
        }
      });
      
    });

    // æ˜¾ç¤ºè§£æç»“æœ
    function displayResult(result, coverageName = '') {
      const container = document.getElementById('resultContainer');
      container.innerHTML = '';

      // æ£€æŸ¥è´£ä»»åç§°æ˜¯å¦ç¬¦åˆæ ‡å‡†æ ¼å¼ï¼ˆåŒ…å«"ä¿é™©é‡‘"æˆ–"è´£ä»»"ï¼‰
      const isValidName = coverageName && (coverageName.includes('ä¿é™©é‡‘') || coverageName.includes('è´£ä»»'));
      
      // å¦‚æœæ˜¯ç–¾ç—…è´£ä»»ï¼Œå°è¯•è¯†åˆ«ç–¾ç—…åˆ†ç±»
      let diseaseCategory = '';
      if (isValidName && currentCoverageType === 'disease') {
        const clauseText = document.getElementById('pageClauseInput')?.value || '';
        diseaseCategory = UtilityService.detectDiseaseCategory(coverageName, clauseText);
      }
      
      // æ„å»ºæ˜¾ç¤ºçš„è´£ä»»åç§°ï¼ˆå¦‚æœæœ‰åˆ†ç±»ï¼ŒåŠ ä¸Šåˆ†ç±»ï¼‰
      let displayName = coverageName;
      if (diseaseCategory) {
        displayName = `${coverageName}ï¼ˆ${diseaseCategory}ï¼‰`;
      }
      
      // è´£ä»»åç§°åŒºåŸŸï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œå¯ç¼–è¾‘ï¼‰
      const nameDiv = document.createElement('div');
      nameDiv.className = 'result-item';
      nameDiv.style.marginBottom = '20px';
      nameDiv.style.paddingBottom = '20px';
      nameDiv.style.borderBottom = '2px solid #e0e0e0';
      
      if (isValidName) {
        // è‡ªåŠ¨è¯†åˆ«æˆåŠŸ
        nameDiv.innerHTML = `
          <div class="result-label">
            <span style="font-weight: 600; font-size: 16px;">è´£ä»»åç§°</span>
          </div>
          <div class="result-value" contenteditable="true" id="resultCoverageName" style="font-size: 16px; font-weight: 500; color: #333; min-height: 32px; padding: 8px; border: 2px solid #9FE8ED; border-radius: 6px; background: white;" data-original-name="${coverageName}" data-category="${diseaseCategory}" onblur="updateCoverageNameInResult(this.textContent)">${displayName}</div>
        `;
      } else {
        // è‡ªåŠ¨è¯†åˆ«å¤±è´¥ï¼Œåªæ˜¾ç¤ºå ä½ç¬¦æç¤º
        const placeholder = 'æœªè¯†åˆ«åˆ°æœ‰æ•ˆåç§°ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥';
        nameDiv.innerHTML = `
          <div class="result-label">
            <span style="font-weight: 600; font-size: 16px;">è´£ä»»åç§°</span>
          </div>
          <div class="result-value" contenteditable="true" id="resultCoverageName" style="font-size: 16px; font-weight: 500; color: #999; min-height: 32px; padding: 8px; border: 2px solid #9FE8ED; border-radius: 6px; background: white;" data-placeholder="${placeholder}" onfocus="this.style.color='#333'; if(this.textContent === this.getAttribute('data-placeholder')) this.textContent='';" onblur="updateCoverageNameInResult(this.textContent); if(!this.textContent.trim()) { this.textContent=this.getAttribute('data-placeholder'); this.style.color='#999'; }">${placeholder}</div>
        `;
        // è®¾ç½®åˆå§‹æ ·å¼
        const nameInput = nameDiv.querySelector('#resultCoverageName');
        if (nameInput && !coverageName) {
          nameInput.style.color = '#999';
        }
      }
      
      container.appendChild(nameDiv);

      // è·å–ä¿å•ä¿¡æ¯
      let policyInfo = getPolicyInfo();
      
      // ğŸ”§ å¦‚æœå‰ç«¯æ²¡æœ‰å¡«å†™ä¿å•ä¿¡æ¯ï¼Œä½†åç«¯è§£ææ—¶æœ‰ï¼Œåˆ™ä½¿ç”¨è§£ææ—¶çš„ä¿å•ä¿¡æ¯
      if (!policyInfo && result.policyInfo) {
        console.log('ğŸ“‹ [displayResult] å‰ç«¯æœªå¡«å†™ä¿å•ä¿¡æ¯ï¼Œä½¿ç”¨åç«¯è§£ææ—¶çš„ä¿å•ä¿¡æ¯');
        policyInfo = result.policyInfo;
      }
      
      console.log('ğŸ“‹ [displayResult] æœ€ç»ˆä½¿ç”¨çš„policyInfo:', policyInfo);
      
      // 1. èµ”ä»˜é‡‘é¢ï¼ˆåˆ†é˜¶æ®µæ˜¾ç¤ºï¼‰
      container.appendChild(createPayoutAmountDisplay(result.payoutAmount, policyInfo, result));
      
      // 2. èµ”ä»˜æ¬¡æ•°ï¼ˆè¾“å…¥æ¡†ï¼‰
      container.appendChild(createPayoutCountDisplay(result.payoutCount));
      
      // 3. æ˜¯å¦åˆ†ç»„ï¼ˆå•é€‰ï¼‰
      container.appendChild(createGroupingDisplay(result.grouping, result.payoutCount));
      
      // 4. æ˜¯å¦å¯ä»¥é‡å¤èµ”ä»˜ï¼ˆå•é€‰ï¼‰
      container.appendChild(createRepeatablePayoutDisplay(result.repeatablePayout, result.payoutCount));
      
      // 5. é—´éš”æœŸï¼ˆè¾“å…¥æ¡†ï¼‰
      container.appendChild(createIntervalPeriodDisplay(result.intervalPeriod, result.payoutCount));
      
      // 6. ç–¾ç—…å‘ç”Ÿæ˜¯å¦è±å…ä¿è´¹ï¼ˆå•é€‰ï¼‰
      container.appendChild(createPremiumWaiverDisplay(result.premiumWaiver));
      
      // ğŸ”— è®¾ç½®å¹´é¾„èŒƒå›´è”åŠ¨ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²æ¸²æŸ“ï¼‰
      setTimeout(() => {
        setupAgeLinkage();
      }, 100);
    }

    // ==================== åˆ›å»ºå„å­—æ®µæ˜¾ç¤ºç»„ä»¶ ====================
    
    // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºåŸæ–‡ç‰‡æ®µHTML
    function createExtractedTextHtml(extractedText) {
      // å¦‚æœæœ‰åŸæ–‡ç‰‡æ®µï¼Œæ˜¾ç¤ºæ·¡è“è‰²èƒŒæ™¯
      if (extractedText && extractedText.trim() !== '') {
        return `
          <div style="margin-top: 12px; padding: 10px; background: #f0f8fc; border-left: 3px solid #5FC8D4; border-radius: 4px; font-size: 13px; color: #555; line-height: 1.6;">
            <div style="font-weight: 600; color: #5FC8D4; margin-bottom: 4px;">ğŸ“„ åŸæ–‡ç‰‡æ®µï¼š</div>
            <div>${extractedText}</div>
          </div>
        `;
      }
      
      // å¦‚æœæ²¡æœ‰åŸæ–‡ç‰‡æ®µï¼Œæ˜¾ç¤ºç°è‰²æç¤º
      return `
        <div style="margin-top: 12px; padding: 10px; background: #f5f5f5; border-left: 3px solid #ccc; border-radius: 4px; font-size: 13px; color: #999; line-height: 1.6;">
          <div style="font-weight: 600; color: #999; margin-bottom: 4px;">ğŸ“„ åŸæ–‡ç‰‡æ®µï¼š</div>
          <div style="font-style: italic;">åŸæ–‡æœªè¯†åˆ«åˆ°ç›¸å…³å†…å®¹</div>
        </div>
      `;
    }
    
    // 1. èµ”ä»˜é‡‘é¢ï¼ˆåˆ†é˜¶æ®µæ˜¾ç¤ºï¼‰
    function createPayoutAmountDisplay(data, policyInfo, fullResult = null) {
      // ğŸ” è¶…è¯¦ç»†è°ƒè¯•ï¼šæ‰“å°å®Œæ•´çš„ data å¯¹è±¡
      console.log('ğŸ¨ [createPayoutAmountDisplay] ========== å¼€å§‹æ¸²æŸ“èµ”ä»˜é‡‘é¢ ==========');
      console.log('ğŸ¨ [createPayoutAmountDisplay] dataå®Œæ•´å¯¹è±¡:', JSON.stringify(data, null, 2));
      console.log('ğŸ¨ [createPayoutAmountDisplay] policyInfo:', JSON.stringify(policyInfo, null, 2));
      console.log('ğŸ¨ [createPayoutAmountDisplay] ç®€è¦ä¿¡æ¯:', { 
        dataType: data?.type, 
        hasTiers: !!data?.details?.tiers,
        tiersLength: data?.details?.tiers?.length || 0,
        policyInfoExists: !!policyInfo 
      });
      console.log('ğŸ¨ [createPayoutAmountDisplay] ========== è°ƒè¯•ä¿¡æ¯ç»“æŸ ==========');
      
      const div = document.createElement('div');
      div.className = 'result-item';
      div.id = 'payoutAmountItem';
      
      const confidence = data?.confidence || 0;
      const confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
      const confidenceText = confidence >= 0.8 ? 'é«˜' : confidence >= 0.5 ? 'ä¸­' : 'ä½';
      
      let content = '';
      
      // å¤„ç† paid_premium ç±»å‹ï¼ˆæŒ‰å·²äº¤ä¿é™©è´¹ç»™ä»˜ï¼‰
      if (data && data.type === 'paid_premium') {
        let formattedAmount = '';
        let startAge = '';
        let endAge = '';
        
        // å¦‚æœæœ‰ä¿å•ä¿¡æ¯ï¼Œè®¡ç®—å·²äº¤ä¿è´¹
        if (policyInfo && policyInfo.annualPremium && policyInfo.totalPaymentPeriod) {
          // è®¡ç®—æ€»ä¿è´¹ï¼ˆä¸‡å…ƒï¼‰
          const annualPremiumWan = (parseFloat(policyInfo.annualPremium) || 0) / 10000;
          const paymentYears = parseInt(policyInfo.totalPaymentPeriod) || 1;
          const totalPremiumWan = (annualPremiumWan * paymentYears).toFixed(1);
          formattedAmount = totalPremiumWan;
          
          const birthYear = parseInt(policyInfo.birthYear);
          const policyStartYear = parseInt(policyInfo.policyStartYear);
          const coverageEndYear = policyInfo.coverageEndYear === 'lifetime' ? null : parseInt(policyInfo.coverageEndYear);
          
          startAge = policyStartYear - birthYear;
          endAge = coverageEndYear ? (coverageEndYear - birthYear) : 100;
        }
        
        const needsManualInput = !formattedAmount || !startAge || !endAge;
        
        content = `
          <div style="margin-top: 12px;">
            <div style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-left: 3px solid #5FC8D4; border-radius: 4px; font-size: 13px; color: #1976d2;">
              ğŸ’° æŒ‰ç´¯è®¡å·²äº¤ä¿é™©è´¹ç»™ä»˜ä¿é™©é‡‘${formattedAmount ? `ï¼ˆæ€»ä¿è´¹ï¼š${formattedAmount}ä¸‡å…ƒï¼‰` : ''}
            </div>
            
            <!-- ä¸‰åˆ—å¸ƒå±€ï¼šèµ·å§‹å¹´é¾„ã€ç»“æŸå¹´é¾„ã€ç†èµ”é‡‘é¢ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items: end;">
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœå¼€å§‹å¹´é¾„ï¼ˆå²ï¼‰</label>
                <input type="number" class="payout-tier-start-age" data-tier="0" data-field="startAge" 
                       value="${startAge || ''}" 
                       placeholder="èµ·å§‹"
                       style="width: 100%; padding: 8px; border: 2px solid ${needsManualInput ? 'rgba(255, 99, 99, 0.5)' : '#E5F9FA'}; border-radius: 4px; font-size: 14px; background: ${needsManualInput ? 'rgba(255, 182, 193, 0.2)' : '#ffffff'}; text-align: center;" />
              </div>
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœç»“æŸå¹´é¾„ï¼ˆå²ï¼‰</label>
                <input type="number" class="payout-tier-end-age" data-tier="0" data-field="endAge" 
                       value="${endAge || ''}" 
                       placeholder="ç»“æŸ"
                       style="width: 100%; padding: 8px; border: 2px solid ${needsManualInput ? 'rgba(255, 99, 99, 0.5)' : '#E5F9FA'}; border-radius: 4px; font-size: 14px; background: ${needsManualInput ? 'rgba(255, 182, 193, 0.2)' : '#ffffff'}; text-align: center;" />
              </div>
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ç†èµ”é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
                <input type="number" step="0.1" class="payout-tier-amount" data-tier="0" data-field="amount" 
                       value="${formattedAmount || ''}" 
                       placeholder="è¯·è¾“å…¥"
                       style="width: 100%; padding: 8px; border: 2px solid ${needsManualInput ? 'rgba(255, 99, 99, 0.5)' : '#E5F9FA'}; border-radius: 4px; font-size: 14px; background: ${needsManualInput ? 'rgba(255, 182, 193, 0.2)' : '#ffffff'};" />
              </div>
            </div>
          </div>
        `;
      }
      // å¤„ç† percentage ç±»å‹ï¼ˆå•ç™¾åˆ†æ¯”ï¼Œå¦‚30%åŸºæœ¬ä¿é¢ï¼‰
      else if (data && data.type === 'percentage' && data.details?.percentage !== undefined) {
        const percentage = data.details.percentage;
        let formattedAmount = '';
        let startAge = '';
        let endAge = '';
        
        // å¦‚æœæœ‰ä¿å•ä¿¡æ¯ï¼Œè®¡ç®—å®é™…é‡‘é¢å’Œå¹´é¾„èŒƒå›´
        if (policyInfo) {
          // policyInfo.basicSumInsured æ˜¯å…ƒï¼Œéœ€è¦è½¬æ¢ä¸ºä¸‡å…ƒ
          const basicSumInsuredWan = (parseFloat(policyInfo.basicSumInsured) || 0) / 10000;
          const amount = (basicSumInsuredWan * percentage / 100).toFixed(1);
          formattedAmount = amount;
          
          const birthYear = parseInt(policyInfo.birthYear);
          const policyStartYear = parseInt(policyInfo.policyStartYear);
          const coverageEndYear = policyInfo.coverageEndYear === 'lifetime' ? null : parseInt(policyInfo.coverageEndYear);
          
          startAge = policyStartYear - birthYear;
          endAge = coverageEndYear ? (coverageEndYear - birthYear) : 100;
        }
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰‹åŠ¨è¾“å…¥
        const needsManualInput = !formattedAmount || !startAge || !endAge;
        
        content = `
          <div style="margin-top: 12px;">
            <!-- ä¸‰åˆ—å¸ƒå±€ï¼šèµ·å§‹å¹´é¾„ã€ç»“æŸå¹´é¾„ã€ç†èµ”é‡‘é¢ï¼ˆåŒä¸€è¡Œï¼‰ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: ${needsManualInput ? '10px' : '0'}; align-items: end;">
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœå¼€å§‹å¹´é¾„ï¼ˆå²ï¼‰</label>
                <input type="number" class="payout-tier-start-age" data-tier="0" data-field="startAge" 
                       value="${startAge || ''}" 
                       placeholder="èµ·å§‹"
                       style="width: 100%; padding: 8px; border: 2px solid ${needsManualInput ? 'rgba(255, 99, 99, 0.5)' : '#E5F9FA'}; border-radius: 4px; font-size: 14px; background: ${needsManualInput ? 'rgba(255, 182, 193, 0.2)' : '#ffffff'}; text-align: center;" />
              </div>
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœç»“æŸå¹´é¾„ï¼ˆå²ï¼‰</label>
                <input type="number" class="payout-tier-end-age" data-tier="0" data-field="endAge" 
                       value="${endAge || ''}" 
                       placeholder="ç»“æŸ"
                       style="width: 100%; padding: 8px; border: 2px solid ${needsManualInput ? 'rgba(255, 99, 99, 0.5)' : '#E5F9FA'}; border-radius: 4px; font-size: 14px; background: ${needsManualInput ? 'rgba(255, 182, 193, 0.2)' : '#ffffff'}; text-align: center;" />
              </div>
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ç†èµ”é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
                <input type="number" step="0.1" class="payout-tier-amount" data-tier="0" data-field="amount" 
                       value="${formattedAmount || ''}" 
                       placeholder="è¯·è¾“å…¥"
                       style="width: 100%; padding: 8px; border: 2px solid ${needsManualInput ? 'rgba(255, 99, 99, 0.5)' : '#E5F9FA'}; border-radius: 4px; font-size: 14px; background: ${needsManualInput ? 'rgba(255, 182, 193, 0.2)' : '#ffffff'};" />
              </div>
            </div>
            
            <!-- åªåœ¨éœ€è¦æ‰‹åŠ¨è¾“å…¥æ—¶æ˜¾ç¤ºå¢å¹…å’Œå•åˆ©/å¤åˆ© -->
            ${needsManualInput ? `
              <div style="display: flex; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e0e0e0;">
                <div style="flex: 0 0 auto;">
                  <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å¢å¹…ï¼ˆ%ï¼‰<span style="color: #999; font-weight: normal;">ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰</span></label>
                  <input type="number" step="0.01" class="payout-tier-increase" data-tier="0" data-field="increase" 
                         value="0" 
                         placeholder="0" 
                         style="width: 120px; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff;" />
                </div>
                <div style="flex: 0 0 auto;">
                  <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å•åˆ©/å¤åˆ©<span style="color: #999; font-weight: normal;">ï¼ˆå¯é€‰ï¼Œé»˜è®¤å•åˆ©ï¼‰</span></label>
                  <select class="payout-tier-interest-type" data-tier="0" data-field="interestType" 
                          style="width: 120px; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff;">
                    <option value="simple" selected>å•åˆ©</option>
                    <option value="compound">å¤åˆ©</option>
                  </select>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      } else if (data && (data.type === 'tiered' || data.type === 'conditional') && (data.details?.tiers || data.details?.conditions)) {
        // åˆ†é˜¶æ®µæ˜¾ç¤ºï¼ˆå…¼å®¹tieredå’Œconditionalä¸¤ç§æ ¼å¼ï¼‰
        // ğŸ¯ ç»Ÿä¸€è·å–tiersæˆ–conditionsæ•°ç»„
        const tiersArray = data.details.tiers || data.details.conditions || [];
        
        console.log('ğŸš€ [createPayoutAmountDisplay] ========== å¼€å§‹å¤„ç†tiered/conditionalç±»å‹ ==========');
        console.log('ğŸš€ [createPayoutAmountDisplay] data.type:', data.type);
        console.log('ğŸš€ [createPayoutAmountDisplay] tiersArray.length:', tiersArray.length);
        console.log('ğŸš€ [createPayoutAmountDisplay] policyInfoå­˜åœ¨:', !!policyInfo);
        
        content = '<div style="margin-top: 12px;">';
        if (!policyInfo) {
          content += '<div style="padding: 8px; background: #e3f2fd; border-radius: 4px; margin-bottom: 12px; font-size: 12px; color: #1976d2;">ğŸ’¡ æç¤ºï¼šè¯·å…ˆå¡«å†™ä¿å•åŸºæœ¬ä¿¡æ¯ï¼ˆå‡ºç”Ÿå¹´ä»½ã€æŠ•ä¿å¼€å§‹å¹´ä»½ã€åŸºæœ¬ä¿é¢ï¼‰ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—å¹´é¾„å’Œé‡‘é¢</div>';
        }
        // å…ˆè®¡ç®—æ‰€æœ‰é˜¶æ®µçš„å¹´é¾„èŒƒå›´ï¼Œä»¥ä¾¿"ä¹‹å"é˜¶æ®µèƒ½æ­£ç¡®å¼•ç”¨å‰ä¸€ä¸ªé˜¶æ®µçš„ç»“æŸå¹´é¾„
        // ğŸ¯ ç­‰å¾…æœŸä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„åˆ†æ®µï¼Œä¼šè¢«æ˜¾ç¤ºå‡ºæ¥
        console.log('ğŸ” [createPayoutAmountDisplay] åŸå§‹tiers/conditionsæ•°é‡:', tiersArray.length);
        console.log('ğŸ” [createPayoutAmountDisplay] åŸå§‹tiers/conditions:', JSON.stringify(tiersArray, null, 2));
        
        // ğŸ”¥ æ ¸å¿ƒè°ƒè¯•ï¼šæ£€æŸ¥æ¯ä¸ªtierçš„keyAmounts
        tiersArray.forEach((tier, index) => {
          console.log(`ğŸ”¥ [DEBUG] é˜¶æ®µ${index + 1} keyAmountså­˜åœ¨:`, !!(tier.keyAmounts));
          console.log(`ğŸ”¥ [DEBUG] é˜¶æ®µ${index + 1} keyAmountsé•¿åº¦:`, tier.keyAmounts?.length || 0);
          if (tier.keyAmounts && tier.keyAmounts.length > 0) {
            console.log(`ğŸ”¥ [DEBUG] é˜¶æ®µ${index + 1} keyAmountså‰3ä¸ª:`, tier.keyAmounts.slice(0, 3));
          }
        });
        
        console.log('ğŸš¨ [CRITICAL] å‡†å¤‡å¼€å§‹validTiersè¿‡æ»¤ï¼ŒtiersArrayé•¿åº¦:', tiersArray.length);
        
        const validTiers = tiersArray.filter((tier, index) => {
          console.log(`ğŸš¨ [CRITICAL FILTER] æ­£åœ¨æ£€æŸ¥é˜¶æ®µ ${index + 1}`);

          console.log(`ğŸ” [createPayoutAmountDisplay] æ£€æŸ¥é˜¶æ®µ ${index + 1}:`, {
            period: tier.period,
            value: tier.value,
            unit: tier.unit,
            valueType: typeof tier.value,
            hasKeyAmounts: !!(tier.keyAmounts && tier.keyAmounts.length > 0),
            keyAmountsLength: tier.keyAmounts?.length || 0
          });
          
          // ğŸ¯ ä¸è¿‡æ»¤ç­‰å¾…æœŸé˜¶æ®µï¼Œå› ä¸ºç­‰å¾…æœŸä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„åˆ†æ®µï¼Œç”¨æˆ·éœ€è¦äº†è§£ç­‰å¾…æœŸçš„ä¿éšœæƒ…å†µ
          
          // ğŸ¯ è¿‡æ»¤1ï¼šå·²è¿‡æœŸçš„å¹´é¾„é˜¶æ®µï¼ˆå¦‚ç”¨æˆ·26å²æŠ•ä¿ï¼Œä¸æ˜¾ç¤º18å²å‰çš„é˜¶æ®µï¼‰
          if (policyInfo && tier.period) {
            const currentAge = parseInt(policyInfo.policyStartYear) - parseInt(policyInfo.birthYear);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯"18å‘¨å²å‰"æˆ–"Xå²å‰"çš„é˜¶æ®µ
            const ageBeforeMatch = tier.period.match(/(\d+)\s*å‘¨å².*?å‰|(\d+)\s*å².*?å‰/);
            if (ageBeforeMatch) {
              const limitAge = parseInt(ageBeforeMatch[1] || ageBeforeMatch[2]);
              if (currentAge >= limitAge) {
                console.log(`âŒ [createPayoutAmountDisplay] é˜¶æ®µ ${index + 1} è¢«è¿‡æ»¤ï¼šç”¨æˆ·${currentAge}å²æŠ•ä¿ï¼Œ${limitAge}å²å‰çš„é˜¶æ®µå·²è¿‡æœŸ`, tier.period);
                return false;
              }
            }
          }
          
          // ğŸ¯ è¿‡æ»¤3ï¼šæ ¹æ®ç¼´è´¹æ–¹å¼è¿‡æ»¤ï¼ˆè¶¸äº¤ vs æœŸäº¤ï¼‰
          if (policyInfo && policyInfo.totalPaymentPeriod && tier.period) {
            const isSinglePay = policyInfo.totalPaymentPeriod === "1"; // è¶¸äº¤
            const tierPeriod = tier.period.toLowerCase();
            
            if (isSinglePay) {
              // ç”¨æˆ·æ˜¯è¶¸äº¤ï¼Œè¿‡æ»¤æ‰æœŸäº¤çš„é˜¶æ®µ
              if (tierPeriod.includes('åˆ†æœŸ') || tierPeriod.includes('æœŸäº¤') || tierPeriod.includes('äº¤è´¹æœŸæ»¡')) {
                console.log(`âŒ [createPayoutAmountDisplay] é˜¶æ®µ ${index + 1} è¢«è¿‡æ»¤ï¼šç”¨æˆ·è¶¸äº¤ï¼Œä½†é˜¶æ®µæ˜¯æœŸäº¤ç›¸å…³`, tier.period);
                return false;
              }
            } else {
              // ç”¨æˆ·æ˜¯æœŸäº¤ï¼Œè¿‡æ»¤æ‰è¶¸äº¤çš„é˜¶æ®µ
              if (tierPeriod.includes('è¶¸äº¤')) {
                console.log(`âŒ [createPayoutAmountDisplay] é˜¶æ®µ ${index + 1} è¢«è¿‡æ»¤ï¼šç”¨æˆ·æœŸäº¤ï¼Œä½†é˜¶æ®µæ˜¯è¶¸äº¤`, tier.period);
                return false;
              }
            }
          }
          
          console.log(`âœ… [createPayoutAmountDisplay] é˜¶æ®µ ${index + 1} é€šè¿‡è¿‡æ»¤`);
          return true;
        });
        
        console.log('ğŸ” [createPayoutAmountDisplay] è¿‡æ»¤åçš„tiersæ•°é‡:', validTiers.length);
        console.log('ğŸ” [createPayoutAmountDisplay] è¿‡æ»¤åçš„tiers:', JSON.stringify(validTiers, null, 2));
        
        if (validTiers.length === 0) {
          // å¦‚æœæ‰€æœ‰é˜¶æ®µéƒ½æ˜¯ä¿è´¹è¿”è¿˜ï¼Œæ˜¾ç¤ºæç¤º
          content += '<div style="padding: 10px; background: rgba(255, 182, 193, 0.2); border-radius: 4px; color: #d32f2f;">âš ï¸ æœªè¯†åˆ«åˆ°çœŸæ­£çš„ç†èµ”é‡‘é¢ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥</div>';
          content += '</div>';
          div.innerHTML = `
            <div class="result-label">
              <span>èµ”ä»˜é‡‘é¢</span>
              ${confidence > 0 ? `<span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>` : ''}
            </div>
            ${content}
          `;
          return div;
        }
        
        // ğŸ”¥ å±•å¼€åµŒå¥—çš„tieredç»“æ„ï¼šå¦‚æœtier.valueæ˜¯å¯¹è±¡ä¸”åŒ…å«tiersï¼Œå±•å¼€ä¸ºå¤šä¸ªé˜¶æ®µ
        const expandedTiers = [];
        validTiers.forEach((tier, tierIndex) => {
          console.log(`ğŸ” [createPayoutAmountDisplay] å¤„ç†é˜¶æ®µ ${tierIndex + 1}:`, {
            period: tier.period,
            value: tier.value,
            valueType: typeof tier.value,
            hasTiers: typeof tier.value === 'object' && tier.value !== null && tier.value.tiers && Array.isArray(tier.value.tiers)
          });
          
          if (typeof tier.value === 'object' && tier.value !== null && tier.value.tiers && Array.isArray(tier.value.tiers)) {
            // è¿™æ˜¯ä¸€ä¸ªåµŒå¥—çš„tieredç»“æ„ï¼Œéœ€è¦å±•å¼€
            console.log(`ğŸ” [createPayoutAmountDisplay] é˜¶æ®µ ${tierIndex + 1} æ˜¯åµŒå¥—ç»“æ„ï¼Œå±•å¼€ä¸º ${tier.value.tiers.length} ä¸ªå­é˜¶æ®µ`);
            tier.value.tiers.forEach((nestedTier, nestedIndex) => {
              const expandedTier = {
                ...nestedTier,
                period: nestedTier.period || tier.period, // ä½¿ç”¨åµŒå¥—tierçš„periodï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨çˆ¶tierçš„period
                value: nestedTier.value || nestedTier.percentage || 100,
                unit: nestedTier.unit || 'percentage',
                keyAmounts: nestedTier.keyAmounts || tier.keyAmounts, // ğŸ”¥ ç¡®ä¿ä¿ç•™keyAmounts
                formula: nestedTier.formula || tier.formula, // ğŸ”¥ ç¡®ä¿ä¿ç•™formula
                formulaType: nestedTier.formulaType || tier.formulaType // ğŸ”¥ ç¡®ä¿ä¿ç•™formulaType
              };
              console.log(`  âœ… å±•å¼€å­é˜¶æ®µ ${nestedIndex + 1}:`, expandedTier);
              console.log(`  ğŸ”¥ [DEBUG] å±•å¼€åkeyAmountsé•¿åº¦:`, expandedTier.keyAmounts?.length || 0);
              expandedTiers.push(expandedTier);
            });
          } else {
            // æ™®é€šé˜¶æ®µï¼Œç›´æ¥æ·»åŠ 
            console.log(`âœ… [createPayoutAmountDisplay] é˜¶æ®µ ${tierIndex + 1} æ˜¯æ™®é€šé˜¶æ®µï¼Œç›´æ¥æ·»åŠ `);
            console.log(`ğŸ”¥ [DEBUG] æ™®é€šé˜¶æ®µkeyAmountsé•¿åº¦:`, tier.keyAmounts?.length || 0);
            if (tier.keyAmounts && tier.keyAmounts.length > 0) {
              console.log(`ğŸ”¥ [DEBUG] æ™®é€šé˜¶æ®µkeyAmountså‰3ä¸ª:`, tier.keyAmounts.slice(0, 3));
            }
            expandedTiers.push(tier);
          }
        });
        
        console.log(`ğŸ” [createPayoutAmountDisplay] å±•å¼€åçš„é˜¶æ®µæ•°é‡: ${expandedTiers.length}`);
        console.log('ğŸ” [createPayoutAmountDisplay] å±•å¼€åçš„tiers:', JSON.stringify(expandedTiers, null, 2));
        
        const calculatedTiers = [];
        expandedTiers.forEach((tier, index) => {
          console.log(`ğŸ” [createPayoutAmountDisplay] è®¡ç®—é˜¶æ®µ ${index + 1} çš„å¹´é¾„èŒƒå›´:`, {
            period: tier.period,
            value: tier.value,
            unit: tier.unit,
            formula: tier.formula,
            formulaType: tier.formulaType,
            interestRate: tier.interestRate
          });
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯å…¬å¼ç±»å‹ï¼ˆæ›´å…¨é¢çš„è¯†åˆ«ï¼‰
          // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¦‚æœåç«¯è¿”å›äº†keyAmountsï¼Œè¯´æ˜æ˜¯å…¬å¼ç±»å‹ï¼ˆMaxæ¯”è¾ƒã€å¤åˆ©ç­‰ï¼‰
          const isFormula = (tier.keyAmounts && tier.keyAmounts.length > 0) ||
                           tier.unit === 'formula' || 
                           tier.formula || 
                           tier.formulaType ||
                           (typeof tier.value === 'string' && (
                             tier.value.includes('^') || 
                             tier.value.includes('**') ||
                             (tier.value.includes('*') && tier.value.includes('(')) ||
                             tier.value.includes('(1+') ||
                             tier.value.includes('ä¿å•å¹´åº¦')
                           ));
          
          console.log(`ğŸ” [é˜¶æ®µ${index + 1}] å…¬å¼è¯†åˆ«: isFormula=${isFormula}, hasKeyAmounts=${!!(tier.keyAmounts)}, unit=${tier.unit}, formula=${tier.formula}`);

          
          let formattedAmount;
          if (isFormula && policyInfo) {
            // å…¬å¼ç±»å‹ï¼šéœ€è¦ç‰¹æ®Šå¤„ç†
            console.log(`âœ… [é˜¶æ®µ${index + 1}] è¯†åˆ«ä¸ºå…¬å¼ç±»å‹ï¼Œè°ƒç”¨formatFormulaTier`);
            console.log(`ğŸ”¥ [DEBUG] è°ƒç”¨formatFormulaTierå‰ï¼Œtier.keyAmounts:`, tier.keyAmounts?.length || 0);
            formattedAmount = formatFormulaTier(tier, policyInfo, index, calculatedTiers);
            console.log(`âœ… [é˜¶æ®µ${index + 1}] formatFormulaTierè¿”å›:`, {
              isFormula: formattedAmount.isFormula,
              keyAmounts: formattedAmount.keyAmounts?.length || 0,
              formula: formattedAmount.formula
            });
            console.log(`ğŸ”¥ [DEBUG] formatFormulaTierè¿”å›åï¼ŒformattedAmount.keyAmountså‰3ä¸ª:`, formattedAmount.keyAmounts?.slice(0, 3));
            
            // ğŸ”¥ é‡è¦ï¼šå°†å…¬å¼ç±»å‹çš„é˜¶æ®µä¹Ÿpushåˆ°calculatedTiersï¼
            calculatedTiers.push(formattedAmount);
            console.log(`âœ… [é˜¶æ®µ${index + 1}] å·²æ·»åŠ åˆ°calculatedTiersï¼Œå½“å‰é•¿åº¦: ${calculatedTiers.length}`);
            
          } else if (policyInfo) {
            formattedAmount = formatPayoutAmountForTier(tier, policyInfo, index, calculatedTiers);
            
            console.log(`ğŸ” [createPayoutAmountDisplay] é˜¶æ®µ ${index + 1} è®¡ç®—ç»“æœ:`, {
              startAge: formattedAmount.startAge,
              endAge: formattedAmount.endAge,
              amount: formattedAmount.amount
            });
            
            // ğŸ”¥ é‡è¦ï¼šå¦‚æœåç«¯å·²è¿”å›keyAmountsï¼Œç›´æ¥ä½¿ç”¨åç«¯è®¡ç®—çš„å¹´é¾„èŒƒå›´ï¼Œä¸è¦è¦†ç›–ï¼
            if (formattedAmount.keyAmounts && formattedAmount.keyAmounts.length > 0) {
              console.log(`âœ… [createPayoutAmountDisplay] é˜¶æ®µ${index + 1}ä½¿ç”¨åç«¯è¿”å›çš„å¹´é¾„èŒƒå›´: ${formattedAmount.startAge}å²-${formattedAmount.endAge}å²`);
            } else {
              // ä»…åœ¨åç«¯æœªè¿”å›keyAmountsæ—¶ï¼Œå‰ç«¯æ‰è°ƒæ•´å¹´é¾„èŒƒå›´
              if (expandedTiers.length === 1 && tier.period && (tier.period.includes('ç­‰å¾…æœŸå') || tier.period.includes('æ—¥å'))) {
                // è¿™æ˜¯å”¯ä¸€ä¸€ä¸ªé˜¶æ®µï¼ˆç­‰å¾…æœŸåçš„çœŸæ­£ç†èµ”ï¼‰ï¼Œä»æŠ•ä¿å¹´é¾„å¼€å§‹
                const startAge = parseInt(policyInfo.policyStartYear) - parseInt(policyInfo.birthYear);
                const endAge = policyInfo.coverageEndYear === 'lifetime' ? 100 : 
                  (parseInt(policyInfo.coverageEndYear) - parseInt(policyInfo.birthYear));
                formattedAmount.startAge = startAge;
                formattedAmount.endAge = endAge;
                console.log(`ğŸ” [createPayoutAmountDisplay] ç­‰å¾…æœŸåï¼ˆå”¯ä¸€é˜¶æ®µï¼Œè¿‡æ»¤åï¼‰: ${formattedAmount.startAge}å²ï½${formattedAmount.endAge}å²`);
              } else if (index > 0) {
                const prevTier = calculatedTiers[index - 1];
                if (prevTier && prevTier.endAge !== undefined) {
                  // å¦‚æœå½“å‰é˜¶æ®µçš„èµ·å§‹å¹´é¾„å°äºç­‰äºå‰ä¸€ä¸ªé˜¶æ®µçš„ç»“æŸå¹´é¾„ï¼Œè¯´æ˜éœ€è¦ä»å‰ä¸€ä¸ªé˜¶æ®µç»“æŸåå¼€å§‹
                  if (formattedAmount.startAge <= prevTier.endAge) {
                    formattedAmount.startAge = prevTier.endAge + 1; // ä»ä¸Šä¸€é˜¶æ®µç»“æŸåå¼€å§‹
                    console.log(`ğŸ” [createPayoutAmountDisplay] è°ƒæ•´é˜¶æ®µ${index + 1}èµ·å§‹å¹´é¾„ä¸º ${formattedAmount.startAge}å²ï¼ˆå‰ç«¯Fallbackï¼‰`);
                  }
                }
              }
            }
            
            // æœ€ç»ˆå®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿èµ·å§‹å¹´é¾„ä¸è¶…è¿‡ç»“æŸå¹´é¾„
            if (formattedAmount.startAge > formattedAmount.endAge) {
              console.warn(`âš ï¸ [createPayoutAmountDisplay] èµ·å§‹å¹´é¾„(${formattedAmount.startAge})å¤§äºç»“æŸå¹´é¾„(${formattedAmount.endAge})ï¼Œè°ƒæ•´ä¸ºä»æŠ•ä¿å¹´é¾„å¼€å§‹`);
              const startAge = parseInt(policyInfo.policyStartYear) - parseInt(policyInfo.birthYear);
              const endAge = policyInfo.coverageEndYear === 'lifetime' ? 100 : 
                (parseInt(policyInfo.coverageEndYear) - parseInt(policyInfo.birthYear));
              formattedAmount.startAge = startAge;
              formattedAmount.endAge = endAge;
            }
            
            calculatedTiers.push(formattedAmount);
          } else {
            // å¦‚æœæ²¡æœ‰policyInfoï¼Œæ˜¾ç¤ºç™¾åˆ†æ¯”å’Œä¿å•å¹´åº¦ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
            const percentage = tier.value || 100;
            formattedAmount = {
              amount: '', // ç©ºå€¼ï¼Œè®©ç”¨æˆ·è¾“å…¥
              startAge: '', // ç©ºå€¼ï¼Œè®©ç”¨æˆ·è¾“å…¥
              endAge: '', // ç©ºå€¼ï¼Œè®©ç”¨æˆ·è¾“å…¥
              increase: 0,
              interestType: 'simple',
              period: tier.period, // ä¿å­˜åŸå§‹æœŸé—´æè¿°
              percentage: percentage // ä¿å­˜ç™¾åˆ†æ¯”
            };
            calculatedTiers.push(formattedAmount);
          }
        });
        
        // ğŸ¯ æœ€ç»ˆè¿‡æ»¤ï¼šåªæ¸²æŸ“æœ‰keyAmountsçš„é˜¶æ®µï¼ˆæ’é™¤æ²¡æœ‰è¢«åç«¯è®¡ç®—çš„é˜¶æ®µï¼‰
        // ğŸ”¥ é‡è¦ï¼šåŒæ—¶ä¿ç•™åŸå§‹tieræ•°æ®å’ŒformattedAmountæ•°æ®ï¼Œé¿å…ç´¢å¼•ä¸åŒ¹é…
        console.log('ğŸš¨ [DEBUG] calculatedTiersè¯¦æƒ…:');
        calculatedTiers.forEach((tier, idx) => {
          console.log(`  é˜¶æ®µ${idx + 1}:`, {
            isFormula: tier.isFormula,
            hasKeyAmounts: !!(tier.keyAmounts),
            keyAmountsLength: tier.keyAmounts?.length || 0,
            period: tier.period
          });
        });
        
        const renderableTiers = calculatedTiers.map((formattedAmount, index) => ({
          formattedAmount,
          tier: expandedTiers[index],
          originalIndex: index
        })).filter(({ formattedAmount, tier, originalIndex }) => {
          console.log(`ğŸš¨ [æ¸²æŸ“è¿‡æ»¤] æ£€æŸ¥é˜¶æ®µ${originalIndex + 1}:`, {
            isFormula: formattedAmount.isFormula,
            hasKeyAmounts: !!(formattedAmount.keyAmounts),
            keyAmountsLength: formattedAmount.keyAmounts?.length || 0
          });
          
          if (formattedAmount.isFormula && (!formattedAmount.keyAmounts || formattedAmount.keyAmounts.length === 0)) {
            console.log(`âš ï¸ [æ¸²æŸ“è¿‡æ»¤] é˜¶æ®µ${originalIndex + 1}æ²¡æœ‰keyAmountsï¼Œè·³è¿‡æ¸²æŸ“`, formattedAmount.period);
            return false;
          }
          console.log(`âœ… [æ¸²æŸ“è¿‡æ»¤] é˜¶æ®µ${originalIndex + 1}é€šè¿‡è¿‡æ»¤`);
          return true;
        });
        
        console.log('ğŸ¨ [createPayoutAmountDisplay] å¼€å§‹æ¸²æŸ“ï¼Œå¯æ¸²æŸ“é˜¶æ®µæ•°é‡:', renderableTiers.length, '/', calculatedTiers.length);
        
        renderableTiers.forEach(({ formattedAmount, tier }, index) => {
          console.log(`ğŸ¨ [æ¸²æŸ“é˜¶æ®µ${index + 1}] formattedAmount:`, {
            isFormula: formattedAmount.isFormula,
            hasKeyAmounts: !!(formattedAmount.keyAmounts && formattedAmount.keyAmounts.length > 0),
            keyAmountsLength: formattedAmount.keyAmounts?.length || 0,
            period: formattedAmount.period,
            tierPeriod: tier?.period
          });
          console.log(`ğŸ”¥ [DEBUG] æ¸²æŸ“é˜¶æ®µ${index + 1} - tierå’ŒformattedAmountçš„periodæ˜¯å¦åŒ¹é…:`, tier?.period === formattedAmount.period);
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯å…¬å¼ç±»å‹ï¼ˆä¼˜å…ˆæ£€æŸ¥formattedAmount.isFormulaï¼Œå› ä¸ºformatFormulaTierä¼šè®¾ç½®è¿™ä¸ªæ ‡å¿—ï¼‰
          const isFormula = formattedAmount.isFormula || tier?.unit === 'formula' || tier?.formula || tier?.formulaType || (typeof tier?.value === 'string' && (tier.value.includes('^') || tier.value.includes('*') || tier.value.includes('(')));
          
          // ğŸ” è¯¦ç»†è°ƒè¯•æ—¥å¿—
          console.log(`ğŸ” [æ¸²æŸ“é˜¶æ®µ${index + 1}] ========== å¼€å§‹ ==========`);
          console.log(`ğŸ” [æ¸²æŸ“é˜¶æ®µ${index + 1}] isFormula:${isFormula}`);
          console.log(`ğŸ” [æ¸²æŸ“é˜¶æ®µ${index + 1}] tieræ•°æ®:`, JSON.stringify(tier, null, 2));
          console.log(`ğŸ” [æ¸²æŸ“é˜¶æ®µ${index + 1}] formattedAmountæ•°æ®:`, JSON.stringify(formattedAmount, null, 2));
          console.log(`ğŸ” [æ¸²æŸ“é˜¶æ®µ${index + 1}] policyInfo:`, JSON.stringify(policyInfo, null, 2));
          console.log(`ğŸ” [æ¸²æŸ“é˜¶æ®µ${index + 1}] ========== ç»“æŸ ==========`);
          
          console.log(`ğŸ¨ [æ¸²æŸ“é˜¶æ®µ${index + 1}] å¼€å§‹æ¸²æŸ“ï¼ŒisFormula=${isFormula}, hasKeyAmounts=${!!(formattedAmount.keyAmounts && formattedAmount.keyAmounts.length > 0)}`);
          
          if (isFormula) {
            console.log(`âœ… [æ¸²æŸ“é˜¶æ®µ${index + 1}] è¯†åˆ«ä¸ºå…¬å¼ç±»å‹ï¼Œå‡†å¤‡æ¸²æŸ“å…¬å¼+é‡‘é¢è¡¨æ ¼`);
            // å¦‚æœæ²¡æœ‰keyAmountsï¼Œå°è¯•é‡æ–°ç”Ÿæˆï¼ˆå¯èƒ½æ˜¯ä»å¤§æ¨¡å‹è¿”å›çš„æ•°æ®ä¸­è§£æï¼‰
            if (!formattedAmount.keyAmounts || formattedAmount.keyAmounts.length === 0) {
              console.warn(`âš ï¸ [æ¸²æŸ“é˜¶æ®µ${index + 1}] å…¬å¼ç±»å‹ä½†ç¼ºå°‘keyAmountsï¼Œå°è¯•é‡æ–°ç”Ÿæˆ`);
              // å¦‚æœformattedAmountæœ‰å…¬å¼ä¿¡æ¯ï¼Œå°è¯•é‡æ–°è®¡ç®—
              if (formattedAmount.formula || formattedAmount.interestRate) {
                const basicSumInsuredWan = policyInfo.basicSumInsured / 10000;
                const startAge = formattedAmount.startAge || (parseInt(policyInfo.policyStartYear) - parseInt(policyInfo.birthYear));
                const endAge = formattedAmount.endAge || (policyInfo.coverageEndYear === 'lifetime' ? 100 : (parseInt(policyInfo.coverageEndYear) - parseInt(policyInfo.birthYear)));
                const interestRate = formattedAmount.interestRate || 3.5;
                const formulaType = formattedAmount.formulaType || 'compound';
                
                // è®¡ç®—å…³é”®èŠ‚ç‚¹
                const keyAges = [startAge];
                const totalYears = endAge - startAge + 1;
                if (totalYears > 5) keyAges.push(Math.min(startAge + 4, endAge));
                if (totalYears > 10) keyAges.push(Math.min(startAge + 9, endAge));
                if (totalYears > 20) keyAges.push(Math.min(startAge + 19, endAge));
                if (totalYears > 30) keyAges.push(Math.min(startAge + 29, endAge));
                if (endAge !== keyAges[keyAges.length - 1]) {
                  keyAges.push(endAge);
                }
                
                const uniqueKeyAges = [...new Set(keyAges)].sort((a, b) => a - b);
                formattedAmount.keyAmounts = uniqueKeyAges.map(age => {
                  const n = age - startAge;
                  let amount;
                  if (formulaType === 'compound') {
                    amount = basicSumInsuredWan * Math.pow(1 + interestRate / 100, n);
                  } else {
                    amount = basicSumInsuredWan * (1 + interestRate / 100 * n);
                  }
                  return { age, amount: parseFloat(amount.toFixed(1)) };
                });
                console.log(`âœ… [æ¸²æŸ“é˜¶æ®µ${index + 1}] é‡æ–°ç”ŸæˆkeyAmounts:`, formattedAmount.keyAmounts);
              }
            }
            
            console.log(`ğŸ”¥ [CRITICAL] æ¸²æŸ“é˜¶æ®µ${index + 1} - å‡†å¤‡æ£€æŸ¥keyAmounts:`, {
              hasKeyAmounts: !!(formattedAmount.keyAmounts),
              keyAmountsLength: formattedAmount.keyAmounts?.length || 0,
              keyAmountsType: typeof formattedAmount.keyAmounts,
              first3: formattedAmount.keyAmounts?.slice(0, 3)
            });
            
            if (formattedAmount.keyAmounts && formattedAmount.keyAmounts.length > 0) {
              console.log(`âœ… [CRITICAL] æ¸²æŸ“é˜¶æ®µ${index + 1} - keyAmountsæ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹æ„å»ºHTML`);
              console.log(`ğŸ¯ğŸ¯ğŸ¯ [CRITICAL] é˜¶æ®µ${index + 1}æ¸²æŸ“å‰çš„formattedAmount.startAge = ${formattedAmount.startAge}`);
              console.log(`ğŸ¯ğŸ¯ğŸ¯ [CRITICAL] é˜¶æ®µ${index + 1}æ¸²æŸ“å‰çš„formattedAmount.endAge = ${formattedAmount.endAge}`);
              console.log(`ğŸ¯ğŸ¯ğŸ¯ [CRITICAL] é˜¶æ®µ${index + 1}æ¸²æŸ“å‰çš„formattedAmountå®Œæ•´å¯¹è±¡:`, JSON.stringify(formattedAmount, null, 2));
              // å…¬å¼ç±»å‹ï¼šæ˜¾ç¤ºå…¬å¼å’Œå…³é”®èŠ‚ç‚¹ç¤ºä¾‹
              const basicSumInsuredWan = policyInfo.basicSumInsured / 10000;
              const formulaDisplay = formattedAmount.formula || `${basicSumInsuredWan}*(1+${formattedAmount.interestRate}%)^n`;
              // ğŸ¯ æ­£ç¡®è¯†åˆ«formulaTypeï¼šmax/compound/simple
              let formulaTypeText = 'å•åˆ©';
              if (formattedAmount.formulaType === 'max') {
                formulaTypeText = 'Maxæ¯”è¾ƒ';
              } else if (formattedAmount.formulaType === 'compound') {
                formulaTypeText = 'å¤åˆ©';
              } else if (formattedAmount.formulaType === 'simple') {
                formulaTypeText = 'å•åˆ©';
              } else {
                // å¦‚æœæ²¡æœ‰formulaTypeï¼Œå°è¯•ä»formulaæ¨æ–­
                if (formattedAmount.formula && (formattedAmount.formula.includes('Max') || formattedAmount.formula.includes('è¾ƒå¤§è€…'))) {
                  formulaTypeText = 'Maxæ¯”è¾ƒ';
                } else if (formattedAmount.formula && (formattedAmount.formula.includes('^') || formattedAmount.formula.includes('**'))) {
                  formulaTypeText = 'å¤åˆ©';
                }
              }
              
              // ğŸ¯ åˆ¤æ–­å…¬å¼æ˜¯å¦æ¶‰åŠnï¼ˆç”¨äºå†³å®šæ˜¯å¦æ˜¾ç¤ºæ³¨é‡Šï¼‰
              const hasNVariable = formulaDisplay.includes('n') || formulaDisplay.includes('^') || formulaDisplay.includes('(1+');
              
              content += `
              <div style="margin-bottom: ${index < renderableTiers.length - 1 ? '20px' : '0'}; padding: 18px; background: #f0f8fc; border-radius: 8px; border: 1px solid #b3d9e6; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                <!-- é˜¶æ®µæ ‡é¢˜ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #b3d9e6;">
                  <div style="font-weight: 600; color: #1a5a7d; font-size: 15px;">
                    ğŸ“ ç¬¬${index + 1}é˜¶æ®µ${formattedAmount.period ? ' (' + formattedAmount.period + ')' : ''}
                  </div>
                  <button onclick="deleteTier(${index})" 
                          style="display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 4px 8px; font-size: 11px; color: #d73a49; background: transparent; border: none; cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.background='#ffebee'; this.style.color='#c62828';"
                          onmouseout="this.style.background='transparent'; this.style.color='#d73a49';"
                          title="åˆ é™¤æ­¤é˜¶æ®µ">
                    <span style="font-size: 18px;">ğŸ—‘ï¸</span>
                    <span>åˆ é™¤</span>
                  </button>
                </div>
                
                <!-- å…¬å¼æ˜¾ç¤º -->
                <div style="margin-bottom: 14px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                    <span style="font-size: 13px; color: #586069; font-weight: 600;">ğŸ“Š è®¡ç®—å…¬å¼ï¼š</span>
                    <div class="formula-preview" data-tier="${index}" style="flex: 1; font-size: 17px; font-weight: 700; color: #0366d6; font-family: 'Courier New', monospace; word-break: break-all; line-height: 1.5;">${formulaDisplay}</div>
                    <button type="button" class="formula-edit-toggle" data-tier="${index}" onclick="toggleFormulaEditor(${index})"
                            style="display: flex; flex-direction: column; align-items: center; gap: 2px; flex-shrink: 0; padding: 4px 10px; font-size: 11px; background: transparent !important; border: none; color: #0366d6; cursor: pointer; transition: all 0.2s; outline: none;"
                            onmouseover="this.style.background='#e6f3ff'; this.style.color='#0052cc';"
                            onmouseout="this.style.background='transparent'; this.style.color='#0366d6';"
                            onmousedown="this.style.background='#e6f3ff';"
                            onmouseup="this.style.background='#e6f3ff';"
                            onfocus="this.style.outline='none';"
                            title="ä¿®æ”¹å…¬å¼">
                      <span style="font-size: 16px;">âœï¸</span>
                      <span>ç¼–è¾‘</span>
                    </button>
                  </div>
                  ${hasNVariable ? '<div style="font-size: 11px; color: #6a737d; margin-left: 90px; font-style: italic;">ğŸ’¡ nè¡¨ç¤ºä»èµ·å§‹å¹´é¾„å¼€å§‹çš„å¹´æ•°ï¼Œn=0è¡¨ç¤ºèµ·å§‹å¹´é¾„å½“å¹´</div>' : ''}
                </div>
                  
                  <!-- å…¬å¼ç¼–è¾‘åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
                  <div class="formula-editor-container" data-tier="${index}" style="display: none; margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 4px; border: 1px dashed #e0e0e0;">
                    <!-- å…¬å¼ç±»å‹é€‰æ‹© -->
                    <div style="margin-bottom: 10px;">
                      <label style="font-size: 11px; color: #999; display: block; margin-bottom: 4px;">å…¬å¼ç±»å‹</label>
                      <select class="formula-type-select" data-tier="${index}" 
                              onchange="updateFormulaParams(${index})"
                              style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px; background: #fff; cursor: pointer;">
                        <option value="fixed" ${formattedAmount.formulaType === 'fixed' || (!formattedAmount.formulaType && !hasNVariable) ? 'selected' : ''}>å›ºå®šé‡‘é¢</option>
                        <option value="simple" ${formattedAmount.formulaType === 'simple' ? 'selected' : ''}>å•åˆ©è®¡ç®—</option>
                        <option value="compound" ${formattedAmount.formulaType === 'compound' ? 'selected' : ''}>å¤åˆ©è®¡ç®—</option>
                        <option value="max" ${formattedAmount.formulaType === 'max' ? 'selected' : ''}>Maxæ¯”è¾ƒ</option>
                        <option value="min" ${formattedAmount.formulaType === 'min' ? 'selected' : ''}>Minæ¯”è¾ƒ</option>
                      </select>
                    </div>
                    
                    <!-- å…¬å¼å‚æ•°åŒºåŸŸï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
                    <div class="formula-params-container" data-tier="${index}">
                      ${generateFormulaParamsHTML(formattedAmount, index)}
                    </div>
                    
                    <!-- åº”ç”¨æŒ‰é’® -->
                    <button type="button" onclick="applyFormulaChanges(${index})"
                            style="width: 100%; margin-top: 10px; padding: 8px; background: #4caf50; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;"
                            onmouseover="this.style.background='#45a049';"
                            onmouseout="this.style.background='#4caf50';">
                      âœ“ åº”ç”¨ä¿®æ”¹
                    </button>
                </div>
                
                <!-- å¹´é¾„èŒƒå›´ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                  <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœå¼€å§‹å¹´é¾„ï¼ˆå²ï¼‰</label>
                    <input type="number" class="payout-tier-start-age" data-tier="${index}" data-field="startAge" 
                           value="${formattedAmount.startAge || ''}" 
                           data-debug-period="${tier.period || ''}" 
                           data-debug-index="${index}" 
                           placeholder="èµ·å§‹"
                           style="width: 100%; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff; text-align: center; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#CAF4F7'; this.style.background='#e0f7fa';"
                           onmouseout="this.style.borderColor='#E5F9FA'; this.style.background='#ffffff';"
                           onfocus="this.style.borderWidth='3px';"
                           onblur="this.style.borderWidth='2px';" />
                  </div>
                  <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœç»“æŸå¹´é¾„</label>
                    <input type="text" class="payout-tier-end-age" data-tier="${index}" data-field="endAge" 
                           value="${formattedAmount.endAge === 100 || formattedAmount.endAge === 'lifetime' ? 'ç»ˆèº«' : (formattedAmount.endAge || '')}" 
                           placeholder="ç»“æŸæˆ–è¾“å…¥'ç»ˆèº«'"
                           style="width: 100%; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff; text-align: center; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#CAF4F7'; this.style.background='#e0f7fa';"
                           onmouseout="this.style.borderColor='#E5F9FA'; this.style.background='#ffffff';"
                           onfocus="this.style.borderWidth='3px';"
                           onblur="this.style.borderWidth='2px';"
                           title="å¯è¾“å…¥å…·ä½“å¹´é¾„æˆ–'ç»ˆèº«'" />
                  </div>
                </div>
                
                <!-- é‡‘é¢ç¤ºä¾‹ï¼ˆæ”¯æŒå±•å¼€/æ”¶èµ·ï¼‰ -->
                <!-- èµ”ä»˜é‡‘é¢å±•ç¤ºï¼ˆè¡¨æ ¼å¼ï¼‰ -->
                <div style="margin-top: 12px;">
                  ${(() => {
                    // ğŸ¯ æ™ºèƒ½åˆ¤æ–­ï¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰é‡‘é¢éƒ½ç›¸åŒ
                    const amounts = formattedAmount.keyAmounts || [];
                    if (amounts.length === 0) {
                      console.log(`âš ï¸ [æ¸²æŸ“é˜¶æ®µ${index + 1}] keyAmountsä¸ºç©ºï¼Œä¸æ¸²æŸ“é‡‘é¢è¡¨æ ¼`);
                      return '';
                    }
                    
                    const isFixed = amounts[0].isFixed || amounts.every(item => item.amount === amounts[0].amount);
                    const hasSelectedOption = amounts[0].selectedOption;
                    
                    // ğŸ¯ å­˜å‚¨åŸå§‹è®¡ç®—å€¼ï¼ˆç”¨äºé‡ç½®åŠŸèƒ½ï¼‰
                    storeOriginalAmounts(index, amounts, isFixed);
                    
                    console.log(`ğŸ” [æ¸²æŸ“é˜¶æ®µ${index + 1}] é‡‘é¢åˆ¤æ–­:`, {
                      amountsLength: amounts.length,
                      firstAmount: amounts[0].amount,
                      lastAmount: amounts[amounts.length - 1].amount,
                      isFixed: isFixed,
                      hasIsFixedFlag: amounts[0].isFixed,
                      allSame: amounts.every(item => item.amount === amounts[0].amount),
                      first3Amounts: amounts.slice(0, 3).map(a => a.amount)
                    });
                    
                    return isFixed ? 
                    // å›ºå®šå€¼ï¼šæ˜¾ç¤ºèµ”ä»˜æœŸé—´å’Œé‡‘é¢ï¼ˆå¯ç¼–è¾‘ï¼‰
                    `<div style="padding: 14px; background: #ffffff; border-radius: 6px; margin-top: 12px;">
                      ${hasSelectedOption ? `<div style="font-size: 12px; color: #5a7d8f; margin-bottom: 10px;">
                        <strong>âœ… Maxæ¯”è¾ƒç»“æœï¼š</strong>${amounts[0].selectedOption}
                      </div>` : ''}
                      <div style="font-size: 12px; color: #5a7d8f; font-weight: 600; margin-bottom: 8px;">ğŸ“‹ æ¯å¹´ç†èµ”é‡‘é¢ï¼ˆå…±${amounts.length}å¹´ï¼‰</div>
                      <table style="width: 100%; border-collapse: collapse; font-size: 13px; overflow: hidden; border-radius: 4px;">
                        <thead>
                          <tr style="background: #e6f3f9;">
                            <th style="padding: 10px 12px; text-align: left; color: #5a7d8f; font-weight: 600; border-bottom: 2px solid #d0e8f2;">èµ”ä»˜æœŸé—´</th>
                            <th style="padding: 10px 12px; text-align: right; color: #5a7d8f; font-weight: 600; border-bottom: 2px solid #d0e8f2;">ç†èµ”é‡‘é¢</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td style="padding: 10px 12px; color: #3a5a6a;">
                              ${amounts[0].year}å¹´ï¼ˆ${amounts[0].age}å²ï¼‰ï½ ${
                                amounts[0].endYear === 'lifetime' ? 'ç»ˆèº«' : 
                                amounts[0].endYear ? amounts[0].endYear + 'å¹´ï¼ˆ' + amounts[0].endAge + 'å²ï¼‰' :
                                amounts[amounts.length-1].year + 'å¹´ï¼ˆ' + amounts[amounts.length-1].age + 'å²ï¼‰'
                              }
                            </td>
                            <td style="padding: 10px 12px; text-align: right;">
                              <span class="payout-fixed-amount-display" 
                                     data-tier="${index}" 
                                    style="font-size: 18px; font-weight: 700; color: #5FC8D4; padding: 8px 16px; background: #e6f7fa; border-radius: 6px; display: inline-block;">
                                ${amounts[0].amount}
                              </span>
                              <span style="color: #3a7d94; font-weight: 600; margin-left: 4px;">ä¸‡</span>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                      <div style="margin-top: 12px; text-align: center;">
                        <button onclick="recalculateAmount(${index})" 
                                style="padding: 10px 24px; font-size: 13px; color: #ffffff; background: #CAF4F7; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 600; box-shadow: 0 2px 4px rgba(202, 244, 247, 0.4);"
                                onmouseover="this.style.background='#9FE8ED'; this.style.boxShadow='0 4px 8px rgba(1, 188, 214, 0.4)';"
                                onmouseout="this.style.background='#CAF4F7'; this.style.boxShadow='0 2px 4px rgba(202, 244, 247, 0.4)';">
                          ğŸ”„ é‡æ–°è®¡ç®—
                        </button>
                      </div>
                    </div>` 
                    :
                    // æ¯å¹´é‡‘é¢ä¸åŒï¼šæ˜¾ç¤ºè¡¨æ ¼
                    (() => {
                      // ğŸ¯ åªæ˜¾ç¤ºå½“å‰å¹´é¾„åŠä»¥åçš„èµ”ä»˜å¹´ä»½
                      const currentYear = new Date().getFullYear(); // è·å–å½“å‰å¹´ä»½ï¼ˆå¦‚2026ï¼‰
                      const currentAge = policyInfo ? (currentYear - parseInt(policyInfo.birthYear)) : 0; // å½“å‰å¹´é¾„ï¼ˆ26å²ï¼‰
                      const filteredKeyAmounts = formattedAmount.keyAmounts.filter(item => item.age >= currentAge);
                      
                      return `<div style="padding: 14px; background: #ffffff; border-radius: 6px; margin-top: 12px;">
                        <div style="font-size: 12px; color: #5a7d8f; margin-bottom: 10px; font-weight: 600;">
                          ğŸ“‹ æ¯å¹´ç†èµ”é‡‘é¢
                          <span style="color: #8a9fb0; font-weight: normal;">ï¼ˆå…±${filteredKeyAmounts.length}å¹´ï¼‰</span>
                        </div>
                        <div class="year-amounts-container" data-tier="${index}">
                          <div class="year-amounts-visible">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px; overflow: hidden; border-radius: 4px;">
                              <thead>
                                <tr style="background: #e6f3f9;">
                                  <th style="padding: 10px 12px; text-align: left; color: #5a7d8f; font-weight: 600; border-bottom: 2px solid #d0e8f2;">èµ”ä»˜å¹´ä»½</th>
                                  <th style="padding: 10px 12px; text-align: right; color: #5a7d8f; font-weight: 600; border-bottom: 2px solid #d0e8f2;">ç†èµ”é‡‘é¢</th>
                                </tr>
                              </thead>
                              <tbody>
                                ${filteredKeyAmounts.slice(0, 5).map((item, itemIndex) => `
                                  <tr style="border-bottom: 1px solid #f5f8fa;">
                                    <td style="padding: 10px 12px; color: #5a7d8f;">${item.year}å¹´ï¼ˆ${item.age}å²ï¼‰</td>
                                    <td style="padding: 10px 12px; text-align: right;">
                                      <span class="payout-variable-amount-display" 
                                             data-tier="${index}" 
                                             data-age="${item.age}"
                                            style="font-size: 14px; font-weight: 600; color: #5FC8D4;">
                                        ${item.amount}
                                      </span>
                                      <span style="color: #5a7d8f; font-size: 12px; margin-left: 2px;">ä¸‡</span>
                                    </td>
                                  </tr>
                                `).join('')}
                              </tbody>
                            </table>
                          </div>
                          ${filteredKeyAmounts.length > 5 ? `
                            <div class="year-amounts-hidden" style="display: none; margin-top: 8px;">
                              <table style="width: 100%; border-collapse: collapse; font-size: 13px; overflow: hidden; border-radius: 4px;">
                                <tbody>
                                  ${filteredKeyAmounts.slice(5).map((item, itemIndex) => `
                                    <tr style="border-bottom: 1px solid #f5f8fa;">
                                      <td style="padding: 10px 12px; color: #5a7d8f;">${item.year}å¹´ï¼ˆ${item.age}å²ï¼‰</td>
                                      <td style="padding: 10px 12px; text-align: right;">
                                        <span class="payout-variable-amount-display" 
                                               data-tier="${index}" 
                                               data-age="${item.age}"
                                              style="font-size: 14px; font-weight: 600; color: #5FC8D4;">
                                          ${item.amount}
                                        </span>
                                        <span style="color: #5a7d8f; font-size: 12px; margin-left: 2px;">ä¸‡</span>
                                      </td>
                                    </tr>
                                  `).join('')}
                                </tbody>
                              </table>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                              <button type="button" class="toggle-all-years" data-tier="${index}" 
                                      style="width: 100%; padding: 8px 16px; background: #ffffff; border: 2px solid #7ab8d0; border-radius: 4px; color: #3a7d94; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;"
                                      onmouseover="this.style.background='#e6f3f9'; this.style.borderColor='#5a9ab5';"
                                      onmouseout="this.style.background='#ffffff'; this.style.borderColor='#7ab8d0';">
                                <span class="toggle-text">â–¼ æŸ¥çœ‹å…¨éƒ¨${filteredKeyAmounts.length}å¹´</span>
                              </button>
                              <div style="text-align: center;">
                                <button onclick="recalculateAmount(${index})" 
                                        style="padding: 10px 24px; font-size: 13px; color: #ffffff; background: #CAF4F7; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 600; box-shadow: 0 2px 4px rgba(202, 244, 247, 0.4);"
                                        onmouseover="this.style.background='#9FE8ED'; this.style.boxShadow='0 4px 8px rgba(1, 188, 214, 0.4)';"
                                        onmouseout="this.style.background='#CAF4F7'; this.style.boxShadow='0 2px 4px rgba(202, 244, 247, 0.4)';">
                                  ğŸ”„ é‡æ–°è®¡ç®—
                              </button>
                              </div>
                            </div>
                          ` : ''}
                        </div>
                      </div>`;
                    })();
                  })()}
                </div>
                
                <!-- éšè—å­—æ®µä¿å­˜å…¬å¼ä¿¡æ¯ -->
                <input type="hidden" class="payout-tier-formula" data-tier="${index}" data-field="formula" value="${formattedAmount.formula || ''}" />
                <input type="hidden" class="payout-tier-formula-type" data-tier="${index}" data-field="formulaType" value="${formattedAmount.formulaType || 'compound'}" />
                <input type="hidden" class="payout-tier-interest-rate" data-tier="${index}" data-field="interestRate" value="${formattedAmount.interestRate || 3.5}" />
              </div>
            `;
            } else {
              // å…¬å¼ç±»å‹ä½†æ²¡æœ‰keyAmountsï¼Œæ˜¾ç¤ºè­¦å‘Š
              console.warn(`âš ï¸ [æ¸²æŸ“é˜¶æ®µ${index + 1}] å…¬å¼ç±»å‹ä½†æ— æ³•ç”ŸæˆkeyAmountsï¼Œæ˜¾ç¤ºä¸ºæ™®é€šç±»å‹`);
            }
          } else {
            // æ™®é€šç±»å‹ï¼šæ˜¾ç¤ºå›ºå®šé‡‘é¢è¾“å…¥
            const needsManualInput = !formattedAmount.startAge || !formattedAmount.endAge || !formattedAmount.amount;
            
            content += `
              <div style="margin-bottom: ${index < renderableTiers.length - 1 ? '20px' : '0'}; padding: 18px; background: #f0f8fc; border-radius: 8px; border: 1px solid #b3d9e6; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #b3d9e6;">
                  <div style="font-weight: 600; color: #1a5a7d; font-size: 15px;">
                    ğŸ“ ç¬¬${index + 1}é˜¶æ®µ${formattedAmount.period ? ' (' + formattedAmount.period + ')' : ''}${formattedAmount.percentage ? ' - ' + formattedAmount.percentage + '%' : ''}
                  </div>
                  <button onclick="deleteTier(${index})" 
                          style="display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 4px 8px; font-size: 11px; color: #d73a49; background: transparent; border: none; cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.background='#ffebee'; this.style.color='#c62828';"
                          onmouseout="this.style.background='transparent'; this.style.color='#d73a49';"
                          title="åˆ é™¤æ­¤é˜¶æ®µ">
                    <span style="font-size: 18px;">ğŸ—‘ï¸</span>
                    <span>åˆ é™¤</span>
                  </button>
                </div>
                
                <!-- ä¸‰åˆ—å¸ƒå±€ï¼šèµ·å§‹å¹´é¾„ã€ç»“æŸå¹´é¾„ã€ç†èµ”é‡‘é¢ï¼ˆåŒä¸€è¡Œï¼‰ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: ${needsManualInput ? '10px' : '0'}; align-items: end;">
                  <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœå¼€å§‹å¹´é¾„ï¼ˆå²ï¼‰</label>
                    <input type="number" class="payout-tier-start-age" data-tier="${index}" data-field="startAge" 
                           value="${formattedAmount.startAge || ''}" 
                           placeholder="èµ·å§‹"
                           style="width: 100%; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff; text-align: center;" />
                  </div>
                  <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœç»“æŸå¹´é¾„</label>
                    <input type="text" class="payout-tier-end-age" data-tier="${index}" data-field="endAge" 
                           value="${formattedAmount.endAge === 100 || formattedAmount.endAge === 'lifetime' ? 'ç»ˆèº«' : (formattedAmount.endAge || '')}" 
                           placeholder="ç»“æŸ"
                           style="width: 100%; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff; text-align: center;" 
                           ${formattedAmount.endAge === 100 || formattedAmount.endAge === 'lifetime' ? 'readonly' : ''} />
                  </div>
                  <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ç†èµ”é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
                    <input type="number" step="0.1" class="payout-tier-amount" data-tier="${index}" data-field="amount" 
                           value="${formattedAmount.amount || ''}" 
                           placeholder="è¯·è¾“å…¥"
                           style="width: 100%; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff;" />
                  </div>
                </div>
                
                <!-- åªåœ¨éœ€è¦æ‰‹åŠ¨è¾“å…¥æ—¶æ˜¾ç¤ºå¢å¹…å’Œå•åˆ©/å¤åˆ© -->
                ${needsManualInput ? `
                  <div style="display: flex; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e0e0e0;">
                    <div style="flex: 0 0 auto;">
                      <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å¢å¹…ï¼ˆ%ï¼‰<span style="color: #999; font-weight: normal;">ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰</span></label>
                      <input type="number" step="0.01" class="payout-tier-increase" data-tier="${index}" data-field="increase" 
                             value="${formattedAmount.increase || 0}" 
                             placeholder="0" 
                             style="width: 120px; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff;" />
                    </div>
                    <div style="flex: 0 0 auto;">
                      <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å•åˆ©/å¤åˆ©<span style="color: #999; font-weight: normal;">ï¼ˆå¯é€‰ï¼Œé»˜è®¤å•åˆ©ï¼‰</span></label>
                      <select class="payout-tier-interest-type" data-tier="${index}" data-field="interestType" 
                              style="width: 120px; padding: 8px; border: 2px solid #9FE8ED; border-radius: 4px; font-size: 14px; background: #ffffff;">
                        <option value="simple" ${formattedAmount.interestType === 'simple' ? 'selected' : ''}>å•åˆ©</option>
                        <option value="compound" ${formattedAmount.interestType === 'compound' ? 'selected' : ''}>å¤åˆ©</option>
                      </select>
                    </div>
                  </div>
                ` : ''}
              </div>
              `;
          }
        });
        content += '</div>';
      } else {
        // æœªè¯†åˆ«æˆ–å•é˜¶æ®µï¼Œæ˜¾ç¤ºæç¤ºï¼ˆæµ…çº¢è‰²é€æ˜èƒŒæ™¯ï¼‰
        content = `
          <div style="margin-top: 10px; padding: 10px; background: rgba(255, 182, 193, 0.2); border-radius: 4px;">
            <div style="color: #d32f2f; font-size: 14px; margin-bottom: 10px;">ç”±äºæ¡ä»¶è¿‡äºå¤æ‚æš‚æ—¶æ— æ³•è§£æï¼Œè¯·è‡ªè¡Œå½•å…¥</div>
            
            <!-- ä¸‰åˆ—å¸ƒå±€ï¼šèµ·å§‹å¹´é¾„ã€ç»“æŸå¹´é¾„ã€ç†èµ”é‡‘é¢ï¼ˆåŒä¸€è¡Œï¼‰ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 10px; align-items: end;">
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœå¼€å§‹å¹´é¾„ï¼ˆå²ï¼‰</label>
                <input type="number" class="payout-tier-start-age" data-tier="0" data-field="startAge" 
                       placeholder="èµ·å§‹" 
                       style="width: 100%; padding: 8px; border: 2px solid rgba(255, 99, 99, 0.5); border-radius: 4px; font-size: 14px; background: rgba(255, 182, 193, 0.2); text-align: center;" />
              </div>
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä¿éšœç»“æŸå¹´é¾„ï¼ˆå²ï¼‰</label>
                <input type="number" class="payout-tier-end-age" data-tier="0" data-field="endAge" 
                       placeholder="ç»“æŸ" 
                       style="width: 100%; padding: 8px; border: 2px solid rgba(255, 99, 99, 0.5); border-radius: 4px; font-size: 14px; background: rgba(255, 182, 193, 0.2); text-align: center;" />
              </div>
              <div>
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ç†èµ”é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
                <input type="number" step="0.1" class="payout-tier-amount" data-tier="0" data-field="amount" 
                       placeholder="è¯·è¾“å…¥" 
                       style="width: 100%; padding: 8px; border: 2px solid rgba(255, 99, 99, 0.5); border-radius: 4px; font-size: 14px; background: rgba(255, 182, 193, 0.2);" />
              </div>
            </div>
            
            <!-- å¢å¹…å’Œå•åˆ©/å¤åˆ©ï¼ˆå¯é€‰å­—æ®µï¼‰ -->
            <div style="display: flex; gap: 12px; padding-top: 10px; border-top: 1px dashed rgba(255, 99, 99, 0.3);">
              <div style="flex: 0 0 auto;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å¢å¹…ï¼ˆ%ï¼‰<span style="color: #999; font-weight: normal;">ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰</span></label>
                <input type="number" step="0.01" class="payout-tier-increase" data-tier="0" data-field="increase" 
                       placeholder="0" 
                       style="width: 120px; padding: 8px; border: 2px solid rgba(255, 99, 99, 0.5); border-radius: 4px; font-size: 14px; background: rgba(255, 182, 193, 0.2);" />
              </div>
              <div style="flex: 0 0 auto;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å•åˆ©/å¤åˆ©<span style="color: #999; font-weight: normal;">ï¼ˆå¯é€‰ï¼Œé»˜è®¤å•åˆ©ï¼‰</span></label>
                <select class="payout-tier-interest-type" data-tier="0" data-field="interestType" 
                        style="width: 120px; padding: 8px; border: 2px solid rgba(255, 99, 99, 0.5); border-radius: 4px; font-size: 14px; background: rgba(255, 182, 193, 0.2);">
                  <option value="simple">å•åˆ©</option>
                  <option value="compound">å¤åˆ©</option>
                </select>
              </div>
            </div>
          </div>
        `;
      }
      
      // æ„å»ºè°ƒè¯•ä¿¡æ¯ï¼ˆæ˜¾ç¤ºæ˜¯å¦è°ƒç”¨å¤§æ¨¡å‹å’Œå¤§æ¨¡å‹è¿”å›ç»“æœï¼‰
      let debugInfo = '';
      if (fullResult) {
        const parseMethod = fullResult.parseMethod || 'unknown';
        const isLLM = parseMethod === 'llm' || parseMethod === 'hybrid' || parseMethod === 'zhipu';
        const methodText = isLLM ? 'âœ… å·²è°ƒç”¨å¤§æ¨¡å‹' : 'âš™ï¸ ä½¿ç”¨ç¡¬è§„åˆ™';
        const methodColor = '#CAF4F7'; // ä¸"åˆ†æè´£ä»»"æŒ‰é’®é¢œè‰²ä¸€è‡´
        
        // ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥ naturalLanguageDescription
        console.log('ğŸ” [createPayoutAmountDisplay] fullResult:', fullResult);
        console.log('ğŸ” [createPayoutAmountDisplay] naturalLanguageDescription:', fullResult.naturalLanguageDescription);
        console.log('ğŸ” [createPayoutAmountDisplay] isLLM:', isLLM);
        console.log('ğŸ” [createPayoutAmountDisplay] parseMethod:', parseMethod);
        
        debugInfo = `
          <div style="margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 6px; border-left: 4px solid ${methodColor};">
            <div style="font-size: 13px; font-weight: 600; color: #333; margin-bottom: 8px;">
              ğŸ” è§£ææ–¹å¼: <span style="color: ${methodColor}; font-weight: 700;">${methodText}</span>
            </div>
            ${isLLM && fullResult.naturalLanguageDescription ? `
              <div style="margin-top: 8px;">
                <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px;">ğŸ’­ å¤§æ¨¡å‹çš„è‡ªç„¶è¯­è¨€ç†è§£:</div>
                <div style="margin: 0; padding: 10px; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 12px; color: #333; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${fullResult.naturalLanguageDescription}</div>
              </div>
            ` : isLLM ? `
              <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 12px; color: #856404;">
                âš ï¸ å¤§æ¨¡å‹æœªè¿”å›è‡ªç„¶è¯­è¨€æè¿°
              </div>
            ` : ''}
          </div>
        `;
      }
      
      div.innerHTML = `
        <div class="result-label">
          <span>èµ”ä»˜é‡‘é¢</span>
          ${confidence > 0 ? `<span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>` : ''}
        </div>
        ${debugInfo}
        ${content}
        ${(data?.type === 'tiered' && data?.details?.tiers) ? `
          <div style="margin-top: 16px; padding-top: 16px; border-top: 2px dashed #e0e0e0; text-align: center;">
            <button onclick="addNewTierDialog()" 
                    style="padding: 10px 24px; font-size: 13px; color: #5FC8D4; background: white; border: 2px solid #CAF4F7; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;"
                    onmouseover="this.style.background='#e6f7fa'; this.style.borderColor='#9FE8ED';"
                    onmouseout="this.style.background='white'; this.style.borderColor='#CAF4F7';">
              <span style="font-size: 18px;">â•</span>
              <span>æ–°å¢é˜¶æ®µ</span>
            </button>
          </div>
        ` : ''}
      `;
      
      return div;
    }
    
    // æ ¼å¼åŒ–å•ä¸ªé˜¶æ®µçš„èµ”ä»˜é‡‘é¢æ•°æ®
    /**
     * å¤„ç†å…¬å¼ç±»å‹çš„tierï¼ˆå¤åˆ©/å•åˆ©ï¼‰
     * è¿”å›æ ¼å¼åŒ–çš„é‡‘é¢ï¼ŒåŒ…å«å…¬å¼å’Œå…³é”®èŠ‚ç‚¹ç¤ºä¾‹
     */
    function formatFormulaTier(tier, policyInfo, tierIndex = 0, previousTiers = []) {
      console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ [formatFormulaTier] ========== å¼€å§‹å¤„ç†é˜¶æ®µ${tierIndex + 1} ==========`);
      console.log(`ğŸ”¥ [formatFormulaTier] tier.period: ${tier.period}`);
      console.log(`ğŸ”¥ [formatFormulaTier] tier.startAge: ${tier.startAge}, tier.endAge: ${tier.endAge}`);
      console.log(`ğŸ”¥ [formatFormulaTier] tier.keyAmountsæ•°é‡: ${tier.keyAmounts?.length || 0}`);
      if (tier.keyAmounts && tier.keyAmounts.length > 0) {
        console.log(`ğŸ”¥ [formatFormulaTier] keyAmountsç¬¬ä¸€ä¸ª: age=${tier.keyAmounts[0].age}, year=${tier.keyAmounts[0].year}`);
        console.log(`ğŸ”¥ [formatFormulaTier] keyAmountsæœ€åä¸€ä¸ª: age=${tier.keyAmounts[tier.keyAmounts.length - 1].age}, year=${tier.keyAmounts[tier.keyAmounts.length - 1].year}`);
      }
      
      const { birthYear, policyStartYear, coverageEndYear, basicSumInsured } = policyInfo;
      const startAge = parseInt(policyStartYear) - parseInt(birthYear);
      const endYear = coverageEndYear === 'lifetime' ? null : parseInt(coverageEndYear);
      const endAge = endYear ? endYear - parseInt(birthYear) : 100;
      const basicSumInsuredWan = basicSumInsured / 10000;
      
      // è§£æå…¬å¼
      let formula = tier.formula || tier.value || '';
      let formulaType = tier.formulaType || 'compound'; // compound=å¤åˆ©, simple=å•åˆ©
      let interestRate = tier.interestRate || 3.5; // åˆ©ç‡ï¼ˆå¦‚3.5è¡¨ç¤º3.5%ï¼‰
      
      // å¦‚æœformulaæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•ä»ä¸­æå–ä¿¡æ¯
      if (typeof formula === 'string' && formula.length > 0) {
        // å°è¯•ä»å…¬å¼ä¸­æå–åˆ©ç‡ï¼Œä¾‹å¦‚ï¼š100*(1+3.5%)^n æˆ– 100*(1+3.5%*n)
        const rateMatch = formula.match(/(\d+\.?\d*)%/);
        if (rateMatch) {
          interestRate = parseFloat(rateMatch[1]);
        }
        
        // åˆ¤æ–­æ˜¯å¤åˆ©è¿˜æ˜¯å•åˆ©ï¼šå¤åˆ©æœ‰ ^nï¼Œå•åˆ©æœ‰ *nï¼ˆä½†ä¸æ˜¯ ^nï¼‰
        if (formula.includes('^') || formula.includes('**')) {
          formulaType = 'compound';
        } else if (formula.includes('*n') || formula.includes('* n')) {
          formulaType = 'simple';
        }
        
        // ğŸ¯ åªå¯¹compound/simpleç±»å‹åšå…¬å¼è¡¥å…¨ï¼ŒMaxå…¬å¼ä¿æŒä¸å˜
        if (formulaType === 'compound' || formulaType === 'simple') {
          // å¦‚æœå…¬å¼ä¸­æ²¡æœ‰åŒ…å«åŸºæœ¬ä¿é¢ï¼Œæ·»åŠ åŸºæœ¬ä¿é¢
          if (!formula.includes('100') && !formula.includes('basicSumInsured') && !formula.includes('ä¿é¢')) {
            // å°è¯•æ„å»ºæ ‡å‡†å…¬å¼
            if (formulaType === 'compound') {
              formula = `${basicSumInsuredWan}*(1+${interestRate}%)^n`;
            } else {
              formula = `${basicSumInsuredWan}*(1+${interestRate}%*n)`;
            }
          }
        }
        // Maxç±»å‹ï¼šä¿æŒåŸformulaä¸å˜ï¼ˆåŒ…å«å·²äº¤ä¿è´¹ã€ç°é‡‘ä»·å€¼ç­‰ï¼‰
      } else {
        // å¦‚æœæ²¡æœ‰å…¬å¼å­—ç¬¦ä¸²ï¼Œæ ¹æ®formulaTypeå’ŒinterestRateæ„å»º
        // ğŸ¯ åªä¸ºcompound/simpleæ„å»ºé»˜è®¤å…¬å¼ï¼ŒMaxç±»å‹ä¸éœ€è¦
        if (formulaType === 'compound') {
          formula = `${basicSumInsuredWan}*(1+${interestRate}%)^n`;
        } else if (formulaType === 'simple') {
          formula = `${basicSumInsuredWan}*(1+${interestRate}%*n)`;
        }
        // Maxç±»å‹ï¼šå¦‚æœæ²¡æœ‰formulaï¼Œä¿æŒç©ºå­—ç¬¦ä¸²ï¼ˆåç«¯åº”è¯¥æä¾›ï¼‰
      }
      
      // ğŸ¯ ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„keyAmountsï¼ˆåŒ…å«é€å¹´Maxæ¯”è¾ƒç»“æœï¼‰
      let keyAmounts;
      let tierStartAge;
      let tierEndAge;
      
      if (tier.keyAmounts && tier.keyAmounts.length > 0) {
        // âœ… ä½¿ç”¨åç«¯è®¡ç®—çš„ç»“æœï¼ˆå·²åŒ…å«Maxé€å¹´æ¯”è¾ƒã€æœŸäº¤ä¿è´¹ç­‰å¤æ‚é€»è¾‘ï¼‰
        console.log(`âœ… [formatFormulaTier] ä½¿ç”¨åç«¯è¿”å›çš„keyAmountsï¼Œå…±${tier.keyAmounts.length}ä¸ªèŠ‚ç‚¹`);
        keyAmounts = tier.keyAmounts;
        
        // ğŸ¯ ä»keyAmountsä¸­æå–å®é™…çš„å¹´é¾„èŒƒå›´ï¼ˆè¿™æ˜¯æœ€å‡†ç¡®çš„ï¼ï¼‰
        tierStartAge = keyAmounts[0].age;
        tierEndAge = keyAmounts[keyAmounts.length - 1].age;
          console.log(`ğŸ¯ [formatFormulaTier] ä»keyAmountsæå–å¹´é¾„èŒƒå›´: ${tierStartAge}å²-${tierEndAge}å²`);
      } else {
        // âŒ åç«¯æœªè¿”å›keyAmountsï¼Œå‰ç«¯ä¸åšè®¡ç®—ï¼Œè¿”å›é”™è¯¯æç¤º
        console.error(`âŒ [formatFormulaTier] åç«¯æœªè¿”å›keyAmountsï¼Œæ— æ³•æ˜¾ç¤ºï¼é˜¶æ®µ${tierIndex + 1}`);
        console.error(`   å…¬å¼ç±»å‹çš„æ•°æ®å¿…é¡»ç”±åç«¯è®¡ç®—ï¼Œå‰ç«¯ä¸åšä»»ä½•è®¡ç®—`);
        
        // ä½¿ç”¨tierçš„å¹´é¾„èŒƒå›´ï¼ˆå¦‚æœæœ‰ï¼‰
        tierStartAge = tier.startAge !== undefined ? tier.startAge : startAge;
        tierEndAge = tier.endAge !== undefined ? tier.endAge : endAge;
        
        // ä¸åšè®¡ç®—ï¼Œè¿”å›ç©ºæ•°ç»„å¹¶æ ‡è®°é”™è¯¯
        keyAmounts = [];
        
        // åœ¨consoleæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        console.warn(`âš ï¸ è¯¥é˜¶æ®µæ— æ³•æ˜¾ç¤ºï¼Œè¯·æ£€æŸ¥ï¼š`);
        console.warn(`   1. åç«¯APIæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Ÿ`);
        console.warn(`   2. åç«¯æ˜¯å¦è¿”å›äº†keyAmountså­—æ®µï¼Ÿ`);
        console.warn(`   3. tieræ•°æ®:`, tier);
      }
      
      console.log(`ğŸ”¥ [formatFormulaTier] è¿”å›å‰æœ€ç»ˆæ£€æŸ¥: tierStartAge=${tierStartAge}, tierEndAge=${tierEndAge}, keyAmountsé•¿åº¦=${keyAmounts?.length || 0}`);
      if (keyAmounts && keyAmounts.length > 0) {
        console.log(`ğŸ”¥ [formatFormulaTier] keyAmountsç¬¬ä¸€ä¸ª: å¹´é¾„${keyAmounts[0].age}å²ï¼Œæœ€åä¸€ä¸ª: å¹´é¾„${keyAmounts[keyAmounts.length - 1].age}å²`);
      }
      
      const result = {
        startAge: tierStartAge,
        endAge: tierEndAge,
        amount: null, // å…¬å¼ç±»å‹ä¸æ˜¾ç¤ºå›ºå®šé‡‘é¢
        formula: formula,
        formulaType: formulaType,
        interestRate: interestRate,
        keyAmounts: keyAmounts, // å…³é”®èŠ‚ç‚¹çš„é‡‘é¢ç¤ºä¾‹
        isFormula: true,
        period: tier.period
      };
      
      console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ [formatFormulaTier] ========== é˜¶æ®µ${tierIndex + 1}è¿”å›ç»“æœ ==========`);
      console.log(`ğŸ”¥ [formatFormulaTier] è¿”å›: startAge=${result.startAge}, endAge=${result.endAge}, period=${result.period}`);
      
      return result;
    }

    function formatPayoutAmountForTier(tier, policyInfo, tierIndex = 0, previousTiers = []) {
      const { birthYear, policyStartYear, coverageEndYear, basicSumInsured } = policyInfo;
      const startAge = parseInt(policyStartYear) - parseInt(birthYear);
      const endYear = coverageEndYear === 'lifetime' ? null : parseInt(coverageEndYear);
      const endAge = endYear ? endYear - parseInt(birthYear) : 100;
      const basicSumInsuredWan = basicSumInsured / 10000;
      
      // âœ… ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„è®¡ç®—ç»“æœ
      // å‰ç«¯ä¸åšé‡‘é¢è®¡ç®—ï¼Œåªè´Ÿè´£å±•ç¤º
      let amount = '';
      
      if (tier.amount !== undefined && tier.amount !== null) {
        // åç«¯å·²è®¡ç®—å¥½é‡‘é¢
        amount = parseFloat(tier.amount).toFixed(1);
      } else if (typeof tier.value === 'number') {
        // å¦‚æœåªæœ‰ç™¾åˆ†æ¯”ï¼Œä¹Ÿéœ€è¦åç«¯è®¡ç®—ï¼Œå‰ç«¯ä»…åšç®€å•æ˜¾ç¤º
        const percentage = tier.value;
        amount = (basicSumInsuredWan * percentage / 100).toFixed(1);
        console.warn(`âš ï¸ [formatPayoutAmountForTier] å‰ç«¯ä¸´æ—¶è®¡ç®—ï¼ˆåº”ç”±åç«¯æä¾›ï¼‰: ${percentage}% = ${amount}ä¸‡`);
      } else if (tier.value === 'paidPremium' || tier.unit === 'paidPremium') {
        // å·²äº¤ä¿è´¹ç±»å‹ï¼Œåº”è¯¥ç”±åç«¯è®¡ç®—
        console.warn(`âš ï¸ [formatPayoutAmountForTier] å·²äº¤ä¿è´¹ç±»å‹ï¼Œåº”ç”±åç«¯è®¡ç®—`);
        amount = '';
      } else {
        console.error(`âŒ [formatPayoutAmountForTier] æ— æ³•è·å–é‡‘é¢ï¼Œtier:`, tier);
      }
      
      // âœ… ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„å¹´é¾„èŒƒå›´
      let tierStartAge, tierEndAge;
      
      if (tier.startAge !== undefined && tier.endAge !== undefined) {
        // åç«¯å·²è®¡ç®—å¥½å¹´é¾„èŒƒå›´ï¼Œç›´æ¥ä½¿ç”¨
        tierStartAge = tier.startAge;
        tierEndAge = tier.endAge;
        console.log(`âœ… [formatPayoutAmountForTier] ä½¿ç”¨åç«¯è¿”å›çš„å¹´é¾„èŒƒå›´: ${tierStartAge}å²ï½${tierEndAge}å²`);
      } else {
        // âŒ åç«¯æœªè¿”å›å¹´é¾„èŒƒå›´ï¼Œå‰ç«¯ä¸åšå¤æ‚è®¡ç®—
        // ä»…ä½¿ç”¨åŸºæœ¬çš„é»˜è®¤å€¼
        tierStartAge = startAge;
        tierEndAge = endAge;
        console.warn(`âš ï¸ [formatPayoutAmountForTier] åç«¯æœªè¿”å›startAge/endAgeï¼Œä½¿ç”¨é»˜è®¤å€¼: ${tierStartAge}å²ï½${tierEndAge}å²`);
        console.warn(`   æœŸé—´æè¿°: ${tier.period || 'æ— '}`);
        console.warn(`   å»ºè®®ï¼šè®©åç«¯æ ¹æ®periodå­—æ®µè®¡ç®—å‡†ç¡®çš„å¹´é¾„èŒƒå›´`);
      }
      
      console.log(`âœ… [formatPayoutAmountForTier] æœ€ç»ˆç»“æœ: ${tierStartAge}å²ï½${tierEndAge}å², é‡‘é¢: ${amount}ä¸‡`);
      
      // âœ… ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„keyAmountsï¼ˆå¯èƒ½åŒ…å«Maxæ¯”è¾ƒç»“æœï¼‰
      const result = {
        amount: parseFloat(amount),
        startAge: tierStartAge,
        endAge: tierEndAge,
        increase: 0, // é»˜è®¤æ— å¢å¹…
        interestType: 'simple' // é»˜è®¤å•åˆ©
      };
      
      // å¦‚æœåç«¯è¿”å›äº†keyAmountsï¼ˆä¾‹å¦‚Maxæ¯”è¾ƒçš„é€å¹´ç»“æœï¼‰ï¼Œæ·»åŠ åˆ°è¿”å›å¯¹è±¡
      if (tier.keyAmounts && tier.keyAmounts.length > 0) {
        console.log(`âœ… [formatPayoutAmountForTier] åç«¯è¿”å›äº†keyAmountsï¼Œå…±${tier.keyAmounts.length}ä¸ªèŠ‚ç‚¹`);
        result.keyAmounts = tier.keyAmounts;
      }
      
      return result;
    }
    
    // 2. èµ”ä»˜æ¬¡æ•°ï¼ˆè¾“å…¥æ¡†ï¼‰
    function createPayoutCountDisplay(data) {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.id = 'payoutCountItem';
      
      const confidence = data?.confidence || 0;
      const confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
      const confidenceText = confidence >= 0.8 ? 'é«˜' : confidence >= 0.5 ? 'ä¸­' : 'ä½';
      
      // é»˜è®¤å€¼ï¼š1æ¬¡
      let value = '1';
      if (data && data.type === 'single') {
        value = '1';
      } else if (data && data.type === 'multiple' && data.maxCount) {
        value = data.maxCount.toString();
      }
      
      // åŸæ–‡ç‰‡æ®µ
      const extractedTextHtml = createExtractedTextHtml(data?.extractedText);
      
      div.innerHTML = `
        <div class="result-label">
          <span>èµ”ä»˜æ¬¡æ•°</span>
          ${confidence > 0 ? `<span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>` : ''}
        </div>
        <div style="margin-top: 12px; position: relative; display: inline-block;">
          <input type="number" min="1" id="payoutCountInput" value="${value}" 
                 style="width: 150px; padding: 10px 35px 10px 12px; border: 2px solid #9FE8ED; border-radius: 6px; font-size: 14px; background: #ffffff;" />
          <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px; pointer-events: none; user-select: none;">æ¬¡</span>
        </div>
        ${extractedTextHtml}
      `;
      
      return div;
    }
    
    // 3. æ˜¯å¦åˆ†ç»„ï¼ˆå•é€‰ï¼‰
    function createGroupingDisplay(data, payoutCountData) {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.id = 'groupingItem';
      
      // åˆ¤æ–­æ˜¯å¦ä»…ä¸€æ¬¡èµ”ä»˜
      const isSinglePayout = payoutCountData && payoutCountData.type === 'single';
      
      // åˆ¤æ–­æ˜¯å¦å¤šæ¬¡èµ”ä»˜ä½†æœªè¯†åˆ«åˆ°
      const isMultiplePayoutUnrecognized = payoutCountData && 
                                           payoutCountData.type === 'multiple' && 
                                           payoutCountData.maxCount >= 2 &&
                                           (!data || data.confidence === 0);
      
      let confidence, confidenceClass, confidenceText, defaultValue, displayContent;
      
      if (isSinglePayout) {
        // å¦‚æœèµ”ä»˜æ¬¡æ•°æ˜¯1æ¬¡ï¼šæ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹ï¼Œä½†é»˜è®¤é€‰ä¸­"ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠ"ï¼Œç½®ä¿¡åº¦ï¼šé«˜
        confidence = 0.8;
        confidenceClass = 'confidence-high';
        confidenceText = 'é«˜';
        defaultValue = 'not_applicable';
        displayContent = `
          <div style="display: flex; gap: 16px; align-items: center;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="groupingRadio" value="grouped" 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>åˆ†ç»„</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="groupingRadio" value="not_grouped" 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>ä¸åˆ†ç»„</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="groupingRadio" value="not_applicable" checked 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠ</span>
            </label>
          </div>
        `;
      } else if (isMultiplePayoutUnrecognized) {
        // å¦‚æœèµ”ä»˜æ¬¡æ•°è¶…è¿‡2æ¬¡ä½†æœªè¯†åˆ«åˆ°ï¼šé»˜è®¤æ˜¾ç¤º"ä¸åˆ†ç»„"ï¼Œç½®ä¿¡åº¦ï¼š0
        confidence = 0;
        confidenceClass = 'confidence-low';
        confidenceText = 'ä½';
        defaultValue = 'not_grouped';
        displayContent = `
          <div style="display: flex; gap: 16px; align-items: center;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="groupingRadio" value="grouped" 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>åˆ†ç»„</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="groupingRadio" value="not_grouped" checked 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>ä¸åˆ†ç»„</span>
            </label>
          </div>
        `;
      } else {
        // æ­£å¸¸æƒ…å†µ
        confidence = data?.confidence || 0;
        confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
        confidenceText = confidence >= 0.8 ? 'é«˜' : confidence >= 0.5 ? 'ä¸­' : 'ä½';
        defaultValue = 'not_grouped';
        if (data && data.isGrouped !== undefined) {
          defaultValue = data.isGrouped ? 'grouped' : 'not_grouped';
        }
        displayContent = `
          <div style="display: flex; gap: 16px; align-items: center;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="groupingRadio" value="grouped" ${defaultValue === 'grouped' ? 'checked' : ''} 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>åˆ†ç»„</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="groupingRadio" value="not_grouped" ${defaultValue === 'not_grouped' ? 'checked' : ''} 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>ä¸åˆ†ç»„</span>
            </label>
          </div>
        `;
      }
      
      // åŸæ–‡ç‰‡æ®µ
      const extractedTextHtml = createExtractedTextHtml(data?.extractedText);
      
      div.innerHTML = `
        <div class="result-label">
          <span>æ˜¯å¦åˆ†ç»„</span>
          <span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>
        </div>
        <div style="margin-top: 12px;">
          ${displayContent}
        </div>
        ${extractedTextHtml}
      `;
      
      return div;
    }
    
    // 4. æ˜¯å¦å¯ä»¥é‡å¤èµ”ä»˜ï¼ˆå•é€‰ï¼‰
    function createRepeatablePayoutDisplay(data, payoutCountData) {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.id = 'repeatablePayoutItem';
      
      // åˆ¤æ–­æ˜¯å¦ä»…ä¸€æ¬¡èµ”ä»˜
      const isSinglePayout = payoutCountData && payoutCountData.type === 'single';
      
      // åˆ¤æ–­æ˜¯å¦å¤šæ¬¡èµ”ä»˜ä½†æœªè¯†åˆ«åˆ°
      const isMultiplePayoutUnrecognized = payoutCountData && 
                                           payoutCountData.type === 'multiple' && 
                                           payoutCountData.maxCount >= 2 &&
                                           (!data || data.confidence === 0);
      
      let confidence, confidenceClass, confidenceText, defaultValue, displayContent;
      
      if (isSinglePayout) {
        // å¦‚æœèµ”ä»˜æ¬¡æ•°æ˜¯1æ¬¡ï¼šæ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹ï¼Œä½†é»˜è®¤é€‰ä¸­"ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠ"ï¼Œç½®ä¿¡åº¦ï¼šé«˜
        confidence = 0.8;
        confidenceClass = 'confidence-high';
        confidenceText = 'é«˜';
        defaultValue = 'not_applicable';
        displayContent = `
          <div style="display: flex; gap: 16px; align-items: center;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="repeatablePayoutRadio" value="repeatable" 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>å¯ä»¥</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="repeatablePayoutRadio" value="not_repeatable" 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>ä¸å¯ä»¥</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="repeatablePayoutRadio" value="not_applicable" checked 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠ</span>
            </label>
          </div>
        `;
      } else if (isMultiplePayoutUnrecognized) {
        // å¦‚æœèµ”ä»˜æ¬¡æ•°è¶…è¿‡2æ¬¡ä½†æœªè¯†åˆ«åˆ°ï¼šé»˜è®¤æ˜¾ç¤º"å¯ä»¥é‡å¤"ï¼Œç½®ä¿¡åº¦ï¼š0
        confidence = 0;
        confidenceClass = 'confidence-low';
        confidenceText = 'ä½';
        defaultValue = 'repeatable';
        displayContent = `
          <div style="display: flex; gap: 16px; align-items: center;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="repeatablePayoutRadio" value="repeatable" checked 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>å¯ä»¥</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="repeatablePayoutRadio" value="not_repeatable" 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>ä¸å¯ä»¥</span>
            </label>
          </div>
        `;
      } else {
        // æ­£å¸¸æƒ…å†µ
        confidence = data?.confidence || 0;
        confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
        confidenceText = confidence >= 0.8 ? 'é«˜' : confidence >= 0.5 ? 'ä¸­' : 'ä½';
        defaultValue = 'repeatable';
        if (data && data.isRepeatable !== undefined) {
          defaultValue = data.isRepeatable ? 'repeatable' : 'not_repeatable';
        }
        displayContent = `
          <div style="display: flex; gap: 16px; align-items: center;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="repeatablePayoutRadio" value="repeatable" ${defaultValue === 'repeatable' ? 'checked' : ''} 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>å¯ä»¥</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="repeatablePayoutRadio" value="not_repeatable" ${defaultValue === 'not_repeatable' ? 'checked' : ''} 
                     style="margin-right: 6px; accent-color: #5FC8D4;" />
              <span>ä¸å¯ä»¥</span>
            </label>
          </div>
        `;
      }
      
      // åŸæ–‡ç‰‡æ®µ
      const extractedTextHtml = createExtractedTextHtml(data?.extractedText);
      
      div.innerHTML = `
        <div class="result-label">
          <span>æ˜¯å¦å¯ä»¥é‡å¤èµ”ä»˜</span>
          <span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>
        </div>
        <div style="margin-top: 12px;">
          ${displayContent}
        </div>
        ${extractedTextHtml}
      `;
      
      return div;
    }
    
    // 5. é—´éš”æœŸï¼ˆè¾“å…¥æ¡†ï¼‰
    function createIntervalPeriodDisplay(data, payoutCountData) {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.id = 'intervalPeriodItem';
      
      // åˆ¤æ–­æ˜¯å¦ä¸€æ¬¡èµ”ä»˜
      const isSinglePayout = payoutCountData && payoutCountData.type === 'single';
      
      // é»˜è®¤å€¼ï¼š0å¤©
      let value = '0';
      if (data && data.hasInterval === false) {
        value = '0';
      } else if (data && data.hasInterval && data.days) {
        value = data.days.toString();
      }
      
      // å¦‚æœèµ”ä»˜æ¬¡æ•°æ˜¯1æ¬¡ï¼Œé—´éš”æœŸåº”è¯¥æ˜¯0ï¼Œç½®ä¿¡åº¦ï¼šé«˜
      let confidence = data?.confidence || 0;
      if (isSinglePayout) {
        value = '0';
        confidence = 0.8; // ä¸€æ¬¡èµ”ä»˜ä¸æ¶‰åŠé—´éš”æœŸï¼Œç½®ä¿¡åº¦é«˜
      }
      
      const confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
      const confidenceText = confidence >= 0.8 ? 'é«˜' : confidence >= 0.5 ? 'ä¸­' : 'ä½';
      
      // åŸæ–‡ç‰‡æ®µ
      const extractedTextHtml = createExtractedTextHtml(data?.extractedText);
      
      div.innerHTML = `
        <div class="result-label">
          <span>é—´éš”æœŸ</span>
          ${confidence > 0 ? `<span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>` : ''}
        </div>
        <div style="margin-top: 12px; display: flex; align-items: center; gap: 20px;">
          <div style="position: relative; display: inline-block; flex: 0 0 auto;">
            <input type="number" min="0" id="intervalPeriodInput" value="${value}" 
                   style="width: 150px; padding: 10px 35px 10px 12px; border: 2px solid #9FE8ED; border-radius: 6px; font-size: 14px; background: #ffffff;" />
            <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px; pointer-events: none; user-select: none;">å¤©</span>
          </div>
          <div style="flex: 1;"></div>
          <div style="flex-shrink: 0; font-size: 12px; color: #999; font-style: italic; white-space: nowrap;">
            ğŸ’¡ æ³¨ï¼šè¾“å…¥0è¡¨ç¤ºæ— é—´éš”æœŸ
          </div>
        </div>
        ${extractedTextHtml}
      `;
      
      return div;
    }
    
    // 7. ç–¾ç—…å‘ç”Ÿæ˜¯å¦è±å…ä¿è´¹ï¼ˆå•é€‰ï¼‰
    function createPremiumWaiverDisplay(data) {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.id = 'premiumWaiverItem';
      
      const confidence = data?.confidence || 0;
      const confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
      const confidenceText = confidence >= 0.8 ? 'é«˜' : confidence >= 0.5 ? 'ä¸­' : 'ä½';
      
      // é»˜è®¤å€¼ï¼šå¦‚æœæœªè¯†åˆ«ï¼ˆconfidenceä¸º0æˆ–dataä¸å­˜åœ¨ï¼‰ï¼Œå¼ºåˆ¶é»˜è®¤ä¸º"ä¸è±å…"
      let defaultValue = 'not_waived';
      // åªæœ‰å½“ç½®ä¿¡åº¦å¤§äº0ä¸”dataå­˜åœ¨ä¸”æœ‰æ˜ç¡®çš„isWaivedå€¼æ—¶ï¼Œæ‰ä½¿ç”¨è§£æç»“æœ
      if (confidence > 0 && data && data.isWaived !== undefined) {
        defaultValue = data.isWaived ? 'waived' : 'not_waived';
      }
      
      // åŸæ–‡ç‰‡æ®µ
      const extractedTextHtml = createExtractedTextHtml(data?.extractedText);
      
      div.innerHTML = `
        <div class="result-label">
          <span>ç–¾ç—…å‘ç”Ÿæ˜¯å¦è±å…ä¿è´¹</span>
          <span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 16px; align-items: center;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="premiumWaiverRadio" value="waived" ${defaultValue === 'waived' ? 'checked' : ''} 
                   style="margin-right: 6px; accent-color: #5FC8D4;" />
            <span>è±å…</span>
          </label>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="premiumWaiverRadio" value="not_waived" ${defaultValue === 'not_waived' ? 'checked' : ''} 
                   style="margin-right: 6px; accent-color: #5FC8D4;" />
            <span>ä¸è±å…</span>
          </label>
        </div>
        ${extractedTextHtml}
      `;
      
      return div;
    }
    
    // 8. å…¶ä»–æ¡ä»¶ï¼ˆåªè¯»æ˜¾ç¤ºï¼‰
    function createConditionsDisplay(conditions, confidence, extractedText) {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.id = 'conditionsItem';
      
      const confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
      const confidenceText = confidence >= 0.8 ? 'é«˜' : confidence >= 0.5 ? 'ä¸­' : 'ä½';
      
      const formattedConditions = formatConditions(conditions);
      
      div.innerHTML = `
        <div class="result-label">
          <span>å…¶ä»–æ¡ä»¶</span>
          ${confidence > 0 ? `<span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>` : ''}
        </div>
        <div class="result-value" style="padding: 12px; background: #ffffff; border-radius: 6px; min-height: 40px; border: 2px solid #9FE8ED;">${formattedConditions}</div>
      `;
      
      return div;
    }
    
    // åˆ›å»ºç»“æœé¡¹ï¼ˆä¿ç•™ç”¨äºå…¼å®¹ï¼‰
    function createResultItem(label, value, confidence, extractedText) {
      const div = document.createElement('div');
      div.className = 'result-item';
      
      const confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
      const confidenceText = confidence >= 0.8 ? 'é«˜' : confidence >= 0.5 ? 'ä¸­' : 'ä½';
      
      div.innerHTML = `
        <div class="result-label">
          <span>${label}</span>
          <span class="confidence-badge ${confidenceClass}">ç½®ä¿¡åº¦: ${confidenceText} (${(confidence * 100).toFixed(0)}%)</span>
        </div>
        <div class="result-value" style="padding: 12px; background: #f9f9f9; border-radius: 6px; min-height: 40px;">${value}</div>
      `;
      
      return div;
    }

    // è·å–ä¿å•åŸºæœ¬ä¿¡æ¯
    function getPolicyInfo() {
      const birthYear = document.getElementById('birthYear')?.value;
      const policyStartYear = document.getElementById('policyStartYear')?.value;
      const coverageEndYear = document.getElementById('coverageEndYear')?.value;
      const basicSumInsured = document.getElementById('basicSumInsured')?.value;
      
      if (birthYear && policyStartYear && basicSumInsured) {
        return {
          birthYear: parseInt(birthYear),
          policyStartYear: parseInt(policyStartYear),
          coverageEndYear: coverageEndYear === 'lifetime' ? 'lifetime' : parseInt(coverageEndYear),
          basicSumInsured: parseFloat(basicSumInsured) * 10000 // è½¬æ¢ä¸ºå…ƒ
        };
      }
      return null;
    }

    // å…¼å®¹å‡½æ•°ï¼šæ ¼å¼åŒ–å‡½æ•°ï¼ˆå·²ç§»è‡³DataFormatterServiceï¼‰
    function formatPayoutAmount(data, policyInfo = null) {
      return DataFormatterService.formatPayoutAmount(data, policyInfo);
    }
    
    function formatPayoutCount(data) {
      return DataFormatterService.formatPayoutCount(data);
    }
    
    function formatGrouping(data) {
      return DataFormatterService.formatGrouping(data);
    }

    function formatIntervalPeriod(data) {
      return DataFormatterService.formatIntervalPeriod(data);
    }
    
    function formatWaitingPeriod(data) {
      return DataFormatterService.formatWaitingPeriod(data);
    }

    function formatConditions(conditions) {
      return DataFormatterService.formatConditions(conditions);
    }
    
    // æ³¨æ„ï¼šæ—§çš„æ ¼å¼åŒ–å‡½æ•°å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨DataFormatterService

    // æ›´æ–°ç»“æœï¼ˆç¼–è¾‘åŠŸèƒ½ï¼‰
    function updateResult(label, value) {
      if (parseResult) {
        console.log(`æ›´æ–° ${label}: ${value}`);
        // è¿™é‡Œå¯ä»¥ä¿å­˜ç¼–è¾‘åçš„å€¼åˆ° parseResult
      }
    }

    // å¤åˆ¶ç»“æœ
    function copyResult() {
      if (!parseResult) {
        showMessage('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„è§£æç»“æœ', 'error');
        return;
      }
      
      const text = JSON.stringify(parseResult, null, 2);
      navigator.clipboard.writeText(text).then(() => {
        showMessage('âœ… ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showMessage('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
      });
    }

    // æ¸…ç©ºè¾“å…¥
    function clearInput() {
      // æ¸…ç©ºåŸºæœ¬ä¿¡æ¯
      document.getElementById('insuranceCompany').value = '';
      document.getElementById('insuranceCompany').removeAttribute('data-company-id');
      document.getElementById('productName').value = '';
      document.getElementById('insuredPerson').value = '';
      document.getElementById('birthYear').value = '';
      document.getElementById('policyStartYear').value = '';
      document.getElementById('coverageEndYear').value = '';
      document.getElementById('totalPaymentPeriod').value = '';
      document.getElementById('annualPremium').value = '';
      document.getElementById('basicSumInsured').value = '';
      
      // æ¸…ç©ºä¿å•ç±»å‹é€‰æ‹©ï¼ˆé‡ç½®ä¸ºé»˜è®¤å€¼"é‡ç–¾é™©"ï¼‰
      const policyTypeSelect = document.getElementById('policyType');
      if (policyTypeSelect) {
        policyTypeSelect.value = 'critical_illness';
        currentPolicyType = 'critical_illness';
      }
      
      // æ¸…ç©ºè´£ä»»ç±»å‹é€‰æ‹©
      const coverageTypeRadios = document.querySelectorAll('input[name="coverageType"]');
      coverageTypeRadios.forEach(radio => radio.checked = false);
      currentCoverageType = null;
      updateCoverageType();
      
      // æ¸…ç©ºæ¡æ¬¾æ–‡æœ¬
      const clauseInput = document.getElementById('pageClauseInput');
      if (clauseInput) {
        clauseInput.value = '';
      }
      const resultContainer = document.getElementById('resultContainer');
      if (resultContainer) {
        resultContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è§£æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...<br><br><small>ç‚¹å‡»å·¦ä¾§"è§£ææ¡æ¬¾"æŒ‰é’®å¼€å§‹</small></p>';
      }
      const actionsSection = document.getElementById('actionsSection');
      if (actionsSection) {
        actionsSection.style.display = 'none';
      }
      parseResult = null;
      showMessage('', 'success');
    }

    // æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒHTMLå†…å®¹å’Œæ›´å¥½çš„æ ·å¼ï¼‰
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      if (!text) {
        messageDiv.style.display = 'none';
        return;
      }
      messageDiv.className = `message ${type}-message`;
      // æ”¯æŒHTMLå†…å®¹ï¼ˆç”¨äºæ˜¾ç¤ºé“¾æ¥ç­‰ï¼‰
      if (typeof text === 'string' && text.includes('<')) {
        messageDiv.innerHTML = text;
      } else {
        messageDiv.textContent = text;
      }
      messageDiv.style.display = 'block';
      messageDiv.style.padding = '12px 16px';
      messageDiv.style.borderRadius = '8px';
      messageDiv.style.marginBottom = '16px';
      
      if (type === 'success') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 3000);
      }
    }

    // ğŸ” APIå¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨ç«¯å£æ£€æµ‹
    async function checkBackendHealth() {
      const ports = [3001, 4000]; // å°è¯•çš„ç«¯å£åˆ—è¡¨
      
      for (const port of ports) {
        try {
          const response = await fetch(`http://localhost:${port}/health`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (response.ok) {
            const data = await response.json();
            console.log(`âœ… åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸ (ç«¯å£ ${port}):`, data);
            return { available: true, port, data };
          }
        } catch (error) {
          console.warn(`âš ï¸ ç«¯å£ ${port} ä¸å¯ç”¨:`, error.message);
        }
      }
      
      return { available: false, port: null };
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åç«¯çŠ¶æ€
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ” æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€...');
      const health = await checkBackendHealth();
      
      if (health.available) {
        console.log(`âœ… åç«¯æœåŠ¡å·²è¿æ¥ (ç«¯å£ ${health.port})`);
        showMessage(`âœ… åç«¯æœåŠ¡å·²è¿æ¥ (ç«¯å£ ${health.port})`, 'success');
      } else {
        console.warn('âš ï¸ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡');
        showMessage('âš ï¸ åç«¯æœåŠ¡æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨åç«¯æœåŠ¡ (ç«¯å£ 3001)', 'error');
      }
    });

    // ========== äº‹ä»¶å§”æ‰˜ï¼šå±•å¼€/æ”¶èµ·æ‰€æœ‰å¹´ä»½ ==========
    document.addEventListener('click', function(e) {
      // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨closestæŸ¥æ‰¾æŒ‰é’®ï¼Œæ”¯æŒç‚¹å‡»æŒ‰é’®å†…éƒ¨å…ƒç´ ï¼ˆå¦‚spanï¼‰
      const button = e.target.closest('.toggle-all-years');
      if (button) {
        const tierIndex = button.getAttribute('data-tier');
        const container = document.querySelector(`.year-amounts-container[data-tier="${tierIndex}"]`);
        
        if (!container) {
          console.error('æ‰¾ä¸åˆ°containerï¼ŒtierIndex:', tierIndex);
          return;
        }
        
        const hiddenDiv = container.querySelector('.year-amounts-hidden');
        const toggleText = button.querySelector('.toggle-text');
        
        if (!hiddenDiv || !toggleText) {
          console.error('æ‰¾ä¸åˆ°hiddenDivæˆ–toggleText');
          return;
        }
        
        if (hiddenDiv.style.display === 'none' || hiddenDiv.style.display === '') {
          // å±•å¼€
          hiddenDiv.style.display = 'block';
          toggleText.textContent = 'â–² æ”¶èµ·';
        } else {
          // æ”¶èµ·
          hiddenDiv.style.display = 'none';
          // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—æ€»å¹´æ•°
          const allRows = container.querySelectorAll('tbody tr');
          const totalYears = allRows.length;
          toggleText.textContent = `â–¼ æŸ¥çœ‹å…¨éƒ¨${totalYears}å¹´`;
        }
      }
    });
  </script>
</body>
</html>


